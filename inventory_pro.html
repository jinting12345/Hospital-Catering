<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿé¤Šå“åº«å­˜ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .back-btn { text-decoration: none; color: #666; font-weight: bold; }
        h2 { margin: 0; color: #2c3e50; }
        .role-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white; }

        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { padding: 10px 20px; border: none; background: #e0e0e0; cursor: pointer; border-radius: 5px 5px 0 0; font-weight: bold; color: #555; }
        .tab-btn.active { background: #1a73e8; color: white; }

        .tab-content { display: none; background: white; padding: 20px; border-radius: 0 5px 5px 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-content.active { display: block; }

        .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .search-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
        .action-btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; }
        
        /* æŒ‰éˆ•é¡è‰² */
        .btn-in { background: #28a745; } 
        .btn-out { background: #dc3545; } 
        .btn-import { background: #17a2b8; } 
        .btn-export { background: #6f42c1; } /* åŒ¯å‡ºç´«è‰² */
        .btn-stocktake { background: #e67e22; } /* ç›¤é»æ©˜è‰² */
        
        /* æ¬Šé™æ§åˆ¶ï¼šé è¨­éš±è—ç®¡ç†å“¡æŒ‰éˆ•ï¼Œç­‰ JS åˆ¤æ–·å¾Œå†é¡¯ç¤º */
        .admin-only { display: none; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #444; font-weight: bold; white-space: nowrap; }
        tr:hover { background-color: #f1f5f9; }

        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; color: white; font-weight: bold; }
        .bg-ok { background: #28a745; }
        .bg-warn { background: #ffc107; color: #333; }
        .bg-danger { background: #dc3545; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
        <h2>ğŸ“¦ ç‡Ÿé¤Šå“åº«å­˜ <span id="roleLabel"></span></h2>
        <div style="font-size:14px; color:#666;" id="userInfo">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('stock')">ğŸ“Š å³æ™‚åº«å­˜</button>
        <button class="tab-btn" onclick="switchTab('logs')">ğŸ“ é€²å‡ºç´€éŒ„</button>
    </div>

    <div id="stock" class="tab-content active">
        <div class="controls">
            <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å“å..." onkeyup="filterTable()">
            
            <input type="file" id="excel_input" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelImport(this)">

            <button class="action-btn btn-import admin-only" onclick="document.getElementById('excel_input').click()">ğŸ“‚ åŒ¯å…¥è¦†è“‹åº«å­˜</button>
            <button class="action-btn btn-in admin-only" style="background:#007bff;" onclick="openAddModal()">â• æ–°å¢å“é …</button>
            
            <button class="action-btn btn-stocktake" onclick="downloadForStockTake()">ğŸ“‹ ä¸‹è¼‰ç›¤é»å–®</button>
            <button class="action-btn btn-export" onclick="exportStock()">ğŸ“¥ ä¸‹è¼‰å ±è¡¨</button>
        </div>
        
        <div style="overflow-x:auto;">
            <table id="stockTable">
                <thead>
                    <tr>
                        <th>å“å</th>
                        <th>åˆ†é¡</th>
                        <th>åº«å­˜</th>
                        <th>å–®ä½</th>
                        <th>æœ‰æ•ˆæ—¥æœŸ</th>
                        <th>ç‹€æ…‹</th>
                        <th style="width:180px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="stockBody"></tbody>
            </table>
        </div>
    </div>

    <div id="logs" class="tab-content">
        <div class="controls" style="justify-content: space-between;">
            <h3>æœ€è¿‘ 50 ç­†ç•°å‹•</h3>
            <button class="action-btn btn-export" onclick="exportLogs()">ğŸ“¥ ä¸‹è¼‰å®Œæ•´ç´€éŒ„è¡¨</button>
        </div>
        <table id="logTable">
            <thead>
                <tr>
                    <th>æ™‚é–“</th>
                    <th>å‹•ä½œ</th>
                    <th>å“å</th>
                    <th>æ•¸é‡</th>
                    <th>çµé¤˜</th>
                    <th>æ“ä½œäºº</th>
                    <th>å‚™è¨»</th>
                </tr>
            </thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>
</div>

<div id="actionModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">åŸ·è¡Œå‹•ä½œ</h3>
        <div class="form-group">
            <label>å“å</label>
            <input type="text" id="actName" disabled style="background:#eee;">
        </div>
        <div class="form-group">
            <label>æ•¸é‡</label>
            <input type="number" id="actQty" placeholder="è«‹è¼¸å…¥æ•¸é‡">
        </div>
        <div class="form-group">
            <label>å‚™è¨» (é¸å¡«)</label>
            <input type="text" id="actNote" placeholder="ä¾‹å¦‚: ç—…æˆ¿é ˜ç”¨ã€å» å•†é€²è²¨">
        </div>
        <input type="hidden" id="actId">
        <input type="hidden" id="actType">
        <input type="hidden" id="actCurrentQty">

        <div class="modal-footer">
            <button class="action-btn" style="background:#666;" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="action-btn btn-in" id="confirmBtn" onclick="submitAction()">ç¢ºèª</button>
        </div>
    </div>
</div>

<script>
    function cleanString(str) { return str.replace(/[^\x20-\x7E]/g, '').trim(); }
    // â˜…â˜…â˜… è«‹æ›¿æ› â˜…â˜…â˜…
    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

    let inventoryData = [];
    let currentUser = '';
    let isAdmin = false; // é è¨­ä¸æ˜¯ç®¡ç†å“¡

    // åˆå§‹åŒ–
    (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if(!session) window.location.href = 'index.html';
        currentUser = session.user.email;
        document.getElementById('userInfo').innerText = currentUser;

        // â˜…â˜…â˜… æª¢æŸ¥æ¬Šé™ â˜…â˜…â˜…
        await checkUserRole();
        
        loadInventory();
        loadLogs();
    })();

    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
    async function checkUserRole() {
        const { data, error } = await supabase
            .from('user_roles')
            .select('role')
            .eq('email', currentUser)
            .single();

        const roleLabel = document.getElementById('roleLabel');
        
        if (data && data.role === 'admin') {
            isAdmin = true;
            // é¡¯ç¤ºæ‰€æœ‰ç®¡ç†å“¡æŒ‰éˆ•
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            roleLabel.innerHTML = '<span class="role-badge" style="background:#dc3545;">ç®¡ç†å“¡</span>';
        } else {
            isAdmin = false;
            roleLabel.innerHTML = '<span class="role-badge" style="background:#28a745;">ä¸€èˆ¬äººå“¡</span>';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    async function loadInventory() {
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '<tr><td colspan="7">è¼‰å…¥ä¸­...</td></tr>';
        const { data } = await supabase.from('inventory').select('*').order('name');
        inventoryData = data || [];
        renderTable(inventoryData);
    }

    function renderTable(data) {
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '';
        const today = new Date();
        const warningDate = new Date(); warningDate.setDate(today.getDate() + 90);

        data.forEach(item => {
            let statusBadge = '<span class="badge bg-ok">æ­£å¸¸</span>';
            if(item.expiry_date) {
                const exp = new Date(item.expiry_date);
                if(exp < today) statusBadge = '<span class="badge bg-danger">å·²éæœŸ</span>';
                else if(exp < warningDate) statusBadge = '<span class="badge bg-warn">å¿«éæœŸ</span>';
            }

            // â˜… æ¬Šé™æ§åˆ¶
            let actionButtons = '';
            if (isAdmin) {
                actionButtons = `
                    <button class="action-btn btn-in" onclick="openAction('IN', '${item.id}')">å…¥åº«</button>
                    <button class="action-btn btn-out" onclick="openAction('OUT', '${item.id}')">é ˜ç”¨</button>
                `;
            } else {
                actionButtons = `
                    <button class="action-btn btn-out" onclick="openAction('OUT', '${item.id}')">é ˜ç”¨</button>
                `;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold;">${item.name}</td>
                <td>${item.category || '-'}</td>
                <td style="font-size:1.1em; color:#1a73e8; font-weight:bold;">${item.quantity}</td>
                <td>${item.unit || 'ç½'}</td>
                <td>${item.expiry_date || '-'}</td>
                <td>${statusBadge}</td>
                <td>${actionButtons}</td>
            `;
            tbody.innerHTML += tr.outerHTML;
        });
    }

    function filterTable() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        renderTable(inventoryData.filter(i => i.name.toLowerCase().includes(term)));
    }

    function openAction(type, id) {
        const item = inventoryData.find(i => i.id === id);
        if(!item) return;

        if (type === 'IN' && !isAdmin) return alert('æ¬Šé™ä¸è¶³ï¼šåƒ…ç®¡ç†å“¡å¯å…¥åº«');

        document.getElementById('actionModal').style.display = 'flex';
        document.getElementById('actId').value = id;
        document.getElementById('actType').value = type;
        document.getElementById('actCurrentQty').value = item.quantity;
        document.getElementById('actName').value = item.name;
        document.getElementById('actQty').value = '';
        document.getElementById('actNote').value = '';

        const btn = document.getElementById('confirmBtn');
        const title = document.getElementById('modalTitle');
        
        if(type === 'IN') {
            title.innerText = `â• å…¥åº«ï¼š${item.name}`;
            btn.innerText = 'ç¢ºèªå…¥åº«';
            btn.className = 'action-btn btn-in';
        } else {
            title.innerText = `â– é ˜ç”¨ï¼š${item.name}`;
            btn.innerText = 'ç¢ºèªé ˜ç”¨';
            btn.className = 'action-btn btn-out';
        }
    }

    async function submitAction() {
        const id = document.getElementById('actId').value;
        const type = document.getElementById('actType').value;
        const name = document.getElementById('actName').value;
        const qtyInput = parseInt(document.getElementById('actQty').value);
        const currentQty = parseInt(document.getElementById('actCurrentQty').value);
        const note = document.getElementById('actNote').value;

        if(!qtyInput || qtyInput <= 0) return alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡');
        
        let newQty = currentQty;
        if(type === 'IN') newQty += qtyInput;
        else {
            if(currentQty < qtyInput) return alert('åº«å­˜ä¸è¶³ï¼');
            newQty -= qtyInput;
        }

        document.getElementById('confirmBtn').disabled = true;

        try {
            const { error: upErr } = await supabase.from('inventory').update({ quantity: newQty }).eq('id', id);
            if(upErr) throw upErr;

            await supabase.from('inventory_logs').insert([{
                product_name: name,
                action_type: type === 'IN' ? 'å…¥åº«' : 'é ˜ç”¨',
                change_qty: qtyInput,
                final_qty: newQty,
                operator: currentUser,
                note: note
            }]);

            alert('âœ… æ“ä½œæˆåŠŸ');
            closeModal();
            loadInventory();
            loadLogs(); 
        } catch(e) {
            alert('âŒ å¤±æ•—: ' + e.message);
        } finally {
            document.getElementById('confirmBtn').disabled = false;
        }
    }

    async function loadLogs() {
        const tbody = document.getElementById('logBody');
        const { data } = await supabase.from('inventory_logs').select('*').order('created_at', { ascending: false }).limit(50);
        
        if(!data) return;
        tbody.innerHTML = '';
        data.forEach(log => {
            const dateStr = new Date(log.created_at).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
            const color = log.action_type === 'å…¥åº«' ? 'green' : 'red';
            tbody.innerHTML += `
                <tr>
                    <td style="font-size:12px;">${dateStr}</td>
                    <td style="color:${color}; font-weight:bold;">${log.action_type}</td>
                    <td>${log.product_name}</td>
                    <td>${log.change_qty}</td>
                    <td style="color:#888;">${log.final_qty}</td>
                    <td style="font-size:12px;">${log.operator}</td>
                    <td style="font-size:12px; color:#555;">${log.note || '-'}</td>
                </tr>
            `;
        });
    }

    // ==========================================
    // æ–°å¢åŠŸèƒ½ï¼šä¸‹è¼‰ç›¤é»å–® (æ ¼å¼å°ˆç‚ºåŒ¯å…¥è¨­è¨ˆ)
    // ==========================================
    function downloadForStockTake() {
        if(inventoryData.length === 0) return alert("ç„¡è³‡æ–™å¯ä¸‹è¼‰");

        // åƒ…åŒ¯å‡ºå¿…è¦çš„æ¬„ä½ï¼Œæ–¹ä¾¿ç›¤é»å¾Œç›´æ¥ä¿®æ”¹æ•¸å­—ä¸Šå‚³
        const stockData = inventoryData.map(item => ({
            "å“å": item.name,
            "åˆ†é¡": item.category,
            "åº«å­˜æ•¸é‡": item.quantity,
            "å–®ä½": item.unit,
            "æœ‰æ•ˆæ—¥æœŸ": item.expiry_date
        }));

        const ws = XLSX.utils.json_to_sheet(stockData);
        // è¨­å®šæ¬„å¯¬æ–¹ä¾¿é–±è®€
        ws['!cols'] = [{wch: 20}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 15}];
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ç›¤é»å–®");
        
        const date = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `åº«å­˜ç›¤é»å–®_${date}.xlsx`);
    }

    // ==========================================
    // æ–°å¢åŠŸèƒ½ï¼šä¸Šå‚³ Excel ä¸¦è¦†è“‹åº«å­˜
    // ==========================================
    async function handleExcelImport(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        if (!confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒä½¿ç”¨ Excel ä¸­çš„ã€Œåº«å­˜æ•¸é‡ã€ç›´æ¥è¦†è“‹ç³»çµ±ä¸­çš„è³‡æ–™ã€‚\n\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ")) {
            inputElement.value = ''; 
            return;
        }

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                console.log("åŒ¯å…¥è³‡æ–™:", jsonData);

                // è½‰æ›æ¬„ä½åç¨± (Excel ä¸­æ–‡ -> Supabase è‹±æ–‡)
                const updates = jsonData.map(row => {
                    // æª¢æŸ¥å¿…è¦æ¬„ä½
                    if (!row['å“å']) return null;

                    return {
                        name: row['å“å'],           // å¿…é ˆå°æ‡‰è³‡æ–™åº« Unique Key
                        category: row['åˆ†é¡'] || '',
                        quantity: row['åº«å­˜æ•¸é‡'] || 0, // ä¿®æ”¹é€™è£¡ä»¥é…åˆä½ çš„è³‡æ–™åº«æ¬„ä½
                        unit: row['å–®ä½'] || 'ç½',
                        expiry_date: formatExcelDate(row['æœ‰æ•ˆæ—¥æœŸ'])
                    };
                }).filter(item => item !== null); // éæ¿¾æ‰ç©ºè¡Œ

                if (updates.length === 0) throw new Error("Excel ä¸­æ²’æœ‰æœ‰æ•ˆè³‡æ–™");

                // æ‰¹æ¬¡æ›´æ–° (Upsert)
                const { error } = await supabase
                    .from('inventory')
                    .upsert(updates, { onConflict: 'name' });

                if (error) throw error;

                // ç´€éŒ„é€™æ¬¡æ“ä½œåˆ° Log
                await supabase.from('inventory_logs').insert([{
                    product_name: 'æ‰¹æ¬¡åŒ¯å…¥',
                    action_type: 'ç›¤é»æ›´æ–°',
                    change_qty: 0,
                    final_qty: 0,
                    operator: currentUser,
                    note: `Excel ç›¤é»åŒ¯å…¥è¦†è“‹ ${updates.length} ç­†è³‡æ–™`
                }]);

                alert(`âœ… æˆåŠŸæ›´æ–° ${updates.length} ç­†åº«å­˜è³‡æ–™ï¼`);
                
                // é‡æ–°è¼‰å…¥
                inputElement.value = '';
                loadInventory();
                
            } catch (error) {
                console.error('åŒ¯å…¥å¤±æ•—:', error);
                alert('âŒ åŒ¯å…¥å¤±æ•—: ' + error.message + '\nè«‹ç¢ºèª Excel æ¬„ä½åç¨±æ˜¯å¦ç‚ºï¼šå“å, åˆ†é¡, åº«å­˜æ•¸é‡, å–®ä½, æœ‰æ•ˆæ—¥æœŸ');
                inputElement.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // è¼”åŠ©ï¼šè™•ç† Excel æ—¥æœŸæ ¼å¼
    function formatExcelDate(excelDate) {
        if (!excelDate) return null;
        if (typeof excelDate === 'string') return excelDate;
        // Excel åºåˆ—è™Ÿè½‰æ—¥æœŸ
        if (typeof excelDate === 'number') {
            const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
            return date.toISOString().split('T')[0];
        }
        return null;
    }

    // ä¸€èˆ¬åŒ¯å‡ºå ±è¡¨åŠŸèƒ½ (ä¿ç•™åŸæœ¬çš„)
    function exportStock() {
        if(inventoryData.length === 0) return alert("ç„¡è³‡æ–™å¯åŒ¯å‡º");
        const exportData = inventoryData.map(item => ({
            "å“å": item.name,
            "åˆ†é¡": item.category,
            "åº«å­˜æ•¸é‡": item.quantity,
            "å–®ä½": item.unit,
            "æœ‰æ•ˆæ—¥æœŸ": item.expiry_date || "ç„¡",
        }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "å³æ™‚åº«å­˜");
        XLSX.writeFile(wb, `åº«å­˜å ±è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // åŒ¯å‡ºç´€éŒ„ (ä¿ç•™åŸæœ¬çš„)
    async function exportLogs() {
        const btn = document.querySelector('.btn-export');
        const originalText = btn.innerText;
        btn.innerText = "ä¸‹è¼‰ä¸­...";
        btn.disabled = true;

        try {
            const { data, error } = await supabase
                .from('inventory_logs')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(1000);

            if(error) throw error;
            if(!data || data.length === 0) return alert("ç„¡ç´€éŒ„å¯åŒ¯å‡º");

            const exportData = data.map(log => ({
                "æ™‚é–“": new Date(log.created_at).toLocaleString('zh-TW'),
                "å‹•ä½œ": log.action_type,
                "å“å": log.product_name,
                "ç•°å‹•æ•¸é‡": log.change_qty,
                "çµé¤˜æ•¸é‡": log.final_qty,
                "æ“ä½œäºº": log.operator,
                "å‚™è¨»": log.note || ""
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "é€²å‡ºç´€éŒ„");
            XLSX.writeFile(wb, `é€²å‡ºè²¨æ˜ç´°_${new Date().toISOString().slice(0,10)}.xlsx`);

        } catch(e) {
            alert("åŒ¯å‡ºå¤±æ•—ï¼š" + e.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function closeModal() { document.getElementById('actionModal').style.display = 'none'; }
    function openAddModal() { location.href = 'inventory.html'; }
</script>

</body>
</html>
