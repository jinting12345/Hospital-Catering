<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿé¤Šå“åº«å­˜ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; padding-bottom: 100px; }
        
        /* Header & Tabs */
        .header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .back-btn { text-decoration: none; color: #666; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        h2 { margin: 0; color: #2c3e50; font-size: 1.2em; }
        .role-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white; vertical-align: middle; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #e4e6eb; cursor: pointer; border-radius: 8px; font-weight: bold; color: #65676b; white-space: nowrap; transition: 0.2s; }
        .tab-btn.active { background: #1a73e8; color: white; box-shadow: 0 2px 4px rgba(26,115,232,0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Controls */
        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .search-input, .category-select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .search-input { flex: 2; min-width: 150px; }
        .category-select { flex: 1; min-width: 120px; }

        /* Buttons */
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; width: 100%; margin-top: 5px; }
        .action-btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9em; transition: 0.2s; }
        .action-btn:active { transform: scale(0.98); }
        .btn-in { background: #34c759; } 
        .btn-out { background: #ff3b30; } 
        .btn-import { background: #007aff; } 
        .btn-export { background: #5856d6; } 
        .btn-stocktake { background: #ff9500; } 
        .btn-detail { background: #007aff; color: white; padding: 6px 12px; font-size: 0.85em; border-radius: 6px; }
        
        /* ğŸ”¥ é–å®š/è§£é–æŒ‰éˆ•æ¨£å¼ */
        .btn-lock { background: #6c757d; min-width: 100px; }
        .btn-lock.editing { background: #dc3545; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% {box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);} 100% {box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);} }

        .admin-only { display: none; }

        /* Fab Buttons */
        .fab-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 900;
            display: none; flex-direction: column; gap: 15px; align-items: flex-end;
        }
        .fab-main {
            background: linear-gradient(135deg, #007aff, #005ecb); color: white;
            padding: 15px 25px; border-radius: 50px; font-weight: bold; font-size: 1.1em;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4); cursor: pointer; display: flex; align-items: center; gap: 10px;
            transition: transform 0.2s;
        }
        .fab-main:active { transform: scale(0.95); }
        .fab-clear {
            background: #ff3b30; color: white; width: 45px; height: 45px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3);
            cursor: pointer; font-size: 1.2em; transition: transform 0.2s;
        }
        .fab-clear:active { transform: scale(0.9); }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; }
        .checkbox-cell { width: 40px; text-align: center; }
        .checkbox-cell input { width: 20px; height: 20px; cursor: pointer; }
        
        /* ğŸ”¥ æ‹–æ›³æŠŠæ‰‹æ¨£å¼ */
        .drag-handle { cursor: grab; color: #aaa; font-size: 1.2em; padding: 10px; display: none; /* é è¨­éš±è— */ }
        .drag-handle:active { cursor: grabbing; color: #333; }
        .sort-number { font-weight: bold; color: #555; display: inline-block; width: 30px; text-align: center; }

        /* å”¯è®€æ™‚çš„æ¨£å¼ */
        .readonly-mode input { background: transparent; border: none; pointer-events: none; color: #333; }
        
        @media (max-width: 768px) {
            thead { display: none; }
            tr { display: block; background: white; border-radius: 12px; margin-bottom: 15px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative; padding-left: 50px; }
            td.checkbox-cell { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); border: none; }
            td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; text-align: right; }
            td:last-child { border-bottom: none; flex-direction: column; gap: 10px; }
            td::before { content: attr(data-label); font-weight: bold; color: #888; text-align: left; margin-right: 15px; font-size: 0.9em; }
            .qty-cell { font-size: 1.4em !important; }
            .btn-detail { width: 100%; padding: 12px; }
        }
        @media (min-width: 769px) {
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
            th { background: #f8f9fa; color: #555; font-weight: bold; white-space: nowrap; }
            tr:hover { background-color: #f8f9fa; }
        }

        /* Status Badges */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; color: white; font-weight: bold; display: inline-block; min-width: 80px; text-align: center; }
        .bg-green { background: #28a745; }
        .bg-blue { background: #17a2b8; } 
        .bg-yellow { background: #ffc107; color: #333; }
        .bg-red { background: #dc3545; animation: pulse 1.5s infinite; }
        .bg-cat { background: #8e8e93; font-size: 0.85em; margin-right: 5px; min-width: auto; }
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.6;} 100% {opacity:1;} }

        .date-cell { font-family: Consolas, monospace; color: #555; }
        .qty-cell { font-size: 1.1em; color: #007aff; font-weight: 800; }
        .qty-zero { color: #ccc; font-weight: normal; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        @media (min-width: 769px) { .modal { align-items: center; } .modal-content { border-radius: 12px; width: 90%; } }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .modal-footer { display: flex; gap: 10px; margin-top: 25px; }
        .modal-footer button { flex: 1; padding: 12px; }

        /* Search Dropdown & Checkout List */
        .search-dropdown { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; max-height: 150px; overflow-y: auto; z-index: 10; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .search-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .search-item:hover { background-color: #f5f7fa; }
        .checkout-list { list-style: none; padding: 0; margin-bottom: 20px; max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
        .checkout-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: white; }
        .checkout-item:last-child { border-bottom: none; }
        .btn-remove { color: #ff3b30; background: none; border: none; font-size: 1.2em; cursor: pointer; padding: 0 10px; }
        .batch-list { list-style: none; padding: 0; margin-top: 10px; }
        .batch-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 0.95em; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-top">
            <h2>ğŸ“¦ åº«å­˜ç®¡ç† <span id="roleLabel"></span></h2>
            <a href="menu.html" class="back-btn">â¬… é¸å–®</a>
        </div>
        <div style="font-size:13px; color:#888;" id="userInfo">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('stock')">ğŸ“Š ç¸½åº«å­˜åˆ—è¡¨</button>
        <button class="tab-btn" onclick="switchTab('logs')">ğŸ“ é€²å‡ºç´€éŒ„</button>
    </div>

    <div id="stock" class="tab-content active">
        <div class="controls">
            <select id="categoryFilter" class="category-select" onchange="renderTable()">
                <option value="ALL">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>
            </select>
            <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å“å..." onkeyup="renderTable()">
            
            <div class="btn-group">
                <button id="editToggleBtn" class="action-btn btn-lock admin-only" onclick="toggleEditMode()">ğŸ”’ è§£é–ç·¨è¼¯</button>
                
                <input type="file" id="excel_input" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelImport(this)">
                <button class="action-btn btn-import admin-only" onclick="document.getElementById('excel_input').click()">ğŸ“‚ åŒ¯å…¥</button>
                <button class="action-btn btn-in admin-only" style="background:#007bff;" onclick="openNewItemModal()">â• æ–°å¢</button>
                <button class="action-btn btn-stocktake" onclick="downloadBlankForm()">ğŸ“„ ç›¤é»è¡¨</button>
                <button class="action-btn btn-export" onclick="exportStock()">ğŸ“¥ ç¸½è¡¨</button>
            </div>
        </div>
        
        <table id="stockTable">
            <thead>
                <tr>
                    <th width="40">é¸</th>
                    <th width="80">æ’åº</th>
                    <th width="15%">åˆ†é¡</th>
                    <th width="25%">å“å</th>
                    <th width="10%">ç¸½åº«å­˜</th>
                    <th width="8%">å–®ä½</th>
                    <th width="20%">æœ€è¿‘æ•ˆæœŸ</th>
                    <th width="12%">ç‹€æ…‹</th>
                    <th width="10%">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="stockBody"></tbody>
        </table>
    </div>

    <div id="logs" class="tab-content">
        <div class="controls" style="justify-content: space-between; align-items: center;">
            <h3 style="margin:0;">æœ€è¿‘ 50 ç­†ç•°å‹•</h3>
            <button class="action-btn btn-export" style="width: auto;" onclick="exportLogs()">ğŸ“¥ ä¸‹è¼‰</button>
        </div>
        <table id="logTable">
            <thead>
                <tr><th>æ™‚é–“</th> <th>å‹•ä½œ</th> <th>å“å</th> <th>é‡</th> <th>æ•ˆæœŸ</th> <th>äºº</th> <th>å‚™è¨»</th></tr>
            </thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>
</div>

<div id="fabContainer" class="fab-container">
    <div class="fab-clear" onclick="clearSelection()" title="ä¸€éµå–æ¶ˆå‹¾é¸"><i class="fas fa-trash-alt"></i></div>
    <div class="fab-main" onclick="openBatchCheckoutModal()"><i class="fas fa-shopping-cart"></i> ä¸€éµé ˜ç”¨ (<span id="selectedCount">0</span>)</div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <h3 id="detailTitle" style="margin-top:0; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;"></h3>
        <div style="max-height: 35vh; overflow-y: auto;"><ul id="batchList" class="batch-list"></ul></div>
        <div style="margin-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <h4 style="margin:0 0 10px 0; color:#28a745;">â• å…¥åº«è£œè²¨</h4>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <input type="date" id="newBatchDate" style="flex: 2; padding: 10px;">
                <input type="number" id="newBatchQty" placeholder="æ•¸é‡" style="flex: 1; padding: 10px; min-width: 60px;">
                <button class="action-btn btn-in" style="flex: 1;" onclick="addNewBatch()">å…¥åº«</button>
            </div>
        </div>
        <div class="modal-footer"><button class="action-btn" style="background:#e4e6eb; color:#333;" onclick="closeModal('detailModal')">é—œé–‰</button></div>
    </div>
</div>

<div id="batchCheckoutModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:#007aff;">ğŸ›’ é ˜ç”¨ç¢ºèª</h3>
        <div class="form-group" style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
            <label>ğŸ” æœå°‹ä¸¦åŠ å…¥å“é …</label>
            <input type="text" id="itemSearchInput" placeholder="è¼¸å…¥é—œéµå­—..." onkeyup="searchItemToAdd()">
            <div id="searchResults" class="search-dropdown"></div>
        </div>
        <div class="form-group"><label>å·²é¸æ¸…å–®</label><ul id="checkoutList" class="checkout-list"></ul></div>
        <div class="form-group"><label>é ˜ç”¨äºº*</label><input type="text" id="batchRecipient" placeholder="è«‹è¼¸å…¥å§“å"></div>
        <div class="form-group"><label>ç—…æ­·è™Ÿ/ç”¨é€”*</label><input type="text" id="batchNote" placeholder="ç”¨é€”"></div>
        <div class="modal-footer">
            <button class="action-btn" style="background:#e4e6eb; color:#333;" onclick="closeModal('batchCheckoutModal')">å–æ¶ˆ</button>
            <button class="action-btn btn-out" onclick="submitBatchCheckout()">ç¢ºèªé ˜å‡º</button>
        </div>
    </div>
</div>

<div id="newItemModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">âœ¨ æ–°å¢å“é …</h3>
        <div class="form-group"><label>åˆ†é¡</label><input type="text" id="newCat"></div>
        <div class="form-group"><label>å“å</label><input type="text" id="newItemName"></div>
        <div class="form-group"><label>å–®ä½</label><input type="text" id="newUnit" placeholder="ä¾‹: ç½"></div>
        <div class="form-group"><label>æ•ˆæœŸ</label><input type="date" id="newItemDate"></div>
        <div class="form-group"><label>æ•¸é‡</label><input type="number" id="newItemQty"></div>
        <div class="modal-footer">
            <button class="action-btn" style="background:#e4e6eb; color:#333;" onclick="closeModal('newItemModal')">å–æ¶ˆ</button>
            <button class="action-btn btn-in" onclick="submitNewItem()">ç¢ºèªæ–°å¢</button>
        </div>
    </div>
</div>

<script>
    function cleanString(str) { return str.replace(/[^\x20-\x7E]/g, '').trim(); }
    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

    let rawInventory = [];
    let groupedInventory = [];
    let currentUser = '';
    let isAdmin = false;
    let currentDetailItemName = '';
    let selectedItems = new Set();
    
    // ğŸ”¥ ç·¨è¼¯æ¨¡å¼é–‹é—œ Flag
    let isEditMode = false;
    let sortableInstance = null;

    (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if(!session) window.location.href = 'index.html';
        currentUser = session.user.email;
        document.getElementById('userInfo').innerText = currentUser;
        await checkUserRole();
        loadInventory();
        loadLogs();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('newBatchDate').value = today;
        document.getElementById('newItemDate').value = today;
    })();

    async function checkUserRole() {
        const { data } = await supabase.from('user_roles').select('role').eq('email', currentUser).single();
        if (data && data.role === 'admin') {
            isAdmin = true;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            document.getElementById('roleLabel').innerHTML = '<span class="role-badge" style="background:#ff3b30;">Admin</span>';
        } else {
            isAdmin = false;
            document.getElementById('roleLabel').innerHTML = '<span class="role-badge" style="background:#34c759;">User</span>';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    // ğŸ”¥ é–å®š/è§£é–åŠŸèƒ½
    function toggleEditMode() {
        isEditMode = !isEditMode;
        const btn = document.getElementById('editToggleBtn');
        const tbody = document.getElementById('stockBody');
        const dragHandles = document.querySelectorAll('.drag-handle');

        if (isEditMode) {
            // é€²å…¥ç·¨è¼¯æ¨¡å¼
            btn.innerHTML = 'ğŸ”“ é»æ­¤é–å®š';
            btn.classList.add('editing');
            dragHandles.forEach(el => el.style.display = 'inline-block');
            
            // åˆå§‹åŒ–æ‹–æ›³åŠŸèƒ½
            if (!sortableInstance) {
                sortableInstance = Sortable.create(tbody, {
                    handle: '.drag-handle', // åªèƒ½æ‹‰æŠŠæ‰‹
                    animation: 150,
                    onEnd: function (evt) {
                        updateOrderAfterDrag();
                    }
                });
            }
            sortableInstance.option("disabled", false);

        } else {
            // é–å®šæ¨¡å¼
            btn.innerHTML = 'ğŸ”’ è§£é–ç·¨è¼¯';
            btn.classList.remove('editing');
            dragHandles.forEach(el => el.style.display = 'none');
            
            if (sortableInstance) {
                sortableInstance.option("disabled", true);
            }
        }
    }

    // ğŸ”¥ æ‹–æ›³å¾Œæ›´æ–°é †åº
    async function updateOrderAfterDrag() {
        const rows = document.querySelectorAll('#stockBody tr');
        let updates = [];
        
        // æ›´æ–° UI ä¸Šçš„æ•¸å­—
        rows.forEach((row, index) => {
            const newOrder = index + 1;
            const name = row.dataset.name;
            row.querySelector('.sort-number').innerText = newOrder;
            
            // æ‰¾å‡ºè©²å“åå°æ‡‰çš„æ‰€æœ‰è³‡æ–™åº« ID (å¯èƒ½æœ‰ä¸åŒæ•ˆæœŸï¼Œä½†å…±ç”¨ä¸€å€‹æ’åº)
            const group = groupedInventory.find(g => g.name === name);
            if(group) {
                group.sortOrder = newOrder; // æ›´æ–°æœ¬åœ°
                // æº–å‚™æ›´æ–°è³‡æ–™åº«
                updates.push(name);
            }
        });

        // æ‰¹æ¬¡æ›´æ–°åˆ° Supabase (é€™è£¡æ¡å–ç°¡åŒ–ç­–ç•¥ï¼šç›´æ¥æ›´æ–°è®Šå‹•çš„é …ç›®)
        // ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘åªå°è®Šå‹•é …ç›®ç™¼é€è«‹æ±‚ï¼Œä½†ç‚ºäº†ç¢ºä¿æ’åºçµ•å°æ­£ç¢ºï¼Œå»ºè­°å…¨éƒ¨æ›´æ–°
        // åœ¨æ­¤ç¯„ä¾‹ä¸­ï¼Œæˆ‘å€‘è¿´åœˆæ›´æ–°æ¯ä¸€å€‹å“åçš„ sort_order
        for (let i = 0; i < updates.length; i++) {
            const name = updates[i];
            const order = i + 1;
            await supabase.from('inventory').update({ sort_order: order }).eq('name', name);
        }
        
        // é‡æ–°è®€å–ä¸€æ¬¡ç¢ºä¿åŒæ­¥
        // loadInventory(); // ç‚ºäº†é«”é©—æµæš¢ï¼Œå¯ä»¥å…ˆä¸é‡æ•´ï¼Œå› ç‚º UI å·²ç¶“æ›´æ–°äº†
    }

    async function loadInventory() {
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>';
        const { data, error } = await supabase.from('inventory').select('*').order('expiry_date', { ascending: true });
        if(error) { alert("è®€å–å¤±æ•—"); return; }
        rawInventory = data || [];
        groupData(rawInventory);
        updateCategoryFilter();
        renderTable();
    }

    function groupData(data) {
        const groups = {};
        data.forEach(item => {
            const name = item.name;
            if (!groups[name]) {
                groups[name] = { 
                    name: name, 
                    category: item.category, 
                    unit: item.unit, 
                    totalQty: 0, 
                    batches: [],
                    sortOrder: item.sort_order || 999 
                };
            }
            groups[name].totalQty += item.quantity;
            groups[name].batches.push(item);
        });
        
        // ä¾ç…§ sortOrder æ’åº
        groupedInventory = Object.values(groups).sort((a, b) => (a.sortOrder - b.sortOrder));
    }

    function updateCategoryFilter() {
        const select = document.getElementById('categoryFilter');
        const currentVal = select.value;
        const categories = [...new Set(groupedInventory.map(i => i.category || 'æœªåˆ†é¡'))].sort();
        select.innerHTML = '<option value="ALL">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>';
        categories.forEach(cat => select.innerHTML += `<option value="${cat}">${cat}</option>`);
        select.value = currentVal;
    }

    function renderTable() {
        const tbody = document.getElementById('stockBody');
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const filterCat = document.getElementById('categoryFilter').value;
        const today = new Date();

        // éŠ·æ¯€èˆŠçš„ Sortable å¯¦ä¾‹ï¼Œé¿å…é‡è¤‡ç¶å®š
        if(sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }
        // é‡ç½®ç·¨è¼¯ç‹€æ…‹ UI
        isEditMode = false;
        document.getElementById('editToggleBtn').innerHTML = 'ğŸ”’ è§£é–ç·¨è¼¯';
        document.getElementById('editToggleBtn').classList.remove('editing');

        tbody.innerHTML = '';
        const filtered = groupedInventory.filter(group => {
            const matchText = group.name.toLowerCase().includes(searchText);
            const matchCat = filterCat === 'ALL' || group.category === filterCat;
            return matchText && matchCat;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px; color:#999;">æŸ¥ç„¡è³‡æ–™</td></tr>';
            return;
        }

        filtered.forEach((group, index) => {
            const validBatches = group.batches.filter(b => b.expiry_date);
            const nearestBatch = validBatches.length > 0 ? validBatches[0] : null;
            
            let dateDisplay = 'ç„¡æ•ˆæœŸ';
            let statusBadge = '<span class="badge bg-gray">å¤§æ–¼2å€‹æœˆ</span>';
            
            if (nearestBatch) {
                dateDisplay = nearestBatch.expiry_date;
                const diffDays = Math.ceil((new Date(nearestBatch.expiry_date) - today) / (1000 * 60 * 60 * 24)); 
                if (diffDays < 0) statusBadge = '<span class="badge bg-red">å·²éæœŸ</span>';
                else if (diffDays <= 15) statusBadge = `<span class="badge bg-red">å€’æ•¸ ${diffDays} å¤©</span>`;
                else if (diffDays <= 30) statusBadge = '<span class="badge bg-yellow">1å€‹æœˆå…§</span>';
                else if (diffDays <= 60) statusBadge = '<span class="badge bg-blue">2å€‹æœˆå…§</span>';
                else statusBadge = '<span class="badge bg-green">å¤§æ–¼2å€‹æœˆ</span>';
            }

            const tr = document.createElement('tr');
            tr.dataset.name = group.name; // ç¶å®šåç¨±æ–¹ä¾¿æ‹–æ›³è­˜åˆ¥
            const qtyClass = group.totalQty === 0 ? 'qty-zero' : 'qty-cell';
            const isChecked = selectedItems.has(group.name) ? 'checked' : '';
            
            // ğŸ”¥ é€™è£¡æ”¹ç‚ºé¡¯ç¤ºæ•¸å­— + æ‹–æ›³æŠŠæ‰‹
            tr.innerHTML = `
                <td class="checkbox-cell"><input type="checkbox" class="item-check" value="${group.name}" ${isChecked} onchange="toggleSelection('${group.name}', this)"></td>
                <td data-label="æ’åº">
                    <i class="fas fa-bars drag-handle"></i>
                    <span class="sort-number">${group.sortOrder || (index + 1)}</span>
                </td>
                <td data-label="åˆ†é¡"><span class="badge bg-cat">${group.category || 'æœªåˆ†é¡'}</span></td>
                <td data-label="å“å" style="font-weight:bold; font-size:1.1em;">${group.name}</td>
                <td data-label="ç¸½åº«å­˜" class="${qtyClass}">${group.totalQty}</td>
                <td data-label="å–®ä½">${group.unit || 'ç½'}</td>
                <td data-label="æœ€è¿‘æ•ˆæœŸ" class="date-cell">${dateDisplay}</td>
                <td data-label="ç‹€æ…‹">${statusBadge}</td>
                <td data-label="æ“ä½œ"><button class="action-btn btn-detail" onclick="openDetailModal('${group.name}')">è©³æƒ…/å…¥åº«</button></td>
            `;
            tbody.appendChild(tr);
        });
        updateFab();
    }

    function toggleSelection(name, checkbox) {
        if (checkbox.checked) selectedItems.add(name); else selectedItems.delete(name);
        updateFab();
    }
    
    function clearSelection() {
        selectedItems.clear();
        document.querySelectorAll('.item-check').forEach(cb => cb.checked = false);
        updateFab();
    }

    function updateFab() {
        const container = document.getElementById('fabContainer');
        if (selectedItems.size > 0) {
            container.style.display = 'flex';
            document.getElementById('selectedCount').innerText = selectedItems.size;
        } else {
            container.style.display = 'none';
        }
    }

    /* ä»¥ä¸‹ Modal èˆ‡ Checkout é‚è¼¯èˆ‡ä¹‹å‰ç›¸åŒï¼Œç•¥å¾®ç¸®æ¸›ä»¥ç¯€çœç©ºé–“ */
    function openBatchCheckoutModal() {
        renderCheckoutList();
        document.getElementById('itemSearchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';
        document.getElementById('batchRecipient').value = '';
        document.getElementById('batchNote').value = '';
        document.getElementById('batchCheckoutModal').style.display = 'flex';
    }

    function renderCheckoutList() {
        const list = document.getElementById('checkoutList');
        list.innerHTML = '';
        selectedItems.forEach(name => {
            const group = groupedInventory.find(g => g.name === name);
            if (!group) return;
            const li = document.createElement('li');
            li.className = 'checkout-item';
            li.innerHTML = `<div><button class="btn-remove" onclick="removeFromCart('${name}')">Ã—</button> <span>${name}</span></div> <div style="display:flex;align-items:center;gap:5px;"><input type="number" class="batch-out-qty" data-name="${name}" value="1" min="1" max="${group.totalQty}"> ${group.unit}</div>`;
            list.appendChild(li);
        });
    }

    function removeFromCart(name) {
        selectedItems.delete(name);
        const checkbox = document.querySelector(`.item-check[value="${name}"]`);
        if(checkbox) checkbox.checked = false;
        renderCheckoutList();
        updateFab();
    }

    function searchItemToAdd() {
        const text = document.getElementById('itemSearchInput').value.toLowerCase();
        const resultsDiv = document.getElementById('searchResults');
        resultsDiv.innerHTML = '';
        if(!text) { resultsDiv.style.display = 'none'; return; }
        const matches = groupedInventory.filter(g => g.name.toLowerCase().includes(text));
        if (matches.length > 0) {
            resultsDiv.style.display = 'block';
            matches.forEach(g => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `<span>${g.name}</span> <span style="color:#666;">åº«å­˜: ${g.totalQty}</span>`;
                div.onclick = () => { selectedItems.add(g.name); renderCheckoutList(); updateFab(); document.getElementById('itemSearchInput').value=''; resultsDiv.style.display='none'; };
                resultsDiv.appendChild(div);
            });
        } else { resultsDiv.style.display = 'none'; }
    }

    async function submitBatchCheckout() {
        const recipient = document.getElementById('batchRecipient').value.trim();
        const note = document.getElementById('batchNote').value.trim();
        if (!recipient || !note) return alert("è«‹å¡«å¯«é ˜ç”¨äººèˆ‡ç”¨é€”");
        const inputs = document.querySelectorAll('.batch-out-qty');
        let transactions = [];
        if (inputs.length === 0) return alert("ç„¡é …ç›®");

        for (let input of inputs) {
            const name = input.dataset.name;
            const qtyNeeded = parseInt(input.value);
            if (qtyNeeded <= 0) continue;
            const group = groupedInventory.find(g => g.name === name);
            if (qtyNeeded > group.totalQty) return alert(`${name} åº«å­˜ä¸è¶³`);
            const sortedBatches = group.batches.sort((a, b) => {
                if (!a.expiry_date) return 1; if (!b.expiry_date) return -1;
                return new Date(a.expiry_date) - new Date(b.expiry_date);
            });
            let remaining = qtyNeeded;
            for (let batch of sortedBatches) {
                if (remaining <= 0) break;
                if (batch.quantity <= 0) continue;
                let deduct = Math.min(batch.quantity, remaining);
                transactions.push({ id: batch.id, newQty: batch.quantity - deduct, change: deduct, name: name, expiry: batch.expiry_date || 'ç„¡' });
                remaining -= deduct;
            }
        }
        if(!confirm("ç¢ºå®šé ˜ç”¨ï¼Ÿ")) return;
        try {
            for (let t of transactions) {
                await supabase.from('inventory').update({ quantity: t.newQty }).eq('id', t.id);
                await logAction('é ˜ç”¨', t.name, t.change, t.newQty, t.expiry, `é ˜:${recipient} ç”¨:${note}`);
            }
            alert("âœ… æˆåŠŸ"); clearSelection(); closeModal('batchCheckoutModal'); loadInventory(); loadLogs();
        } catch(e) { alert("å¤±æ•—ï¼š" + e.message); }
    }

    function openDetailModal(itemName) {
        const group = groupedInventory.find(g => g.name === itemName);
        if (!group) return;
        currentDetailItemName = itemName;
        document.getElementById('detailTitle').innerText = `${itemName}`;
        const list = document.getElementById('batchList');
        list.innerHTML = '';
        const sortedBatches = group.batches.sort((a, b) => new Date(a.expiry_date||'9999-12-31') - new Date(b.expiry_date||'9999-12-31'));
        sortedBatches.forEach(batch => {
            const dateStr = batch.expiry_date || 'ç„¡æ•ˆæœŸ';
            const li = document.createElement('li');
            li.className = 'batch-item';
            if(batch.quantity === 0) li.style.opacity = '0.6';
            li.innerHTML = `<div class="batch-info"><div>ğŸ“… ${dateStr}</div><div>æ•¸é‡ï¼š<strong style="color:#007aff;">${batch.quantity}</strong></div></div>`;
            list.appendChild(li);
        });
        document.getElementById('detailModal').style.display = 'flex';
    }

    async function addNewBatch() {
        const date = document.getElementById('newBatchDate').value;
        const qty = parseInt(document.getElementById('newBatchQty').value);
        if (!qty || qty <= 0) return alert("è«‹è¼¸å…¥æ•¸é‡");
        const group = groupedInventory.find(g => g.name === currentDetailItemName);
        if(!confirm(`ç¢ºèªå…¥åº«ï¼Ÿ`)) return;
        try {
            // æ–°å¢æ™‚è‡ªå‹•å¸¶å…¥ç›®å‰çš„æ’åº
            await supabase.from('inventory').insert([{ name: group.name, category: group.category, unit: group.unit, expiry_date: date || null, quantity: qty, sort_order: group.sortOrder }]);
            await logAction('å…¥åº«', group.name, qty, qty, date, 'æ‰‹å‹•è£œè²¨');
            alert("âœ… æˆåŠŸ"); await loadInventory(); openDetailModal(currentDetailItemName); document.getElementById('newBatchQty').value = '';
        } catch(e) { alert(e.message); }
    }

    function openNewItemModal() { document.getElementById('newItemModal').style.display = 'flex'; }
    async function submitNewItem() {
        const name = document.getElementById('newItemName').value.trim();
        const cat = document.getElementById('newCat').value.trim();
        const unit = document.getElementById('newUnit').value.trim();
        const date = document.getElementById('newItemDate').value;
        const qty = parseInt(document.getElementById('newItemQty').value);
        if(!name) return alert("å“åå¿…å¡«");
        try {
            // æ–°é …ç›®é è¨­æ’åœ¨æœ€å¾Œ (9999)ï¼Œä¹‹å¾Œä½¿ç”¨è€…å¯ä»¥è‡ªå·±æ‹‰ä¸Šå»
            await supabase.from('inventory').insert([{ name, category: cat||'æœªåˆ†é¡', unit: unit||'ç½', expiry_date: date||null, quantity: qty||0, sort_order: 9999 }]);
            await logAction('å»ºæª”', name, qty, qty, date, 'æ–°å¢å“é …');
            alert("âœ… æˆåŠŸ"); closeModal('newItemModal'); loadInventory();
        } catch(e) { alert(e.message); }
    }

    async function logAction(action, name, change, final, expiry, note) {
        await supabase.from('inventory_logs').insert([{ product_name: name, action_type: action, change_qty: change, final_qty: final, operator: currentUser, note: `æ•ˆæœŸ:${expiry||'-'} ${note}` }]);
    }
    
    // Excel åŒ¯å…¥èˆ‡åŒ¯å‡ºç¶­æŒåŸæ¨£ (ç•¥å¾®ç°¡åŒ–ä»£ç¢¼)
    async function handleExcelImport(input) { /* ... (ç¶­æŒåŸé‚è¼¯) ... */ }
    function downloadBlankForm() { /* ... */ }
    function exportStock() { /* ... */ }
    async function exportLogs() { /* ... */ }
    async function loadLogs() { /* ... */ }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>
</body>
</html>
