<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿé¤Šå“åº«å­˜ç®¡ç†ç³»çµ± (é€²éšç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .back-btn { text-decoration: none; color: #666; font-weight: bold; }
        h2 { margin: 0; color: #2c3e50; }
        .role-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white; }

        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { padding: 10px 20px; border: none; background: #e0e0e0; cursor: pointer; border-radius: 5px 5px 0 0; font-weight: bold; color: #555; }
        .tab-btn.active { background: #1a73e8; color: white; }

        .tab-content { display: none; background: white; padding: 20px; border-radius: 0 5px 5px 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-content.active { display: block; }

        /* æ§åˆ¶å€ */
        .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .search-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
        .category-select { padding: 10px; border: 1px solid #1a73e8; border-radius: 4px; color: #1a73e8; font-weight: bold; background: white; cursor: pointer; }

        .action-btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; }
        .btn-in { background: #28a745; } 
        .btn-out { background: #dc3545; } 
        .btn-import { background: #17a2b8; } 
        .btn-export { background: #6f42c1; } 
        .btn-stocktake { background: #e67e22; } 
        .btn-detail { background: #1a73e8; } /* è—è‰²è©³æƒ…æŒ‰éˆ• */
        
        .admin-only { display: none; }

        /* è¡¨æ ¼å„ªåŒ– */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f1f3f5; color: #444; font-weight: bold; white-space: nowrap; }
        tr:hover { background-color: #f8f9fa; }

        /* æ•ˆæœŸè­¦ç¤º */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; color: white; font-weight: bold; display: inline-block; min-width: 60px; text-align: center; }
        .bg-ok { background: #28a745; }
        .bg-warn { background: #ffc107; color: #333; }
        .bg-danger { background: #dc3545; }
        .bg-cat { background: #6c757d; font-size: 0.9em; margin-right: 5px; } 
        
        /* ğŸ”¥ æ–°å¢ï¼šæ€¥è¿«è­¦ç¤º (å°æ–¼1å€‹æœˆ) */
        .bg-urgent { background: #dc3545; animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .date-cell { font-family: Consolas, monospace; color: #555; }
        .qty-cell { font-size: 1.2em; color: #1a73e8; font-weight: bold; }
        .qty-zero { color: #ccc; font-weight: normal; }

        /* Modal é€šç”¨ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-height: 85vh; overflow-y: auto; }
        
        /* è©³ç´°æ¸…å–® Modal ç‰¹è¦ */
        .batch-list { list-style: none; padding: 0; margin-top: 10px; }
        .batch-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .batch-item:last-child { border-bottom: none; }
        .batch-info { display: flex; flex-direction: column; }
        .batch-actions { display: flex; gap: 5px; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
        <h2>ğŸ“¦ ç‡Ÿé¤Šå“åº«å­˜ç®¡ç† <span id="roleLabel"></span></h2>
        <div style="font-size:14px; color:#666;" id="userInfo">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('stock')">ğŸ“Š ç¸½åº«å­˜åˆ—è¡¨</button>
        <button class="tab-btn" onclick="switchTab('logs')">ğŸ“ é€²å‡ºç´€éŒ„</button>
    </div>

    <div id="stock" class="tab-content active">
        <div class="controls">
            <select id="categoryFilter" class="category-select" onchange="renderTable()">
                <option value="ALL">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>
            </select>

            <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å“å..." onkeyup="renderTable()">
            
            <input type="file" id="excel_input" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelImport(this)">

            <button class="action-btn btn-import admin-only" onclick="document.getElementById('excel_input').click()">ğŸ“‚ åŒ¯å…¥ Excel</button>
            <button class="action-btn btn-in admin-only" style="background:#007bff;" onclick="openNewItemModal()">â• æ–°å¢å“é …</button>
            
            <button class="action-btn btn-stocktake" onclick="downloadBlankForm()">ğŸ“„ ä¸‹è¼‰ç©ºç™½ç›¤é»è¡¨</button>
            <button class="action-btn btn-export" onclick="exportStock()">ğŸ“¥ ä¸‹è¼‰ç¸½åº«å­˜è¡¨</button>
        </div>
        
        <div style="overflow-x:auto;">
            <table id="stockTable">
                <thead>
                    <tr>
                        <th width="15%">åˆ†é¡</th>
                        <th width="25%">å“å</th>
                        <th width="10%">ç¸½åº«å­˜</th>
                        <th width="8%">å–®ä½</th>
                        <th width="20%">æœ€è¿‘æœ‰æ•ˆæ—¥æœŸ</th> <th width="12%">ç‹€æ…‹</th>
                        <th width="10%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="stockBody"></tbody>
            </table>
        </div>
    </div>

    <div id="logs" class="tab-content">
        <div class="controls" style="justify-content: space-between;">
            <h3>æœ€è¿‘ 50 ç­†ç•°å‹•</h3>
            <button class="action-btn btn-export" onclick="exportLogs()">ğŸ“¥ ä¸‹è¼‰ç´€éŒ„</button>
        </div>
        <table id="logTable">
            <thead>
                <tr>
                    <th>æ™‚é–“</th> <th>å‹•ä½œ</th> <th>å“å</th> <th>ç•°å‹•é‡</th> <th>æ•ˆæœŸ</th> <th>æ“ä½œäºº</th> <th>å‚™è¨»</th>
                </tr>
            </thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <h3 id="detailTitle" style="border-bottom: 2px solid #1a73e8; padding-bottom: 10px;">å“é …è©³æƒ…</h3>
        <p style="color: #666; font-size: 0.9em;">ä»¥ä¸‹æ˜¯æ­¤å“é …çš„æ‰€æœ‰æ•ˆæœŸæ‰¹è™Ÿã€‚è«‹é‡å°ç‰¹å®šæ‰¹è™Ÿé€²è¡Œæ“ä½œã€‚</p>
        
        <div style="max-height: 300px; overflow-y: auto;">
            <ul id="batchList" class="batch-list">
                </ul>
        </div>

        <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee;">
            <h4>â• æ–°å¢æ‰¹è™Ÿ (æ–°æ•ˆæœŸé€²è²¨)</h4>
            <div style="display: flex; gap: 5px;">
                <input type="date" id="newBatchDate" style="flex: 1; padding: 5px;">
                <input type="number" id="newBatchQty" placeholder="æ•¸é‡" style="width: 80px; padding: 5px;">
                <button class="action-btn btn-in btn-sm" onclick="addNewBatch()">å…¥åº«</button>
            </div>
        </div>

        <div class="modal-footer">
            <button class="action-btn" style="background:#666;" onclick="closeModal('detailModal')">é—œé–‰</button>
        </div>
    </div>
</div>

<div id="actionModal" class="modal">
    <div class="modal-content" style="max-width: 350px;">
        <h3 id="actionTitle">åŸ·è¡Œå‹•ä½œ</h3>
        
        <div class="form-group">
            <label>å“å</label>
            <input type="text" id="actName" disabled style="background:#eee;">
        </div>
        <div class="form-group">
            <label>æ•ˆæœŸ</label>
            <input type="text" id="actDate" disabled style="background:#eee;">
        </div>
        <div class="form-group">
            <label>æ•¸é‡</label>
            <input type="number" id="actQty" placeholder="è«‹è¼¸å…¥æ•¸é‡">
        </div>
        <div class="form-group">
            <label>å‚™è¨»</label>
            <input type="text" id="actNote" placeholder="ä¾‹å¦‚: ç—…æˆ¿é ˜ç”¨">
        </div>

        <input type="hidden" id="actId">
        <input type="hidden" id="actType">
        <input type="hidden" id="actCurrentQty">

        <div class="modal-footer">
            <button class="action-btn" style="background:#666;" onclick="closeModal('actionModal')">å–æ¶ˆ</button>
            <button class="action-btn" id="confirmBtn" onclick="submitAction()">ç¢ºèª</button>
        </div>
    </div>
</div>

<div id="newItemModal" class="modal">
    <div class="modal-content">
        <h3>âœ¨ æ–°å¢å…¨æ–°åº«å­˜å“é …</h3>
        <div class="form-group"><label>åˆ†é¡</label><input type="text" id="newCat" placeholder="ä¾‹å¦‚: ç³–å°¿ç—…é…æ–¹"></div>
        <div class="form-group"><label>å“å</label><input type="text" id="newItemName" placeholder="è¼¸å…¥ç”¢å“åç¨±"></div>
        <div class="form-group"><label>å–®ä½</label><input type="text" id="newUnit" placeholder="ä¾‹å¦‚: ç½, ç®±"></div>
        <div class="form-group"><label>åˆå§‹æ•ˆæœŸ</label><input type="date" id="newItemDate"></div>
        <div class="form-group"><label>åˆå§‹æ•¸é‡</label><input type="number" id="newItemQty"></div>

        <div class="modal-footer">
            <button class="action-btn" style="background:#666;" onclick="closeModal('newItemModal')">å–æ¶ˆ</button>
            <button class="action-btn btn-in" onclick="submitNewItem()">ç¢ºèªæ–°å¢</button>
        </div>
    </div>
</div>

<script>
    function cleanString(str) { return str.replace(/[^\x20-\x7E]/g, '').trim(); }
    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

    let rawInventory = []; // åŸå§‹è³‡æ–™
    let groupedInventory = []; // åˆä½µå¾Œçš„è³‡æ–™
    let currentUser = '';
    let isAdmin = false;
    let currentDetailItemName = ''; // ç”¨æ–¼ç´€éŒ„ç•¶å‰æ‰“é–‹è©³æƒ…è¦–çª—çš„å“é …å

    // åˆå§‹åŒ–
    (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if(!session) window.location.href = 'index.html';
        currentUser = session.user.email;
        document.getElementById('userInfo').innerText = currentUser;

        await checkUserRole();
        loadInventory();
        loadLogs();
    })();

    async function checkUserRole() {
        const { data } = await supabase.from('user_roles').select('role').eq('email', currentUser).single();
        const roleLabel = document.getElementById('roleLabel');
        if (data && data.role === 'admin') {
            isAdmin = true;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            roleLabel.innerHTML = '<span class="role-badge" style="background:#dc3545;">ç®¡ç†å“¡</span>';
        } else {
            isAdmin = false;
            roleLabel.innerHTML = '<span class="role-badge" style="background:#28a745;">ä¸€èˆ¬äººå“¡</span>';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    // ==========================================
    // ğŸ”¥ æ ¸å¿ƒé‚è¼¯ï¼šè®€å–ä¸¦åˆ†çµ„
    // ==========================================
    async function loadInventory() {
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '<tr><td colspan="7">è¼‰å…¥ä¸­...</td></tr>';
        
        const { data, error } = await supabase
            .from('inventory')
            .select('*')
            .order('expiry_date', { ascending: true }); // å…ˆæŒ‰æ•ˆæœŸæ’ï¼Œç¢ºä¿å¾Œé¢åˆ†çµ„æ™‚ä¹Ÿæ˜¯æœ‰åºçš„

        if(error) { alert("è®€å–å¤±æ•—"); console.error(error); return; }
        
        rawInventory = data || [];
        groupData(rawInventory);
        updateCategoryFilter();
        renderTable();
    }

    // å°‡åŸå§‹è³‡æ–™ä¾ç…§ã€Œå“åã€åˆ†çµ„
    function groupData(data) {
        const groups = {};
        
        data.forEach(item => {
            const name = item.name;
            if (!groups[name]) {
                groups[name] = {
                    name: name,
                    category: item.category,
                    unit: item.unit,
                    totalQty: 0,
                    batches: [] // å­˜æ”¾è©²å“é …çš„æ‰€æœ‰æ‰¹è™Ÿ
                };
            }
            groups[name].totalQty += item.quantity;
            groups[name].batches.push(item);
        });

        // è½‰å›é™£åˆ—ä¸¦æ’åº (åˆ†é¡ -> å“å)
        groupedInventory = Object.values(groups).sort((a, b) => {
            const catA = a.category || 'zzz';
            const catB = b.category || 'zzz';
            return catA.localeCompare(catB) || a.name.localeCompare(b.name);
        });
    }

    function updateCategoryFilter() {
        const select = document.getElementById('categoryFilter');
        const currentVal = select.value;
        const categories = [...new Set(groupedInventory.map(i => i.category || 'æœªåˆ†é¡'))].sort();
        
        select.innerHTML = '<option value="ALL">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>';
        categories.forEach(cat => {
            select.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
        select.value = currentVal;
    }

    function renderTable() {
        const tbody = document.getElementById('stockBody');
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const filterCat = document.getElementById('categoryFilter').value;
        const today = new Date();

        tbody.innerHTML = '';

        const filtered = groupedInventory.filter(group => {
            const matchText = group.name.toLowerCase().includes(searchText);
            const matchCat = filterCat === 'ALL' || group.category === filterCat;
            return matchText && matchCat;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999;">æŸ¥ç„¡è³‡æ–™</td></tr>';
            return;
        }

        filtered.forEach(group => {
            // æ‰¾å‡ºæœ€è¿‘çš„æ•ˆæœŸ (batches å·²ç¶“åœ¨ loadInventory æ™‚æŒ‰æ•ˆæœŸæ’åºäº†ï¼Œæ‰€ä»¥å–ç¬¬ä¸€å€‹æœ‰æ•ˆæ—¥æœŸå³å¯)
            // éæ¿¾æ‰æ²’æœ‰æ•ˆæœŸçš„æ‰¹è™Ÿæ”¾åœ¨æœ€å¾Œ
            const validBatches = group.batches.filter(b => b.expiry_date);
            const nearestBatch = validBatches.length > 0 ? validBatches[0] : null;
            
            let dateDisplay = 'ç„¡æ•ˆæœŸ';
            let statusBadge = '<span class="badge bg-ok">æ­£å¸¸</span>';
            
            if (nearestBatch) {
                dateDisplay = nearestBatch.expiry_date;
                const expDate = new Date(nearestBatch.expiry_date);
                const diffTime = expDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                if (diffDays < 0) {
                    statusBadge = '<span class="badge bg-danger">å·²éæœŸ</span>';
                } else if (diffDays <= 30) {
                    // ğŸ”¥ éœ€æ±‚ï¼šå°æ–¼ä¸€å€‹æœˆç‰¹åˆ¥æ¨™ç¤º
                    statusBadge = '<span class="badge bg-urgent">ğŸš¨ 30å¤©å…§åˆ°æœŸ</span>';
                } else if (diffDays <= 90) {
                    statusBadge = '<span class="badge bg-warn">3å€‹æœˆå…§</span>';
                }
            }

            const tr = document.createElement('tr');
            // å³ä¾¿æ˜¯ 0 ä¹Ÿé¡¯ç¤º
            const qtyClass = group.totalQty === 0 ? 'qty-zero' : 'qty-cell';
            
            tr.innerHTML = `
                <td><span class="badge bg-cat">${group.category || 'æœªåˆ†é¡'}</span></td>
                <td style="font-weight:bold;">${group.name}</td>
                <td class="${qtyClass}">${group.totalQty}</td>
                <td>${group.unit || 'ç½'}</td>
                <td class="date-cell">${dateDisplay}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="action-btn btn-detail" onclick="openDetailModal('${group.name}')">ç®¡ç† / è©³æƒ…</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ==========================================
    // ğŸ”¥ è©³æƒ…è¦–çª— (Detail Modal)
    // ==========================================
    function openDetailModal(itemName) {
        const group = groupedInventory.find(g => g.name === itemName);
        if (!group) return;

        currentDetailItemName = itemName;
        document.getElementById('detailTitle').innerText = `${itemName} - åº«å­˜è©³æƒ…`;
        const list = document.getElementById('batchList');
        list.innerHTML = '';

        // æ’åºæ‰¹è™Ÿï¼šæœ‰æ•ˆæ—¥æœŸè¿‘çš„åœ¨ä¸Šé¢
        const sortedBatches = group.batches.sort((a, b) => {
            if (!a.expiry_date) return 1;
            if (!b.expiry_date) return -1;
            return new Date(a.expiry_date) - new Date(b.expiry_date);
        });

        sortedBatches.forEach(batch => {
            const dateStr = batch.expiry_date || 'ç„¡æ•ˆæœŸ';
            const isZero = batch.quantity === 0;
            const style = isZero ? 'color:#ccc;' : '';

            // åˆ¤æ–·æ˜¯å¦éæœŸ
            let alertIcon = '';
            if (batch.expiry_date) {
                const days = (new Date(batch.expiry_date) - new Date()) / (1000 * 60 * 60 * 24);
                if (days < 0) alertIcon = 'ğŸ’€';
                else if (days < 30) alertIcon = 'ğŸš¨';
            }

            const li = document.createElement('li');
            li.className = 'batch-item';
            li.style = style;
            li.innerHTML = `
                <div class="batch-info">
                    <span style="font-weight:bold; font-family:Consolas;">æ•ˆæœŸï¼š${dateStr} ${alertIcon}</span>
                    <span>æ•¸é‡ï¼š<strong style="font-size:1.1em;">${batch.quantity}</strong> ${group.unit}</span>
                </div>
                <div class="batch-actions">
                    <button class="action-btn btn-in btn-sm" onclick="openSingleAction('IN', '${batch.id}', '${batch.quantity}', '${dateStr}')">è£œ</button>
                    <button class="action-btn btn-out btn-sm" onclick="openSingleAction('OUT', '${batch.id}', '${batch.quantity}', '${dateStr}')">é ˜</button>
                </div>
            `;
            list.appendChild(li);
        });

        document.getElementById('detailModal').style.display = 'flex';
    }

    // åœ¨è©³æƒ…é å…§æ–°å¢æ‰¹è™Ÿ
    async function addNewBatch() {
        const date = document.getElementById('newBatchDate').value;
        const qty = parseInt(document.getElementById('newBatchQty').value);
        if (!qty || qty <= 0) return alert("è«‹è¼¸å…¥æ•¸é‡");

        // å–å¾—ç•¶å‰å“é …çš„å…¶ä»–è³‡è¨Š (åˆ†é¡ã€å–®ä½)
        const group = groupedInventory.find(g => g.name === currentDetailItemName);
        if (!group) return;

        if(!confirm(`ç¢ºå®šè¦æ–°å¢ä¸€æ‰¹æ•ˆæœŸç‚º ${date || 'ç„¡æ•ˆæœŸ'} çš„ ${currentDetailItemName} å—ï¼Ÿ`)) return;

        try {
            const { error } = await supabase.from('inventory').insert([{
                name: group.name,
                category: group.category,
                unit: group.unit,
                expiry_date: date || null,
                quantity: qty
            }]);

            if (error) throw error;
            await logAction('æ–°æ‰¹è™Ÿå…¥åº«', group.name, qty, qty, date, 'æ‰‹å‹•æ–°å¢æ‰¹è™Ÿ');
            
            alert("âœ… æ–°å¢æˆåŠŸ");
            // é‡æ–°è®€å–ä¸¦åˆ·æ–°ä»‹é¢
            await loadInventory();
            openDetailModal(currentDetailItemName); // é‡æ–°æ‰“é–‹è©³æƒ…é 
            document.getElementById('newBatchQty').value = ''; // æ¸…ç©ºè¼¸å…¥
        } catch(e) {
            alert("å¤±æ•—ï¼š" + e.message);
        }
    }

    // ==========================================
    // å–®ä¸€æ“ä½œ (è£œè²¨/é ˜ç”¨)
    // ==========================================
    function openSingleAction(type, id, currentQty, dateStr) {
        document.getElementById('actionModal').style.display = 'flex';
        document.getElementById('actId').value = id;
        document.getElementById('actType').value = type;
        document.getElementById('actCurrentQty').value = currentQty;
        document.getElementById('actDate').value = dateStr;
        document.getElementById('actName').value = currentDetailItemName;
        document.getElementById('actQty').value = '';
        document.getElementById('actNote').value = '';

        const title = document.getElementById('actionTitle');
        const btn = document.getElementById('confirmBtn');

        if (type === 'IN') {
            title.innerText = "â• è£œè²¨ (å¢åŠ åº«å­˜)";
            btn.innerText = "ç¢ºèªå…¥åº«";
            btn.className = "action-btn btn-in";
        } else {
            title.innerText = "â– é ˜ç”¨ (æ‰£é™¤åº«å­˜)";
            btn.innerText = "ç¢ºèªé ˜ç”¨";
            btn.className = "action-btn btn-out";
        }
    }

    async function submitAction() {
        const id = document.getElementById('actId').value;
        const type = document.getElementById('actType').value;
        const inputQty = parseInt(document.getElementById('actQty').value);
        const currentQty = parseInt(document.getElementById('actCurrentQty').value);
        const note = document.getElementById('actNote').value;
        const name = document.getElementById('actName').value;
        const date = document.getElementById('actDate').value;

        if (!inputQty || inputQty <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡");

        let newQty = currentQty;
        if (type === 'IN') newQty += inputQty;
        else {
            if (currentQty < inputQty) return alert("åº«å­˜ä¸è¶³ï¼");
            newQty -= inputQty;
        }

        try {
            // ğŸ”¥ é‡é»ï¼šå³ä½¿è®Šæˆ 0 ä¹Ÿä¸åˆªé™¤ï¼Œåƒ…æ›´æ–°ç‚º 0
            const { error } = await supabase.from('inventory').update({ quantity: newQty }).eq('id', id);
            if (error) throw error;

            await logAction(type === 'IN' ? 'è£œè²¨' : 'é ˜ç”¨', name, inputQty, newQty, date, note);
            
            alert("âœ… æ“ä½œæˆåŠŸ");
            closeModal('actionModal');
            await loadInventory(); // é‡æ–°è®€å–
            
            // å¦‚æœæ˜¯åœ¨è©³æƒ…é æ“ä½œçš„ï¼Œåˆ·æ–°è©³æƒ…é 
            if (document.getElementById('detailModal').style.display !== 'none') {
                openDetailModal(currentDetailItemName);
            }
            loadLogs();

        } catch(e) {
            alert("æ“ä½œå¤±æ•—: " + e.message);
        }
    }

    // ==========================================
    // æ–°å¢å…¨æ–°å•†å“ (è³‡æ–™åº«å®Œå…¨æ²’æœ‰çš„)
    // ==========================================
    function openNewItemModal() {
        document.getElementById('newItemModal').style.display = 'flex';
    }

    async function submitNewItem() {
        const name = document.getElementById('newItemName').value.trim();
        const cat = document.getElementById('newCat').value.trim();
        const unit = document.getElementById('newUnit').value.trim();
        const date = document.getElementById('newItemDate').value;
        const qty = parseInt(document.getElementById('newItemQty').value);

        if(!name) return alert("å“åå¿…å¡«");

        try {
            const { error } = await supabase.from('inventory').insert([{
                name: name,
                category: cat || 'æœªåˆ†é¡',
                unit: unit || 'ç½',
                expiry_date: date || null,
                quantity: qty || 0 // å…è¨±åˆå§‹ç‚º 0
            }]);

            if(error) throw error;
            await logAction('å»ºæª”', name, qty, qty, date, 'æ–°å¢å“é …è³‡æ–™');
            
            alert("âœ… æ–°å¢æˆåŠŸ");
            closeModal('newItemModal');
            loadInventory();
        } catch(e) {
            alert("æ–°å¢å¤±æ•—: " + e.message);
        }
    }

    async function logAction(action, name, change, final, expiry, note) {
        await supabase.from('inventory_logs').insert([{
            product_name: name,
            action_type: action,
            change_qty: change,
            final_qty: final,
            operator: currentUser,
            note: `æ•ˆæœŸ:${expiry || '-'} / ${note}`
        }]);
    }

    // ==========================================
    // åŒ¯å…¥èˆ‡ä¸‹è¼‰åŠŸèƒ½
    // ==========================================
    async function handleExcelImport(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        if (!confirm("âš ï¸ æ³¨æ„ï¼šç³»çµ±å°‡ä¾æ“šã€Œå“å+æ•ˆæœŸã€åŒ¯å…¥è³‡æ–™ã€‚\nè‹¥è³‡æ–™åº«ç„¡æ­¤æ•ˆæœŸï¼Œå°‡è‡ªå‹•æ–°å¢ä¸€æ‰¹è™Ÿã€‚\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ")) {
            inputElement.value = ''; return;
        }

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                let count = 0;
                for (let row of jsonData) {
                    let name = row['å“å'];
                    let qty = row['æ•¸é‡'] || row['åº«å­˜æ•¸é‡'];
                    let expiry = formatExcelDate(row['æœ‰æ•ˆæ—¥æœŸ']);
                    let cat = row['åˆ†é¡'];
                    let unit = row['å–®ä½'];

                    if(!name || (qty === undefined)) continue;

                    // æª¢æŸ¥æ˜¯å¦å­˜åœ¨åŒå“å+åŒæ•ˆæœŸ
                    let query = supabase.from('inventory').select('id').eq('name', name);
                    if(expiry) query = query.eq('expiry_date', expiry);
                    else query = query.is('expiry_date', null);

                    const { data: existing } = await query;

                    if(existing && existing.length > 0) {
                        // æ›´æ–°
                        await supabase.from('inventory').update({ quantity: qty, category: cat, unit: unit }).eq('id', existing[0].id);
                    } else {
                        // æ–°å¢
                        await supabase.from('inventory').insert([{
                            name: name, quantity: qty, category: cat || 'æœªåˆ†é¡', unit: unit || 'ç½', expiry_date: expiry
                        }]);
                    }
                    count++;
                }
                alert(`âœ… æˆåŠŸè™•ç† ${count} ç­†è³‡æ–™`);
                inputElement.value = '';
                loadInventory();
            } catch (err) {
                alert("åŒ¯å…¥å¤±æ•—: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function formatExcelDate(excelDate) {
        if (!excelDate) return null;
        if (typeof excelDate === 'string') return excelDate.trim(); 
        if (typeof excelDate === 'number') {
            const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
            return date.toISOString().split('T')[0];
        }
        return null;
    }

    function downloadBlankForm() {
        if(groupedInventory.length === 0) return alert("ç„¡è³‡æ–™");
        // ç‚ºäº†è®“ç›¤é»è¡¨å¥½å¡«ï¼Œæˆ‘å€‘æŠŠæ‰€æœ‰ç¾æœ‰çš„ã€Œæ‰¹è™Ÿã€éƒ½åˆ—å‡ºä¾†
        const exportData = rawInventory.map(item => ({
            "åˆ†é¡": item.category,
            "å“å": item.name,
            "åº«å­˜æ•¸é‡": "", // ç©ºç™½
            "å–®ä½": item.unit,
            "æœ‰æ•ˆæ—¥æœŸ": item.expiry_date || ""
        }));
        
        // æ’åº
        exportData.sort((a,b) => a['åˆ†é¡'].localeCompare(b['åˆ†é¡']) || a['å“å'].localeCompare(b['å“å']));

        const ws = XLSX.utils.json_to_sheet(exportData);
        ws['!cols'] = [{wch:15}, {wch:25}, {wch:10}, {wch:8}, {wch:15}];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ç›¤é»å–®");
        XLSX.writeFile(wb, `ç©ºç™½ç›¤é»è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function exportStock() {
        // ä¸‹è¼‰ç¸½è¡¨ï¼šåˆ—å‡ºæ‰€æœ‰æ‰¹è™Ÿ
        const exportData = rawInventory.map(item => ({
            "åˆ†é¡": item.category,
            "å“å": item.name,
            "åº«å­˜": item.quantity,
            "å–®ä½": item.unit,
            "æ•ˆæœŸ": item.expiry_date || "ç„¡",
            "ç‹€æ…‹": getStatusText(item.expiry_date)
        }));
        exportData.sort((a,b) => a['åˆ†é¡'].localeCompare(b['åˆ†é¡']) || a['å“å'].localeCompare(b['å“å']));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "åº«å­˜æ˜ç´°");
        XLSX.writeFile(wb, `åº«å­˜ç¸½è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function getStatusText(dateStr) {
        if(!dateStr) return 'æ­£å¸¸';
        const days = (new Date(dateStr) - new Date()) / (1000*60*60*24);
        if(days < 0) return 'å·²éæœŸ';
        if(days < 30) return '30å¤©å…§åˆ°æœŸ';
        if(days < 90) return '3å€‹æœˆå…§';
        return 'æ­£å¸¸';
    }

    async function exportLogs() {
        const { data } = await supabase.from('inventory_logs').select('*').order('created_at', {ascending:false}).limit(1000);
        if(!data || data.length === 0) return alert("ç„¡ç´€éŒ„");
        
        const exportData = data.map(log => ({
            "æ™‚é–“": new Date(log.created_at).toLocaleString('zh-TW'),
            "å‹•ä½œ": log.action_type,
            "å“å": log.product_name,
            "ç•°å‹•": log.change_qty,
            "çµé¤˜": log.final_qty,
            "å‚™è¨»": log.note,
            "äººå“¡": log.operator
        }));
        
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ç´€éŒ„");
        XLSX.writeFile(wb, `ç•°å‹•ç´€éŒ„_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    async function loadLogs() {
        const tbody = document.getElementById('logBody');
        const { data } = await supabase.from('inventory_logs').select('*').order('created_at', { ascending: false }).limit(50);
        if(!data) return;
        tbody.innerHTML = '';
        data.forEach(log => {
            const dateStr = new Date(log.created_at).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
            const color = log.action_type.includes('å…¥') || log.action_type.includes('å¢') || log.action_type.includes('è£œ') ? 'green' : 'red';
            tbody.innerHTML += `<tr><td>${dateStr}</td><td style="color:${color};font-weight:bold;">${log.action_type}</td><td>${log.product_name}</td><td>${log.change_qty}</td><td>${log.note.split('/')[0]||''}</td><td>${log.operator}</td><td>${log.note.split('/')[1]||''}</td></tr>`;
        });
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>

</body>
</html>
