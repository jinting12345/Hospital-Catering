<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿé¤Šå“åº«å­˜ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* é ‚éƒ¨å°èˆª */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .back-btn { text-decoration: none; color: #666; font-weight: bold; }
        h2 { margin: 0; color: #2c3e50; }

        /* åˆ†é æ¨™ç±¤ */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { padding: 10px 20px; border: none; background: #e0e0e0; cursor: pointer; border-radius: 5px 5px 0 0; font-weight: bold; color: #555; }
        .tab-btn.active { background: #1a73e8; color: white; }

        /* å…§å®¹å€å¡Š */
        .tab-content { display: none; background: white; padding: 20px; border-radius: 0 5px 5px 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-content.active { display: block; }

        /* æœå°‹èˆ‡æ§åˆ¶ */
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .action-btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-in { background: #28a745; } /* å…¥åº«ç¶ è‰² */
        .btn-out { background: #dc3545; } /* é ˜ç”¨ç´…è‰² */
        .btn-edit { background: #6c757d; } /* ç·¨è¼¯ç°è‰² */
        .btn-import { background: #17a2b8; } /* åŒ¯å…¥è—è‰² */

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #444; font-weight: bold; white-space: nowrap; }
        tr:hover { background-color: #f1f5f9; }

        /* ç‹€æ…‹ç‡ˆè™Ÿ */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; color: white; font-weight: bold; }
        .bg-ok { background: #28a745; }
        .bg-warn { background: #ffc107; color: #333; }
        .bg-danger { background: #dc3545; }

        /* å½ˆè·³è¦–çª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
        <h2>ğŸ“¦ ç‡Ÿé¤Šå“åº«å­˜ç®¡ç†</h2>
        <div style="font-size:14px; color:#666;" id="userInfo">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- åˆ†é åˆ‡æ› -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('stock')">ğŸ“Š å³æ™‚åº«å­˜</button>
        <button class="tab-btn" onclick="switchTab('logs')">ğŸ“ é€²å‡ºç´€éŒ„</button>
    </div>

    <!-- åˆ†é  1: å³æ™‚åº«å­˜ -->
    <div id="stock" class="tab-content active">
        <div class="controls">
            <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å“å..." onkeyup="filterTable()">
            <button class="action-btn btn-import" onclick="location.href='upload_inventory.html'">ğŸ“‚ ExcelåŒ¯å…¥</button>
            <button class="action-btn btn-in" style="background:#007bff;" onclick="openAddModal()">â• æ–°å¢å“é …</button>
        </div>
        
        <div style="overflow-x:auto;">
            <table id="stockTable">
                <thead>
                    <tr>
                        <th>å“å</th>
                        <th>åˆ†é¡</th>
                        <th>åº«å­˜é‡</th>
                        <th>å–®ä½</th>
                        <th>æœ‰æ•ˆæ—¥æœŸ</th>
                        <th>ç‹€æ…‹</th>
                        <th style="width:180px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="stockBody">
                    <!-- JS ç”Ÿæˆå…§å®¹ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- åˆ†é  2: é€²å‡ºç´€éŒ„ -->
    <div id="logs" class="tab-content">
        <h3>æœ€è¿‘ 50 ç­†ç•°å‹•ç´€éŒ„</h3>
        <table id="logTable">
            <thead>
                <tr>
                    <th>æ™‚é–“</th>
                    <th>å‹•ä½œ</th>
                    <th>å“å</th>
                    <th>æ•¸é‡</th>
                    <th>çµé¤˜</th>
                    <th>æ“ä½œäºº</th>
                    <th>å‚™è¨»</th>
                </tr>
            </thead>
            <tbody id="logBody">
                <!-- JS ç”Ÿæˆå…§å®¹ -->
            </tbody>
        </table>
    </div>
</div>

<!-- æ“ä½œè¦–çª— (é ˜ç”¨/å…¥åº«) -->
<div id="actionModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">åŸ·è¡Œå‹•ä½œ</h3>
        <div class="form-group">
            <label>å“å</label>
            <input type="text" id="actName" disabled style="background:#eee;">
        </div>
        <div class="form-group">
            <label>æ•¸é‡</label>
            <input type="number" id="actQty" placeholder="è«‹è¼¸å…¥æ•¸é‡">
        </div>
        <div class="form-group">
            <label>å‚™è¨» (é¸å¡«)</label>
            <input type="text" id="actNote" placeholder="ä¾‹å¦‚: ç—…æˆ¿é ˜ç”¨ã€å» å•†é€²è²¨">
        </div>
        
        <!-- éš±è—æ¬„ä½ -->
        <input type="hidden" id="actId">
        <input type="hidden" id="actType"> <!-- IN æˆ– OUT -->
        <input type="hidden" id="actCurrentQty">

        <div class="modal-footer">
            <button class="action-btn" style="background:#666;" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="action-btn btn-in" id="confirmBtn" onclick="submitAction()">ç¢ºèª</button>
        </div>
    </div>
</div>

<script>
    function cleanString(str) { return str.replace(/[^\x20-\x7E]/g, '').trim(); }
    // â˜…â˜…â˜… è«‹æ›¿æ› â˜…â˜…â˜…
    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

    let inventoryData = [];
    let currentUser = '';

    // åˆå§‹åŒ–
    (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if(!session) window.location.href = 'index.html';
        currentUser = session.user.email;
        document.getElementById('userInfo').innerText = currentUser;
        
        loadInventory();
        loadLogs();
    })();

    // åˆ‡æ›åˆ†é 
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        if(tabName === 'logs') loadLogs();
    }

    // 1. è¼‰å…¥åº«å­˜
    async function loadInventory() {
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '<tr><td colspan="7">è¼‰å…¥ä¸­...</td></tr>';

        const { data, error } = await supabase.from('inventory').select('*').order('name');
        if(error) return alert('è¼‰å…¥å¤±æ•—');
        
        inventoryData = data;
        renderTable(data);
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable(data) {
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '';

        const today = new Date();
        const warningDate = new Date();
        warningDate.setDate(today.getDate() + 90); // 90å¤©å…§éæœŸäº®é»ƒç‡ˆ

        data.forEach(item => {
            // åˆ¤æ–·æ•ˆæœŸç‡ˆè™Ÿ
            let statusBadge = '<span class="badge bg-ok">æ­£å¸¸</span>';
            if(item.expiry_date) {
                const exp = new Date(item.expiry_date);
                if(exp < today) statusBadge = '<span class="badge bg-danger">å·²éæœŸ</span>';
                else if(exp < warningDate) statusBadge = '<span class="badge bg-warn">å¿«éæœŸ</span>';
            } else {
                statusBadge = '<span style="color:#999; font-size:12px;">ç„¡æ•ˆæœŸ</span>';
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold;">${item.name}</td>
                <td>${item.category || '-'}</td>
                <td style="font-size:1.1em; color:#1a73e8; font-weight:bold;">${item.quantity}</td>
                <td>${item.unit || 'ç½'}</td>
                <td>${item.expiry_date || '-'}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="action-btn btn-in" onclick="openAction('IN', '${item.id}')">å…¥åº«</button>
                    <button class="action-btn btn-out" onclick="openAction('OUT', '${item.id}')">é ˜ç”¨</button>
                </td>
            `;
            tbody.innerHTML += tr.outerHTML;
        });
    }

    // æœå°‹
    function filterTable() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = inventoryData.filter(i => i.name.toLowerCase().includes(term));
        renderTable(filtered);
    }

    // 2. é–‹å•Ÿæ“ä½œè¦–çª— (å…¥åº«/é ˜ç”¨)
    function openAction(type, id) {
        const item = inventoryData.find(i => i.id === id);
        if(!item) return;

        document.getElementById('actionModal').style.display = 'flex';
        document.getElementById('actId').value = id;
        document.getElementById('actType').value = type;
        document.getElementById('actCurrentQty').value = item.quantity;
        document.getElementById('actName').value = item.name;
        document.getElementById('actQty').value = '';
        document.getElementById('actNote').value = '';

        const btn = document.getElementById('confirmBtn');
        const title = document.getElementById('modalTitle');
        
        if(type === 'IN') {
            title.innerText = `â• å…¥åº«ï¼š${item.name}`;
            btn.innerText = 'ç¢ºèªå…¥åº«';
            btn.className = 'action-btn btn-in';
        } else {
            title.innerText = `â– é ˜ç”¨ï¼š${item.name}`;
            btn.innerText = 'ç¢ºèªé ˜ç”¨';
            btn.className = 'action-btn btn-out';
        }
    }

    // 3. æäº¤ç•°å‹•
    async function submitAction() {
        const id = document.getElementById('actId').value;
        const type = document.getElementById('actType').value;
        const name = document.getElementById('actName').value;
        const qtyInput = parseInt(document.getElementById('actQty').value);
        const currentQty = parseInt(document.getElementById('actCurrentQty').value);
        const note = document.getElementById('actNote').value;

        if(!qtyInput || qtyInput <= 0) return alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡');
        
        let newQty = currentQty;
        if(type === 'IN') newQty += qtyInput;
        else {
            if(currentQty < qtyInput) return alert('åº«å­˜ä¸è¶³ï¼ç„¡æ³•é ˜ç”¨ã€‚');
            newQty -= qtyInput;
        }

        const btn = document.getElementById('confirmBtn');
        btn.disabled = true; btn.innerText = 'è™•ç†ä¸­...';

        try {
            // A. æ›´æ–°åº«å­˜è¡¨
            const { error: updateErr } = await supabase
                .from('inventory')
                .update({ quantity: newQty })
                .eq('id', id);
            if(updateErr) throw updateErr;

            // B. å¯«å…¥ç´€éŒ„è¡¨ (æµæ°´å¸³)
            const { error: logErr } = await supabase.from('inventory_logs').insert([{
                product_name: name,
                action_type: type === 'IN' ? 'å…¥åº«' : 'é ˜ç”¨',
                change_qty: qtyInput,
                final_qty: newQty,
                operator: currentUser,
                note: note
            }]);
            if(logErr) console.error('ç´€éŒ„å¯«å…¥å¤±æ•—', logErr);

            alert('âœ… æ“ä½œæˆåŠŸ');
            closeModal();
            loadInventory(); // é‡æ–°æ•´ç†åˆ—è¡¨

        } catch(e) {
            alert('âŒ å¤±æ•—: ' + e.message);
        } finally {
            btn.disabled = false;
        }
    }

    // 4. è¼‰å…¥æ­·å²ç´€éŒ„
    async function loadLogs() {
        const tbody = document.getElementById('logBody');
        
        const { data, error } = await supabase
            .from('inventory_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);

        if(error) return;

        tbody.innerHTML = '';
        data.forEach(log => {
            const dateStr = new Date(log.created_at).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
            const color = log.action_type === 'å…¥åº«' ? 'green' : 'red';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-size:12px; color:#666;">${dateStr}</td>
                <td style="color:${color}; font-weight:bold;">${log.action_type}</td>
                <td>${log.product_name}</td>
                <td style="font-weight:bold;">${log.change_qty}</td>
                <td style="color:#888;">${log.final_qty}</td>
                <td style="font-size:12px;">${log.operator}</td>
                <td style="font-size:12px; color:#555;">${log.note || '-'}</td>
            `;
            tbody.innerHTML += tr.outerHTML;
        });
    }

    function closeModal() { document.getElementById('actionModal').style.display = 'none'; }
    function openAddModal() { location.href = 'inventory.html'; } // å€Ÿç”¨èˆŠä»‹é¢ä¾†æ–°å¢å“é …ï¼Œæˆ–æ˜¯æ•´åˆé€²ä¾†
</script>

</body>
</html>
