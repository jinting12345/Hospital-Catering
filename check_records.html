<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥çœ‹ç…§ç‰‡ä¸Šå‚³ç´€éŒ„ & ç®¡ç†</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f8f9fa; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* é ‚éƒ¨è³‡è¨Šå¡ */
        .info-card { background: linear-gradient(135deg, #1e88e5, #1565c0); color: white; padding: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .info-item h3 { margin: 0 0 5px 0; font-size: 0.9em; opacity: 0.9; }
        /* èª¿æ•´è³‡è¨Šå¡æ•¸å­—æ¨£å¼ï¼ŒåŒ…å«é ä¼°å¤©æ•¸ */
        .info-number { font-size: 1.8em; font-weight: bold; display: block; }
        .info-sub { font-size: 0.8em; color: #ffeb3b; margin-top: 5px; font-weight: normal; }

        /* æ§åˆ¶åˆ— */
        .controls { background: white; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        select, input[type="month"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .btn { border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; color: white; }
        .btn-search { background-color: #1e88e5; }
        .btn-search:hover { background-color: #1565c0; }
        .btn-download { background-color: #27ae60; margin-left: auto; }
        .btn-download:hover { background-color: #219150; }
        .btn-back { background-color: #7f8c8d; text-decoration: none; display: inline-block; padding: 8px 16px; border-radius: 4px; color: white; font-weight: bold; font-size: 14px;}

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: bold; }
        tr:hover { background-color: #f1f2f6; }
        
        /* ç‹€æ…‹åœ–ç¤º (å¯é»æ“Š) */
        .status-ok { color: #27ae60; font-size: 1.4em; cursor: pointer; transition: transform 0.2s; display: inline-block; }
        .status-ok:hover { transform: scale(1.2); text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .status-no { color: #ffadad; font-size: 1.2em; cursor: default; } 
        
        /* ğŸ”¥ ä¿®æ”¹ï¼šé€±æœ«æ”¹ç‚ºæ·¡é»ƒè‰²åº• */
        .weekend { background-color: #fff3cd; } 
        
        /* ğŸ”¥ ä¿®æ”¹ï¼šæ—¥æœŸæ¨£å¼çµ±ä¸€ (æ·±ç°è‰²) */
        .date-cell { color: #333; font-weight: bold; }

        .staff-name { font-weight: bold; color: #2c3e50; font-size: 1.05em; }
        .staff-missing { color: #95a5a6; font-style: italic; font-size: 0.9em; }

        /* è®€å–é®ç½© */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 999; font-size: 1.5em; color: #1e88e5; font-weight: bold; flex-direction: column; }

        /* åœ–ç‰‡é è¦½ Modal */
        .modal { display: none; position: fixed; z-index: 1000; padding-top: 50px; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); }
        .modal-content { margin: auto; display: block; max-width: 90%; max-height: 85vh; border-radius: 8px; box-shadow: 0 4px 15px rgba(255,255,255,0.1); }
        .close-modal { position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .close-modal:hover { color: #bbb; text-decoration: none; cursor: pointer; }
        .modal-caption { margin: auto; display: block; width: 80%; text-align: center; color: #ccc; padding: 10px 0; height: 150px; font-size: 1.2em; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div id="loading-text">è³‡æ–™è®€å–ä¸­...</div>
</div>

<div id="imageModal" class="modal" onclick="closeImageModal()">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImg" onclick="event.stopPropagation()">
    <div id="caption" class="modal-caption"></div>
</div>

<div class="container">
    <div style="margin-bottom: 10px;"><a href="menu.html" class="btn-back">â¬… å›é¸å–®</a></div>
    
    <div class="info-card">
        <div class="info-item">
            <h3>é›²ç«¯ç©ºé–“ä½¿ç”¨é‡ (1000MB)</h3>
            <span id="storage-usage" class="info-number">è¨ˆç®—ä¸­...</span>
            <span id="storage-days" class="info-sub"></span>
        </div>
        <div class="info-item" style="text-align: right;">
            <h3>æœ¬æœˆç¸½ç…§ç‰‡æ•¸</h3>
            <span id="total-photos" class="info-number">0 å¼µ</span>
        </div>
    </div>

    <div class="controls">
        <select id="view-mode"><option value="month">æ¯æœˆæª¢è¦–</option></select>
        <input type="month" id="month-picker">
        <button class="btn btn-search" onclick="fetchData()">ğŸ” æŸ¥è©¢ç´€éŒ„</button>
        <button class="btn btn-download" onclick="handleDownloadAndClear()">ğŸ“¥ ä¸‹è¼‰é¸å–æ—¥æœŸä¸¦æ¸…é™¤è³‡æ–™</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th width="50"><input type="checkbox" id="check-all" onchange="toggleAll(this)"></th>
                    <th width="120">æ—¥æœŸ</th>
                    <th width="150">å€¼ç­äººå“¡</th> <th colspan="2">æ—©é¤</th> <th colspan="2">åˆé¤</th> <th colspan="2">æ™šé¤</th>
                </tr>
                <tr>
                    <th></th><th></th><th></th>
                    <th style="font-size:0.8em;color:#666;">ç—…æ‚£</th><th style="font-size:0.8em;color:#666;">è­·å®¶</th>
                    <th style="font-size:0.8em;color:#666;">ç—…æ‚£</th><th style="font-size:0.8em;color:#666;">è­·å®¶</th>
                    <th style="font-size:0.8em;color:#666;">ç—…æ‚£</th><th style="font-size:0.8em;color:#666;">è­·å®¶</th>
                </tr>
            </thead>
            <tbody id="record-body"></tbody>
        </table>
    </div>
</div>

<script>
    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    function cleanString(str) { return str.replace(/[^\x20-\x7E]/g, '').trim(); }
    const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));
    let currentRecords = []; 

    const weekDays = ['(æ—¥)', '(ä¸€)', '(äºŒ)', '(ä¸‰)', '(å››)', '(äº”)', '(å…­)'];

    window.onload = function() {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        document.getElementById('month-picker').value = `${yyyy}-${mm}`;
        checkSession();
    };

    async function checkSession() {
        const { data } = await supabase.auth.getSession();
        if(!data.session) { alert("è«‹å…ˆç™»å…¥"); window.location.href = 'index.html'; } 
        else { fetchData(); }
    }

    async function fetchData() {
        showLoading(true, "è®€å–ç­è¡¨èˆ‡ç…§ç‰‡ç´€éŒ„...");
        const monthVal = document.getElementById('month-picker').value; 
        const [year, month] = monthVal.split('-');

        const startDate = `${year}-${month}-01`;
        const lastDay = new Date(year, month, 0).getDate(); 
        const endDate = `${year}-${month}-${lastDay}`;

        const { data: scheduleData, error: scheError } = await supabase
            .from('duty_roster')
            .select('date, staff_name')
            .gte('date', startDate)
            .lte('date', endDate);

        if (scheError) {
            console.error(scheError); alert("è®€å–ç­è¡¨å¤±æ•—: " + scheError.message); showLoading(false); return;
        }

        const { data: recordData, error: recError } = await supabase
            .from('meal_records')
            .select('*')
            .gte('record_date', startDate)
            .lte('record_date', endDate);

        if (recError) {
            console.error(recError); alert("è®€å–ç´€éŒ„å¤±æ•—: " + recError.message); showLoading(false); return;
        }

        currentRecords = recordData; 
        renderTable(year, month, scheduleData, recordData);
        updateStats(recordData);
        showLoading(false);
    }

    function renderTable(year, month, schedules, records) {
        const tbody = document.getElementById('record-body');
        tbody.innerHTML = '';
        const daysInMonth = new Date(year, month, 0).getDate(); 
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${month}-${String(day).padStart(2, '0')}`;
            const dateObj = new Date(dateStr);
            const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
            
            const weekStr = weekDays[dateObj.getDay()]; 
            const displayDate = `${month}/${day} <span style="font-size:0.9em; color:#666;">${weekStr}</span>`;

            const daySchedules = schedules.filter(s => s.date === dateStr);
            const allNames = daySchedules.map(s => s.staff_name);
            const uniqueNames = [...new Set(allNames)]; 
            const staffNames = uniqueNames.join(' / ');
            const displayStaff = staffNames || '<span class="staff-missing">æœªæ’ç­</span>';

            const dayRecords = records.filter(r => r.record_date === dateStr);
            
            const checkStatus = (mType, tType) => {
                const found = dayRecords.find(r => r.meal_type === mType && r.target_type === tType);
                if (found) {
                    return `<span class="status-ok" onclick="viewPhoto('${found.photo_path}', '${dateStr} ${translate(mType)} ${translate(tType)}')">âœ…</span>`;
                } else {
                    return `<span class="status-no">âŒ</span>`;
                }
            };

            const row = `
                <tr class="${isWeekend ? 'weekend' : ''}">
                    <td><input type="checkbox" class="date-checkbox" value="${dateStr}"></td>
                    <td class="date-cell">${displayDate}</td> <td class="staff-name">${displayStaff}</td> 
                    <td>${checkStatus('breakfast', 'patient')}</td><td>${checkStatus('breakfast', 'nursing')}</td>
                    <td>${checkStatus('lunch', 'patient')}</td><td>${checkStatus('lunch', 'nursing')}</td>
                    <td>${checkStatus('dinner', 'patient')}</td><td>${checkStatus('dinner', 'nursing')}</td>
                </tr>`;
            tbody.innerHTML += row;
        }
    }

    async function viewPhoto(path, captionText) {
        showLoading(true, "è¼‰å…¥ç…§ç‰‡ä¸­...");
        try {
            const { data, error } = await supabase.storage.from('private_photos').createSignedUrl(path, 60);
            if (error) throw error;

            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImg');
            const caption = document.getElementById('caption');

            modal.style.display = "block";
            modalImg.src = data.signedUrl;
            caption.innerText = captionText;
        } catch (err) {
            alert("ç„¡æ³•è¼‰å…¥ç…§ç‰‡: " + err.message);
        } finally {
            showLoading(false);
        }
    }

    function closeImageModal() {
        document.getElementById('imageModal').style.display = "none";
    }

    async function handleDownloadAndClear() {
        const checkboxes = document.querySelectorAll('.date-checkbox:checked');
        if (checkboxes.length === 0) { alert("è«‹å…ˆå‹¾é¸æ—¥æœŸ"); return; }
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) { alert("è«‹å…ˆç™»å…¥"); return; }
        if(!confirm(`âš ï¸ æ³¨æ„ï¼šæ­¤æ“ä½œéœ€è¦ç®¡ç†å“¡æ¬Šé™ã€‚\n\nå³å°‡ä¸‹è¼‰ä¸¦ã€Œæ°¸ä¹…åˆªé™¤ã€é¸å–æ—¥æœŸçš„ç…§ç‰‡ã€‚\nç¢ºå®šå—ï¼Ÿ`)) return;

        showLoading(true, "è™•ç†ä¸­...");
        const selectedDates = Array.from(checkboxes).map(cb => cb.value);
        const targetRecords = currentRecords.filter(r => selectedDates.includes(r.record_date));

        if (targetRecords.length === 0) { alert("é¸å–çš„æ—¥æœŸä¸­æ²’æœ‰ç…§ç‰‡è³‡æ–™ï¼"); showLoading(false); return; }

        try {
            const zip = new JSZip();
            const folder = zip.folder(`å‚™ä»½_${selectedDates[0]}_to_${selectedDates[selectedDates.length-1]}`);
            const downloadPromises = targetRecords.map(async (record) => {
                const { data, error } = await supabase.storage.from('private_photos').download(record.photo_path);
                if (!error && data) {
                    const filename = `${record.record_date}_${translate(record.meal_type)}_${translate(record.target_type)}.jpg`;
                    folder.file(filename, data);
                }
            });
            await Promise.all(downloadPromises);
            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, `ç…§ç‰‡å‚™ä»½_${new Date().toISOString().slice(0,10)}.zip`);

            const pathsToRemove = targetRecords.map(r => r.photo_path);
            if (pathsToRemove.length > 0) await supabase.storage.from('private_photos').remove(pathsToRemove);
            const idsToRemove = targetRecords.map(r => r.id);
            const { error: delError } = await supabase.from('meal_records').delete().in('id', idsToRemove);
            if (delError) throw delError;

            alert("âœ… å®Œæˆï¼ç…§ç‰‡å·²ä¸‹è¼‰ä¸¦æ¸…é™¤ã€‚");
            fetchData();
        } catch (err) { console.error(err); alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message); } 
        finally { showLoading(false); }
    }

    function toggleAll(source) { document.querySelectorAll('.date-checkbox').forEach(cb => cb.checked = source.checked); }
    function showLoading(show, text) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; if(text) document.getElementById('loading-text').innerText = text; }
    
    // ğŸ”¥ ä¿®æ”¹ï¼šæ–°å¢å‰©é¤˜å¤©æ•¸è¨ˆç®—
    function updateStats(data) { 
        // 1. è¨ˆç®—å·²ç”¨å®¹é‡
        const usedSpace = (data.length * 0.5); // å‡è¨­æ¯å¼µ 0.5MB
        const totalSpace = 1000; // ç¸½å®¹é‡ 1000MB
        document.getElementById('total-photos').innerText = data.length + " å¼µ"; 
        document.getElementById('storage-usage').innerText = `${usedSpace.toFixed(1)} MB / ${totalSpace} MB`; 
        
        // 2. è¨ˆç®—å‰©é¤˜å¤©æ•¸ (é ä¼°æ¯æ—¥ 3MB: æ—©ä¸­æ™šå„2å¼µ=6å¼µ * 0.5MB)
        const dailyUsage = 3; 
        const remainingSpace = totalSpace - usedSpace;
        const daysLeft = Math.floor(remainingSpace / dailyUsage);

        const daysLabel = document.getElementById('storage-days');
        if (daysLeft > 100) {
            daysLabel.innerHTML = `ğŸŒŸ ç©ºé–“å……è¶³ï¼Œç´„é‚„å¯ä½¿ç”¨ <strong>${daysLeft}</strong> å¤©`;
            daysLabel.style.color = "#ffeb3b"; // é»ƒè‰²
        } else if (daysLeft > 30) {
            daysLabel.innerHTML = `âš ï¸ ç©ºé–“å°šå¯ï¼Œç´„é‚„å¯ä½¿ç”¨ <strong>${daysLeft}</strong> å¤©`;
            daysLabel.style.color = "#fff"; 
        } else {
            daysLabel.innerHTML = `ğŸš¨ ç©ºé–“å³å°‡ä¸è¶³ï¼ç´„å‰© <strong>${daysLeft}</strong> å¤©`;
            daysLabel.style.color = "#ff8a80"; // ç´…è‰²è­¦ç¤º
        }
    }
    
    function translate(eng) { 
        const map = { 
            'breakfast': 'æ—©é¤', 
            'lunch': 'åˆé¤', 
            'dinner': 'æ™šé¤', 
            'patient': 'ç—…æ‚£', 
            'nursing': 'è­·å®¶', 
            'care': 'è­·å®¶' 
        }; 
        return map[eng] || eng; 
    }
</script>
</body>
</html>
