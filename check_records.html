<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥çœ‹ç…§ç‰‡ä¸Šå‚³ç´€éŒ„ & ç®¡ç†</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f8f9fa; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .info-card { background: linear-gradient(135deg, #1e88e5, #1565c0); color: white; padding: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .info-item h3 { margin: 0 0 5px 0; font-size: 0.9em; opacity: 0.9; }
        .info-number { font-size: 1.8em; font-weight: bold; display: block; }
        .info-sub { font-size: 0.8em; color: #ffeb3b; margin-top: 5px; font-weight: normal; }

        .controls { background: white; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        select, input[type="month"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .btn { border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; color: white; }
        .btn-search { background-color: #1e88e5; }
        .btn-search:hover { background-color: #1565c0; }
        
        .btn-download { background-color: #27ae60; margin-left: auto; }
        .btn-download:hover { background-color: #219150; }

        .btn-delete { background-color: #e74c3c; display: none; } 
        .btn-delete:hover { background-color: #c0392b; }

        .btn-back { background-color: #7f8c8d; text-decoration: none; display: inline-block; padding: 8px 16px; border-radius: 4px; color: white; font-weight: bold; font-size: 14px;}

        .table-container { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: bold; }
        tr:hover { background-color: #f1f2f6; }
        
        .status-ok { color: #27ae60; font-size: 1.4em; cursor: pointer; transition: transform 0.2s; display: inline-block; }
        .status-ok:hover { transform: scale(1.2); text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .status-no { color: #ffadad; font-size: 1.2em; cursor: default; } 
        
        .weekend { background-color: #fff3cd; } 
        .date-cell { color: #1e88e5; font-weight: bold; font-size: 1.05em; }

        .staff-input { border: 1px solid transparent; background: transparent; text-align: center; width: 100%; font-size: 1.05em; color: #2c3e50; font-weight: bold; padding: 5px; border-radius: 4px; transition: 0.2s; }
        .staff-input:hover { border: 1px solid #ccc; background: white; } 
        .staff-input:focus { border: 1px solid #1e88e5; background: white; outline: none; box-shadow: 0 0 0 2px rgba(30,136,229,0.2); }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 999; font-size: 1.5em; color: #1e88e5; font-weight: bold; flex-direction: column; text-align: center;}
        #loading-subtext { font-size: 0.6em; color: #666; margin-top: 10px; font-weight: normal; }

        .modal { display: none; position: fixed; z-index: 1000; padding-top: 50px; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); }
        .modal-content { margin: auto; display: block; max-width: 90%; max-height: 85vh; border-radius: 8px; box-shadow: 0 4px 15px rgba(255,255,255,0.1); }
        .close-modal { position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .close-modal:hover { color: #bbb; text-decoration: none; cursor: pointer; }
        .modal-caption { margin: auto; display: block; width: 80%; text-align: center; color: #ccc; padding: 10px 0; height: 150px; font-size: 1.2em; }

        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 1001; left: 50%; bottom: 30px; font-size: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div id="loading-text">è³‡æ–™è®€å–ä¸­...</div>
    <div id="loading-subtext">æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº« (ESM Mode)</div>
</div>

<div id="toast">âœ… è³‡æ–™å·²è‡ªå‹•å„²å­˜</div>

<div id="imageModal" class="modal" onclick="closeImageModal()">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImg" onclick="event.stopPropagation()">
    <div id="caption" class="modal-caption"></div>
</div>

<div class="container">
    <div style="margin-bottom: 10px;"><a href="menu.html" class="btn-back">â¬… å›é¸å–®</a></div>
    
    <div class="info-card">
        <div class="info-item">
            <h3>é›²ç«¯ç©ºé–“ä½¿ç”¨é‡ (500MB)</h3>
            <span id="storage-usage" class="info-number">è¨ˆç®—ä¸­...</span>
            <span id="storage-days" class="info-sub"></span>
        </div>
        <div class="info-item" style="text-align: right;">
            <h3>ç´¯ç©ç¸½ç…§ç‰‡æ•¸</h3> <span id="total-photos" class="info-number">0 å¼µ</span>
        </div>
    </div>

    <div class="controls">
        <select id="view-mode"><option value="month">æ¯æœˆæª¢è¦–</option></select>
        <input type="month" id="month-picker">
        <button class="btn btn-search" onclick="fetchData()">ğŸ” æŸ¥è©¢ç´€éŒ„</button>
        <button class="btn btn-download" onclick="handleDownloadOnly()">ğŸ“¥ ä¸‹è¼‰é¸å–ç…§ç‰‡</button>
        <button id="btn-delete" class="btn btn-delete" onclick="handleDeleteOnly()">ğŸ—‘ï¸ åˆªé™¤é¸å–è³‡æ–™</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th width="50"><input type="checkbox" id="check-all" onchange="toggleAll(this)"></th>
                    <th width="120">æ—¥æœŸ</th>
                    <th width="150">å€¼ç­äººå“¡(å¯ä¿®æ”¹)</th> 
                    <th colspan="2">æ—©é¤</th> 
                    <th colspan="1">åˆé¤</th> 
                    <th colspan="1">æ™šé¤</th>
                </tr>
                <tr>
                    <th></th><th></th><th></th>
                    <th style="font-size:0.8em;color:#666;">ç—…æ‚£</th><th style="font-size:0.8em;color:#666;">è­·å®¶</th>
                    <th style="font-size:0.8em;color:#666;">ç—…æ‚£</th>
                    <th style="font-size:0.8em;color:#666;">ç—…æ‚£</th>
                </tr>
            </thead>
            <tbody id="record-body"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // è¨­å®šå…¨åŸŸè®Šæ•¸
    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    let supabase = null;

    // ç‹€æ…‹è®Šæ•¸
    let currentRecords = []; 
    let isAdmin = false; 
    let currentUserEmail = "";
    let loadingTimer = null;
    const weekDays = ['(æ—¥)', '(ä¸€)', '(äºŒ)', '(ä¸‰)', '(å››)', '(äº”)', '(å…­)'];

    // åˆå§‹åŒ–
    try {
        supabase = createClient(RAW_URL, RAW_KEY);
        console.log("Supabase (ESM) Loaded.");
        initApp();
    } catch(e) {
        showLoading(false);
        alert("âŒ åˆå§‹åŒ–å¤±æ•—ï¼šæ‚¨çš„ç€è¦½å™¨é˜»æ“‹äº†æ¨¡çµ„è¼‰å…¥ã€‚\n" + e.message);
    }

    function initApp() {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const picker = document.getElementById('month-picker');
        if(picker) picker.value = `${yyyy}-${mm}`;
        
        checkSession();
    }

    async function checkSession() {
        showLoading(true, "é©—è­‰èº«åˆ†ä¸­...");
        try {
            const { data, error } = await supabase.auth.getSession();
            if (error) throw error;
            
            if(!data.session) { 
                showLoading(false);
                alert("âš ï¸ æ‚¨å°šæœªç™»å…¥ï¼Œè«‹è¿”å›é¦–é ç™»å…¥ã€‚"); 
                window.location.href = 'index.html'; 
                return; 
            } 
            
            currentUserEmail = data.session.user.email;
            await checkUserRole();
            await fetchData(); 
            updateGlobalStats(); 

        } catch(e) {
            showLoading(false);
            console.error(e);
            alert("âŒ èº«åˆ†é©—è­‰å¤±æ•— (å¯èƒ½å›  Supabase ç¶­ä¿®ä¸­)ï¼š\n" + e.message);
        }
    }

    async function checkUserRole() {
        try {
            const { data, error } = await supabase.from('user_roles').select('role').eq('email', currentUserEmail).single();
            isAdmin = (data && data.role === 'admin');
            const delBtn = document.getElementById('btn-delete');
            if(delBtn) delBtn.style.display = isAdmin ? 'inline-block' : 'none';
        } catch(e) {
            console.warn("User role check failed:", e);
            isAdmin = false;
        }
    }

    // å°‡å‡½å¼æ›è¼‰åˆ° windowï¼Œè®“ HTML ä¸­çš„ onclick å¯ä»¥å‘¼å«
    window.fetchData = async function() {
        showLoading(true, "è®€å–è³‡æ–™ä¸­...");
        try {
            const monthVal = document.getElementById('month-picker').value; 
            const [year, month] = monthVal.split('-');
            const startDate = `${year}-${month}-01`;
            const lastDay = new Date(year, month, 0).getDate(); 
            const endDate = `${year}-${month}-${lastDay}`;

            const { data: scheduleData, error: scheError } = await supabase.from('duty_roster').select('date, staff_name').gte('date', startDate).lte('date', endDate);
            if (scheError) throw new Error("ç­è¡¨å¤±æ•—: " + scheError.message);

            const { data: recordData, error: recError } = await supabase.from('meal_records').select('*').gte('record_date', startDate).lte('record_date', endDate);
            if (recError) throw new Error("ç´€éŒ„å¤±æ•—: " + recError.message);

            currentRecords = recordData; 
            renderTable(year, month, scheduleData, recordData);
        } catch (err) {
            alert("âŒ è®€å–éŒ¯èª¤ï¼š" + err.message);
        } finally {
            showLoading(false);
        }
    }

    function renderTable(year, month, schedules, records) {
        const tbody = document.getElementById('record-body');
        tbody.innerHTML = '';
        const daysInMonth = new Date(year, month, 0).getDate(); 
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${month}-${String(day).padStart(2, '0')}`;
            const dateObj = new Date(dateStr);
            const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
            const weekStr = weekDays[dateObj.getDay()]; 
            const displayDate = `${month}/${day} <span style="font-size:0.9em;">${weekStr}</span>`;

            const daySchedules = schedules.filter(s => s.date === dateStr);
            const allNames = daySchedules.map(s => s.staff_name);
            const uniqueNames = [...new Set(allNames)]; 
            let staffNameValue = uniqueNames.join(' / ');

            const displayStaffInput = `<input type="text" class="staff-input" value="${staffNameValue}" placeholder="æœªæ’ç­" onchange="updateStaff('${dateStr}', this.value)">`;
            const dayRecords = records.filter(r => r.record_date === dateStr);
            
            const checkStatus = (mType, tType) => {
                const found = dayRecords.find(r => r.meal_type === mType && r.target_type === tType);
                if (found) {
                    return `<span class="status-ok" onclick="viewPhoto('${found.photo_path}', '${dateStr} ${translate(mType)} ${translate(tType)}')">âœ…</span>`;
                } else {
                    return `<span class="status-no">âŒ</span>`;
                }
            };

            const row = `
                <tr class="${isWeekend ? 'weekend' : ''}">
                    <td><input type="checkbox" class="date-checkbox" value="${dateStr}"></td>
                    <td class="date-cell">${displayDate}</td> <td>${displayStaffInput}</td> 
                    <td>${checkStatus('breakfast', 'patient')}</td><td>${checkStatus('breakfast', 'nursing')}</td>
                    <td>${checkStatus('lunch', 'patient')}</td>
                    <td>${checkStatus('dinner', 'patient')}</td>
                </tr>`;
            tbody.innerHTML += row;
        }
    }

    async function updateGlobalStats() {
        try {
            const { count, error } = await supabase.from('meal_records').select('*', { count: 'exact', head: true });
            if (error) return;
            const totalCount = count || 0;
            const usedSpace = (totalCount * 0.5); 
            const totalSpace = 500; 
            document.getElementById('total-photos').innerText = totalCount + " å¼µ"; 
            document.getElementById('storage-usage').innerText = `${usedSpace.toFixed(1)} MB / ${totalSpace} MB`; 
            const daysLeft = Math.floor((totalSpace - usedSpace) / 3);
            const daysLabel = document.getElementById('storage-days');
            if (daysLeft > 100) { daysLabel.innerHTML = `ğŸŒŸ ç´„å¯ä½¿ç”¨ <strong>${daysLeft}</strong> å¤©`; daysLabel.style.color = "#ffeb3b"; }
            else { daysLabel.innerHTML = `âš ï¸ ç´„å‰© <strong>${daysLeft}</strong> å¤©`; daysLabel.style.color = "#fff"; }
        } catch(e) { console.error(e); }
    }

    window.updateStaff = async function(date, newName) {
        newName = newName.trim();
        try {
            const { data: existing } = await supabase.from('duty_roster').select('*').eq('date', date);
            if (existing && existing.length > 0) {
                if (newName === "") await supabase.from('duty_roster').delete().eq('date', date);
                else await supabase.from('duty_roster').update({ staff_name: newName }).eq('date', date);
            } else if (newName !== "") {
                await supabase.from('duty_roster').insert([{ date: date, staff_name: newName, shift: 'BN' }]);
            }
            showToast(`âœ… ${date} æ›´æ–°æˆåŠŸ`);
        } catch (err) { alert("æ›´æ–°å¤±æ•—: " + err.message); }
    }

    window.viewPhoto = async function(path, captionText) {
        showLoading(true, "è¼‰å…¥ç…§ç‰‡ä¸­...");
        try {
            const { data, error } = await supabase.storage.from('private_photos').createSignedUrl(path, 60);
            if (error) throw error;
            document.getElementById('imageModal').style.display = "block";
            document.getElementById('modalImg').src = data.signedUrl;
            document.getElementById('caption').innerText = captionText;
        } catch (err) { alert("ç„¡æ³•è¼‰å…¥ç…§ç‰‡: " + err.message); } 
        finally { showLoading(false); }
    }

    window.handleDownloadOnly = async function() {
        const checkboxes = document.querySelectorAll('.date-checkbox:checked');
        if (checkboxes.length === 0) { alert("è«‹å…ˆå‹¾é¸è¦ä¸‹è¼‰çš„æ—¥æœŸ"); return; }
        showLoading(true, "æ‰“åŒ…ä¸‹è¼‰ä¸­...");
        try {
            const selectedDates = Array.from(checkboxes).map(cb => cb.value);
            const targetRecords = currentRecords.filter(r => selectedDates.includes(r.record_date));
            if (targetRecords.length === 0) { alert("ç„¡ç…§ç‰‡å¯ä¸‹è¼‰"); return; }

            const zip = new JSZip();
            const folder = zip.folder(`ç…§ç‰‡å‚™ä»½`);
            const promises = targetRecords.map(async (record) => {
                const { data, error } = await supabase.storage.from('private_photos').download(record.photo_path);
                if (!error && data) {
                    const fname = `${record.record_date}_${translate(record.meal_type)}_${translate(record.target_type)}.jpg`;
                    folder.file(fname, data);
                }
            });
            await Promise.all(promises);
            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, `ç…§ç‰‡å‚™ä»½_${new Date().toISOString().slice(0,10)}.zip`);
        } catch (err) { alert("ä¸‹è¼‰éŒ¯èª¤: " + err.message); } 
        finally { showLoading(false); }
    }

    window.handleDeleteOnly = async function() {
        if (!isAdmin) { alert("æ¬Šé™ä¸è¶³"); return; }
        const checkboxes = document.querySelectorAll('.date-checkbox:checked');
        if (checkboxes.length === 0) { alert("è«‹å‹¾é¸æ—¥æœŸ"); return; }
        if(!confirm("ç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ")) return;
        if(prompt("è¼¸å…¥'åˆªé™¤'ç¢ºèª") !== "åˆªé™¤") return;

        showLoading(true, "åˆªé™¤ä¸­...");
        try {
            const selectedDates = Array.from(checkboxes).map(cb => cb.value);
            const targetRecords = currentRecords.filter(r => selectedDates.includes(r.record_date));
            const paths = targetRecords.map(r => r.photo_path);
            const ids = targetRecords.map(r => r.id);
            
            if(paths.length > 0) await supabase.storage.from('private_photos').remove(paths);
            await supabase.from('meal_records').delete().in('id', ids);
            
            alert("âœ… åˆªé™¤æˆåŠŸ");
            fetchData();
            updateGlobalStats();
        } catch(e) { alert("åˆªé™¤å¤±æ•—: " + e.message); }
        finally { showLoading(false); }
    }

    window.toggleAll = function(source) { document.querySelectorAll('.date-checkbox').forEach(cb => cb.checked = source.checked); }
    window.closeImageModal = function() { document.getElementById('imageModal').style.display = "none"; }
    
    function showLoading(show, text) { 
        const overlay = document.getElementById('loading-overlay');
        if (show) {
            overlay.style.display = 'flex'; 
            if(text) document.getElementById('loading-text').innerText = text;
            if(loadingTimer) clearTimeout(loadingTimer);
            loadingTimer = setTimeout(() => {
                overlay.style.display = 'none';
                alert("âš ï¸ ç³»çµ±å›æ‡‰é€¾æ™‚ï¼\nè«‹æª¢æŸ¥ç¶²è·¯æˆ– Supabase ç‹€æ…‹ã€‚");
            }, 10000);
        } else {
            overlay.style.display = 'none'; 
            if(loadingTimer) clearTimeout(loadingTimer);
        }
    }
    
    function translate(eng) { 
        const map = { 'breakfast': 'æ—©é¤', 'lunch': 'åˆé¤', 'dinner': 'æ™šé¤', 'patient': 'ç—…æ‚£', 'nursing': 'è­·å®¶', 'care': 'è­·å®¶' }; 
        return map[eng] || eng; 
    }
</script>
</body>
</html>
