<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥çœ‹ç…§ç‰‡ä¸Šå‚³ç´€éŒ„</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f8f9fa; max-width: 1000px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #666; display: flex; align-items: center; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        
        .control-panel { background: white; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; flex-wrap: wrap; }
        select, input[type="month"], input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        button.check-btn { padding: 8px 16px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;}
        button.check-btn:hover { background: #1557b0; }

        .table-container { background: white; border-radius: 8px; overflow-x: auto; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; } 
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; border-right: 1px solid #eee; vertical-align: middle; }
        th { background: #f1f3f4; color: #333; font-size: 14px; white-space: nowrap; }
        td { font-size: 14px; }
        
        .col-date { font-weight: bold; color: #1a73e8; white-space: nowrap; background: #fff; position: sticky; left: 0; z-index: 1; border-right: 2px solid #ddd; }
        
        /* ç·¨è¼¯è¼¸å…¥æ¡†æ¨£å¼ */
        .staff-input {
            width: 100%;
            min-width: 80px;
            padding: 6px;
            border: 1px solid transparent; 
            border-radius: 4px;
            text-align: center;
            font-family: inherit;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            color: #444;
        }
        .staff-input:hover { border: 1px solid #ddd; background: #f8f9fa; }
        .staff-input:focus { border: 1px solid #1a73e8; background: #fff; outline: none; box-shadow: 0 0 3px rgba(26,115,232,0.3); }
        
        /* å„²å­˜ç‹€æ…‹é¡è‰² */
        .saving { background-color: #fff3cd !important; } 
        .saved { background-color: #d1e7dd !important; border-color: #198754 !important; } 
        .error { background-color: #f8d7da !important; border-color: #dc3545 !important; } 

        .ok { color: #28a745; font-size: 18px; } 
        .missing { color: #dc3545; font-size: 12px; font-weight: bold; } 
        
        tr.weekend { background-color: #fafafa; }
        .tip { font-size: 12px; color: #666; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
        <button onclick="handleLogout()" class="logout-btn">ç™»å‡º</button>
    </div>

    <div class="control-panel">
        <select id="viewMode" onchange="changeMode()">
            <option value="day">ğŸ“… æ¯æ—¥æª¢è¦–</option>
            <option value="week">ğŸ“† æ¯é€±æª¢è¦–</option>
            <option value="month" selected>ğŸ—“ï¸ æ¯æœˆæª¢è¦–</option>
        </select>
        
        <div id="dateInputContainer">
            <input type="month" id="monthInput">
        </div>

        <button class="check-btn" onclick="fetchData()">ğŸ” æŸ¥è©¢</button>
        <span class="tip">ğŸ’¡ æç¤ºï¼šé»æ“Šåå­—å¯ä¿®æ”¹ï¼Œæ”¹å®Œé»ç©ºç™½è™•è‡ªå‹•å„²å­˜ã€‚</span>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th rowspan="2" class="col-date" style="z-index:2">æ—¥æœŸ</th>
                    <th rowspan="2" style="width: 120px;">å€¼ç­äºº</th>
                    <th colspan="2">æ—©é¤</th>
                    <th colspan="2">åˆé¤</th>
                    <th colspan="2">æ™šé¤</th>
                </tr>
                <tr>
                    <th>ç—…æ‚£</th><th>è­·å®¶</th>
                    <th>ç—…æ‚£</th><th>è­·å®¶</th>
                    <th>ç—…æ‚£</th><th>è­·å®¶</th>
                </tr>
            </thead>
            <tbody id="resultBody">
                <tr><td colspan="8" style="padding: 20px;">è«‹é¸æ“‡æ—¥æœŸä¸¦æŒ‰ä¸‹æŸ¥è©¢</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        function cleanString(str) { return str ? str.replace(/[^\x20-\x7E]/g, '').trim() : ''; }
        const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
        const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
        const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

        // åˆå§‹åŒ–
        (async () => {
            const { data } = await supabase.auth.getSession();
            if(!data.session) window.location.href = 'index.html';
            
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('monthInput').value = `${yyyy}-${mm}`;
        })();

        async function handleLogout() { await supabase.auth.signOut(); window.location.href = 'index.html'; }

        function changeMode() {
            const mode = document.getElementById('viewMode').value;
            const container = document.getElementById('dateInputContainer');
            container.innerHTML = ''; 

            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');

            if (mode === 'month') {
                container.innerHTML = `<input type="month" id="monthInput" value="${yyyy}-${mm}">`;
            } else {
                container.innerHTML = `<input type="date" id="dateInput" value="${yyyy}-${mm}-${dd}">`;
            }
        }

        async function fetchData() {
            const mode = document.getElementById('viewMode').value;
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = '<tr><td colspan="8">è³‡æ–™è®€å–ä¸­...</td></tr>';

            let startDate, endDate;

            if (mode === 'month') {
                const val = document.getElementById('monthInput').value;
                if (!val) { alert('è«‹é¸æ“‡æœˆä»½'); return; }
                const [y, m] = val.split('-');
                startDate = `${y}-${m}-01`;
                const lastDay = new Date(y, m, 0).getDate();
                endDate = `${y}-${m}-${lastDay}`;
            } else if (mode === 'week') {
                const val = document.getElementById('dateInput').value;
                if (!val) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
                const curr = new Date(val);
                const day = curr.getDay() || 7; 
                if(day !== 1) curr.setHours(-24 * (day - 1)); 
                startDate = curr.toISOString().split('T')[0];
                curr.setHours(24 * 6);
                endDate = curr.toISOString().split('T')[0];
            } else { 
                const val = document.getElementById('dateInput').value;
                if (!val) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
                startDate = val;
                endDate = val;
            }

            const { data: logs, error: lErr } = await supabase
                .from('meal_logs')
                .select('*')
                .gte('meal_date', startDate)
                .lte('meal_date', endDate);

            const { data: roster, error: rErr } = await supabase
                .from('duty_roster')
                .select('*')
                .gte('date', startDate)
                .lte('date', endDate);

            if (lErr || rErr) {
                console.error(lErr, rErr);
                tbody.innerHTML = '<tr><td colspan="8" style="color:red">è®€å–å¤±æ•—</td></tr>';
                return;
            }

            renderTable(startDate, endDate, logs, roster);
        }

        function renderTable(startStr, endStr, logs, roster) {
            let html = '';
            let current = new Date(startStr);
            const end = new Date(endStr);

            while (current <= end) {
                const dateIso = current.toISOString().split('T')[0];
                const displayDate = `${current.getMonth()+1}/${current.getDate()}`;
                const dayOfWeek = current.getDay();
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6) ? 'weekend' : '';
                const weekStr = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dayOfWeek];

                // å–®äººé‚è¼¯ï¼šåªæŠ“å–è©²æ—¥æœŸåŒ¹é…åˆ°çš„ç¬¬ä¸€å€‹äººå
                const staffEntry = roster.find(r => r.date === dateIso);
                const staffName = staffEntry ? staffEntry.staff_name : '';

                const check = (m, t) => {
                    const found = logs.find(l => l.meal_date === dateIso && l.meal_type === m && l.target_type === t);
                    return found ? '<span class="ok">âœ…</span>' : '<span class="missing">âŒ</span>';
                };

                html += `
                    <tr class="${isWeekend}">
                        <td class="col-date">${displayDate} (${weekStr})</td>
                        <td>
                            <input type="text" 
                                   class="staff-input" 
                                   value="${staffName}" 
                                   onchange="updateRoster('${dateIso}', this)"
                                   placeholder="-"
                                   title="é»æ“Šä¿®æ”¹å€¼ç­äººå“¡">
                        </td>
                        <td>${check('breakfast', 'patient')}</td>
                        <td>${check('breakfast', 'nursing')}</td>
                        <td>${check('lunch', 'patient')}</td>
                        <td>${check('lunch', 'nursing')}</td>
                        <td>${check('dinner', 'patient')}</td>
                        <td>${check('dinner', 'nursing')}</td>
                    </tr>
                `;

                current.setDate(current.getDate() + 1);
            }

            document.getElementById('resultBody').innerHTML = html;
        }

        async function updateRoster(date, inputEl) {
            const originalVal = inputEl.defaultValue; 
            const newName = inputEl.value.trim(); // å–®ä¸€å§“åï¼Œä¸é€²è¡Œåˆ†å‰²
            
            inputEl.classList.add('saving');
            inputEl.classList.remove('saved', 'error');

            try {
                // 1. åˆªé™¤è©²æ—¥æœŸç•¶å‰æ‰€æœ‰ç­è¡¨ (ç¢ºä¿æœ€å¾Œåªå‰©ä¸€ç­†)
                const { error: delErr } = await supabase
                    .from('duty_roster')
                    .delete()
                    .eq('date', date);

                if (delErr) throw delErr;

                // 2. å¦‚æœè¼¸å…¥æ¡†æœ‰åå­—ï¼Œæ’å…¥è©²ç­†å–®ä¸€è³‡æ–™
                if (newName) {
                    const { error: insErr } = await supabase
                        .from('duty_roster')
                        .insert([{
                            date: date,
                            staff_name: newName,
                            shift: 'BN'
                        }]);
                    if (insErr) throw insErr;
                }

                inputEl.classList.remove('saving');
                inputEl.classList.add('saved');
                setTimeout(() => inputEl.classList.remove('saved'), 1000);

            } catch (err) {
                console.error('æ›´æ–°å¤±æ•—', err);
                alert('å„²å­˜å¤±æ•—ï¼š' + err.message);
                inputEl.classList.remove('saving');
                inputEl.classList.add('error');
                inputEl.value = originalVal;
            }
        }
    </script>
</body>
</html>
