<script>
        // ================= è¨­å®šå€ =================
        const SUPABASE_URL = 'https://oipnjnwootorawargsxe.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII'; 
        const BUCKET_NAME = 'system_files'; 
        const TEMPLATE_NAME = 'template.docx';
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        window.onload = function() {
            const today = new Date();
            const rocYear = today.getFullYear() - 1911;
            const dateStr = `${rocYear}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
            document.getElementById('visit_date').value = dateStr;
        };

        function showDebug(msg) {
            const debugDiv = document.getElementById('debug');
            debugDiv.style.display = 'block';
            debugDiv.innerHTML += msg + '<br>';
        }

        // â˜…â˜…â˜… æ ¸å¿ƒè§£æé‚è¼¯ (é‡å°æ‚¨çš„æˆªåœ–ä¿®æ­£ç‰ˆ) â˜…â˜…â˜…
        async function parsePDF() {
            const fileInput = document.getElementById('pdf_upload');
            const btn = document.querySelector('button[onclick="parsePDF()"]');
            const debugDiv = document.getElementById('debug');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ PDF æª”æ¡ˆ!");
                return;
            }

            btn.innerText = "è§£æä¸­...";
            btn.disabled = true;
            debugDiv.innerHTML = "é–‹å§‹è§£æ PDF...<br>";
            debugDiv.style.display = 'block';

            try {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = ""; 
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageStr = textContent.items.map(item => item.str).join("\n"); 
                    fullText += pageStr + "\n";
                }

                showDebug("âœ“ PDF è®€å–å®Œæˆ,å…± " + pdf.numPages + " é ");

                const cleanText = fullText.replace(/[\s\n\r]/g, "");
                
                // --- 1. å€‹æ¡ˆå§“åèˆ‡èº«åˆ†è­‰ ---
                let userName = "";
                let userId = "";
                const headerMatch = cleanText.match(/å€‹æ¡ˆå§“å\/èº«åˆ†è­‰å­—è™Ÿ[::]?([^\/]+)\/([A-Z][0-9]{9})/);
                if (headerMatch) {
                    let tempName = headerMatch[1].trim();
                    if (tempName && tempName.length > 1 && !tempName.includes("/")) userName = tempName;
                    userId = headerMatch[2].trim();
                    showDebug("âœ“ å§“å: " + userName + ", èº«åˆ†è­‰: " + userId);
                }

                // --- 2. é›»è©± ---
                let userPhone = "";
                const phoneMatch = cleanText.match(/å€‹æ¡ˆé›»è©±.*?((09\d{8})|(0\d{1,2}-?\d{6,8}))/);
                if (phoneMatch) {
                    userPhone = phoneMatch[1];
                    showDebug("âœ“ é›»è©±: " + userPhone);
                }

                // --- 3. è²»ç”¨ç­‰ç´š ---
                let paymentVal = "240";
                const welfareMatch = cleanText.match(/é•·ç…§ç¦åˆ©.*?(ç¬¬[ä¸€äºŒä¸‰]é¡)/);
                if (welfareMatch) {
                    const level = welfareMatch[1];
                    if (level.includes("ç¬¬ä¸€é¡")) paymentVal = "0";
                    else if (level.includes("ç¬¬äºŒé¡")) paymentVal = "75";
                    else if (level.includes("ç¬¬ä¸‰é¡")) paymentVal = "240";
                    showDebug("âœ“ ç¦åˆ©ç­‰ç´š: " + level + " -> " + paymentVal + "å…ƒ");
                }

                // --- 4. ä»£ç†äºº ---
                let contractorName = "";
                let contractorPhone = "";
                let agentMatch = cleanText.match(/ä»£ç†äººå§“å(.*?)ä»£ç†äººèº«åˆ†è­‰/);
                if (!agentMatch || agentMatch[1].length < 2) agentMatch = cleanText.match(/ä¸»è¦è¯çµ¡äººå§“å(.*?)ä¸»è¦è¯çµ¡äºº/);
                if (agentMatch) contractorName = agentMatch[1].replace(/[:ï¼š]/g, "").trim();

                const agentMobileMatch = cleanText.match(/ä»£ç†äººæ‰‹æ©Ÿ[::]?.*?((09\d{8}))/);
                if (agentMobileMatch) contractorPhone = agentMobileMatch[1];
                else {
                    const contactMobileMatch = cleanText.match(/è¯çµ¡äººæ‰‹æ©Ÿ[::]?.*?((09\d{8}))/);
                    if (contactMobileMatch) contractorPhone = contactMobileMatch[1];
                }

                if (!contractorName || contractorName.length < 2) contractorName = userName;
                if (!contractorPhone) contractorPhone = userPhone;

                // --- 5. åœ°å€è§£æ (é‡å°æˆªåœ–ä¿®æ­£) ---
                let householdAddress = "";
                let contactAddress = "";

                // é€šç”¨æ¸…ç†å‡½æ•¸ï¼šç§»é™¤éƒµéå€è™Ÿã€æ‹¬è™Ÿã€æ³¨æ„äº‹é …
                function cleanAddress(addr) {
                    if (!addr) return "";
                    return addr
                        .replace(/â€».*$/, "")                // ç§»é™¤ "â€»" ä¹‹å¾Œçš„æ‰€æœ‰æ–‡å­— (è§£æ±ºæˆªåœ–ä¸­å‡ºç¾èªªæ˜æ–‡å­—çš„å•é¡Œ)
                        .replace(/\(éƒµéå€è™Ÿ[:\s]*\d+\)/g, "") // ç§»é™¤ (éƒµéå€è™Ÿ:826)
                        .replace(/éƒµéå€è™Ÿ[:\s]*\d+/g, "")     // ç§»é™¤ éƒµéå€è™Ÿ:826
                        .replace(/\(é‡Œ[^\)]*\)/g, "")        // ç§»é™¤ (é‡Œã€é„°...)
                        .replace(/[^\u4e00-\u9fa5\w\dè™Ÿæ¨“ä¹‹\-\.]/g, "") // åªä¿ç•™ä¸­æ–‡æ•¸å­—è‹±æ–‡
                        .trim();
                }

                // (A) æˆ¶ç±åœ°å€
                // é‚è¼¯ï¼šæŠ“å– "æˆ¶ç±åœ°å€" å¾Œé¢ï¼Œç›´åˆ°é‡åˆ°æ›è¡Œ(\n)æˆ–ç¬¦è™Ÿ(â€»)
                const houseRegex = /æˆ¶ç±åœ°å€\s*[:ï¼š]?\s*([^\nâ€»]+)/;
                const houseMatch = fullText.match(houseRegex);
                if (houseMatch) {
                    householdAddress = cleanAddress(houseMatch[1]);
                    showDebug("âœ“ æˆ¶ç±åœ°å€: " + householdAddress);
                }

                // (B) é€šè¨Šåœ°å€ (é‡å° "å±…ä½(é€šè¨Š)åœ°" )
                // é‚è¼¯ï¼šå…è¨± "å±…ä½" å’Œ "é€šè¨Š" ä¹‹é–“æœ‰æ‹¬è™Ÿï¼Œä¸¦æŠ“å–åŒä¸€è¡Œçš„å…§å®¹
                // [\(ï¼ˆ]? åŒ¹é…åŠå½¢æˆ–å…¨å½¢å·¦æ‹¬è™Ÿ
                const contactRegex = /å±…ä½[\(ï¼ˆ]?é€šè¨Š[\)ï¼‰]?åœ°(?:å€)?\s*[:ï¼š]?\s*([^\nâ€»]+)/;
                const contactMatch = fullText.match(contactRegex);
                
                if (contactMatch) {
                    contactAddress = cleanAddress(contactMatch[1]);
                    
                    // é˜²å‘†ï¼šå¦‚æœæŠ“åˆ°çš„å­—ä¸²é–‹é ­æ˜¯ "å€" (PDFè§£æèª¤å·®)ï¼Œå»æ‰å®ƒ
                    if (contactAddress.startsWith("å€")) contactAddress = contactAddress.substring(1);
                    
                    showDebug("âœ“ é€šè¨Šåœ°å€ (ç²¾æº–åŒ¹é…): " + contactAddress);
                }

                // (C) å‚™ç”¨æ©Ÿåˆ¶ (è¬ä¸€ regex å¤±æ•—ï¼Œæ‰ç”¨é€™å€‹)
                // åªæœ‰ç•¶ contactAddress æ˜¯ç©ºçš„ï¼Œæ‰å»ç”¨çŒœçš„ï¼Œé¿å…è¦†è“‹æ­£ç¢ºçµæœ
                if (!contactAddress) {
                    // å°‹æ‰¾åƒæ˜¯åœ°å€çš„å­—ä¸²ï¼Œä½†è¦é¿é–‹å·²ç¶“æ‰¾åˆ°çš„æˆ¶ç±åœ°å€
                    const allAddresses = cleanText.matchAll(/([å°è‡º]?[åŒ—ä¸­å—é«˜å±å°æ¡ƒç«¹è‹—å½°é›²å˜‰][^\nå¸¸èª]{8,50}[è™Ÿ])/g);
                    for (const match of allAddresses) {
                        let potentialAddr = cleanAddress(match[1]);
                        // å¦‚æœé€™å€‹åœ°å€è·Ÿæˆ¶ç±åœ°å€ä¸ä¸€æ¨£ï¼Œé‚£å¤§æ¦‚å°±æ˜¯é€šè¨Šåœ°å€äº†
                        if (potentialAddr !== householdAddress && potentialAddr.length > 8) {
                            contactAddress = potentialAddr;
                            showDebug("âœ“ é€šè¨Šåœ°å€ (å‚™ç”¨æ¨æ¸¬): " + contactAddress);
                            break;
                        }
                    }
                }

                // --- å¡«å…¥è¡¨å–® ---
                document.getElementById('user_name').value = userName || "";
                document.getElementById('user_id').value = userId || "";
                document.getElementById('user_phone').value = userPhone || "";
                document.getElementById('payment').value = paymentVal;
                document.getElementById('contractor_name').value = contractorName || "";
                document.getElementById('contractor_phone').value = contractorPhone || "";
                
                if (householdAddress) document.getElementById('household_address').value = householdAddress;
                if (contactAddress) document.getElementById('contact_address').value = contactAddress;

                if (householdAddress && contactAddress) {
                    showDebug("âœ… è§£æå®Œæˆ!");
                    alert(`è§£ææˆåŠŸ!\næˆ¶ç±: ${householdAddress}\né€šè¨Š: ${contactAddress}`);
                } else {
                    showDebug("âš ï¸ éƒ¨åˆ†åœ°å€æœªæ‰¾åˆ°");
                    alert("åœ°å€è§£æå®Œæˆï¼Œè«‹æª¢æŸ¥æ¬„ä½æ˜¯å¦æ­£ç¢ºã€‚");
                }

            } catch (err) {
                console.error(err);
                showDebug("âŒ éŒ¯èª¤: " + err.message);
                alert("è®€å– PDF å¤±æ•—:" + err.message);
            } finally {
                btn.innerText = "ğŸ“‚ è®€å– PDF è³‡æ–™";
                btn.disabled = false;
            }
        }

        function calculateEndDate(visitDateStr) {
            if (!visitDateStr) return "";
            const match = visitDateStr.match(/^(\d{2,3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥$/);
            if (!match) return "";
            let year = parseInt(match[1]) + 1911;
            let month = parseInt(match[2]);
            let day = parseInt(match[3]);
            let newMonth = month + 3;
            let newYear = year;
            if (newMonth > 12) { newYear += 1; newMonth -= 12; }
            const lastDayOfNewMonth = new Date(newYear, newMonth, 0).getDate();
            const newDay = Math.min(day, lastDayOfNewMonth);
            return `${newYear - 1911}å¹´${newMonth}æœˆ${newDay}æ—¥`;
        }

        async function generateWord() {
            const btn = document.querySelector('.btn-success');
            const originalText = btn.innerText;
            btn.innerText = "â³ è™•ç†ä¸­...";
            btn.disabled = true;

            try {
                const { data: fileData, error } = await supabase.storage.from(BUCKET_NAME).download(TEMPLATE_NAME);
                if (error) throw new Error("ä¸‹è¼‰ç¯„æœ¬å¤±æ•—: " + error.message);

                const visitDate = document.getElementById('visit_date').value;
                const templateData = {
                    user_name: document.getElementById('user_name').value,
                    user_id: document.getElementById('user_id').value,
                    user_phone: document.getElementById('user_phone').value,
                    payment: document.getElementById('payment').value,
                    contractor_name: document.getElementById('contractor_name').value,
                    contractor_phone: document.getElementById('contractor_phone').value,
                    household_address: document.getElementById('household_address').value,
                    contact_address: document.getElementById('contact_address').value,
                    visit_date: visitDate,
                    end_date: calculateEndDate(visitDate)
                };

                const arrayBuffer = await fileData.arrayBuffer();
                const zip = new PizZip(arrayBuffer);
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
                doc.render(templateData);

                const blob = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                saveAs(blob, `ç¾©å¤§é†«é™¢å¥‘ç´„æ›¸_${templateData.user_name}.docx`);
                
            } catch (err) {
                alert("éŒ¯èª¤: " + err.message);
                console.error(err);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
