<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·ç…§åˆç´„ç”¢ç”Ÿå™¨ (æœ€çµ‚ä¿®æ­£ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .btn { color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; transition: 0.3s; margin-top: 10px; }
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; background: #f8f9fa; }
        .debug { margin-top: 20px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>

    <div class="section">
        <h2>æ­¥é©Ÿ 1:ä¸Šå‚³ PDF è‡ªå‹•å¸¶å…¥è³‡æ–™</h2>
        <div class="upload-area">
            <p>è«‹ä¸Šå‚³ã€Œç…§é¡§ç®¡ç†è©•ä¼°é‡è¡¨ã€PDF</p>
            <input type="file" id="pdf_upload" accept="application/pdf" />
            <button class="btn btn-primary" onclick="parsePDF()">ğŸ“‚ è®€å– PDF è³‡æ–™</button>
        </div>
        <div id="debug" class="debug" style="display:none;"></div>
    </div>

    <div class="section">
        <h2>æ­¥é©Ÿ 2:ç¢ºèªä¸¦ä¿®æ”¹è³‡æ–™</h2>

        <div class="form-group">
            <label>å€‹æ¡ˆå§“å</label>
            <input type="text" id="user_name" placeholder="ç­‰å¾…è®€å–..." />
        </div>

        <div class="form-group">
            <label>èº«åˆ†è­‰å­—è™Ÿ</label>
            <input type="text" id="user_id" placeholder="ç­‰å¾…è®€å–..." />
        </div>

        <div class="form-group">
            <label>å€‹æ¡ˆé›»è©±</label>
            <input type="text" id="user_phone" placeholder="ç­‰å¾…è®€å–..." />
        </div>

        <div class="form-group">
            <label>éƒ¨åˆ†è² æ“” (å…ƒ)</label>
            <select id="payment">
                <option value="240">240 (ç¬¬ä¸‰é¡/ä¸€èˆ¬)</option>
                <option value="75">75 (ç¬¬äºŒé¡/ä¸­ä½æ”¶)</option>
                <option value="0">0 (ç¬¬ä¸€é¡/ä½æ”¶)</option>
            </select>
        </div>

        <div class="form-group">
            <label>ç°½ç´„äººå§“å</label>
            <input type="text" id="contractor_name" placeholder="è‹¥ç„¡ä»£ç†äººå‰‡åŒå€‹æ¡ˆ" />
        </div>

        <div class="form-group">
            <label>ç°½ç´„äººé›»è©±</label>
            <input type="text" id="contractor_phone" placeholder="è‹¥ç„¡ä»£ç†äººå‰‡åŒå€‹æ¡ˆ" />
        </div>

        <div class="form-group">
            <label>æˆ¶ç±åœ°å€</label>
            <input type="text" id="household_address" placeholder="ç­‰å¾…è®€å–..." />
        </div>

        <div class="form-group">
            <label>é€šè¨Šåœ°å€ (å·²è‡ªå‹•ç§»é™¤éƒµéå€è™Ÿ)</label>
            <input type="text" id="contact_address" placeholder="ç­‰å¾…è®€å–..." />
        </div>

        <div class="form-group">
            <label>è¨ªè¦–æ—¥æœŸ (é è¨­ä»Šæ—¥)</label>
            <input type="text" id="visit_date">
        </div>

        <button class="btn btn-success" onclick="generateWord()">ğŸ“ ä¸‹è¼‰ Word å¥‘ç´„æ›¸</button>
    </div>

    <script>
        // ================= è¨­å®šå€ =================
        const SUPABASE_URL = 'https://oipnjnwootorawargsxe.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII'; 
        const BUCKET_NAME = 'system_files'; 
        const TEMPLATE_NAME = 'template.docx';
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        window.onload = function() {
            const today = new Date();
            const rocYear = today.getFullYear() - 1911;
            const dateStr = `${rocYear}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
            document.getElementById('visit_date').value = dateStr;
        };

        function showDebug(msg) {
            const debugDiv = document.getElementById('debug');
            debugDiv.style.display = 'block';
            debugDiv.innerHTML += msg + '<br>';
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ¸…ç†åœ°å€é›œè¨Š (éƒµéå€è™Ÿã€æ‹¬è™Ÿèªªæ˜)
        function cleanAddressText(text) {
            if (!text) return "";
            return text
                .replace(/\(éƒµéå€è™Ÿ[:ï¼š\s]*\d+\)/g, "") // æ ¸å¿ƒï¼šç§»é™¤ (éƒµéå€è™Ÿ: 826)
                .replace(/\(é‡Œ[ã€ï¼Œ]é„°.*$/g, "")      // ç§»é™¤ (é‡Œã€é„°ã€éƒµéå€è™Ÿéå¿…å¡«) é€™ç¨®èªªæ˜
                .replace(/â€»/g, "")
                .replace(/\s+/g, "")                    // ç§»é™¤æ‰€æœ‰ç©ºç™½
                .trim();
        }

        // â˜…â˜…â˜… æ ¸å¿ƒè§£æé‚è¼¯ (é€è¡Œæƒæç‰ˆ) â˜…â˜…â˜…
        async function parsePDF() {
            const fileInput = document.getElementById('pdf_upload');
            const btn = document.querySelector('button[onclick="parsePDF()"]');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ PDF æª”æ¡ˆ!");
                return;
            }

            btn.innerText = "è§£æä¸­...";
            btn.disabled = true;
            showDebug("é–‹å§‹è§£æ...");

            try {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = ""; 
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    // ä¿ç•™æ›è¡Œç¬¦è™Ÿï¼Œé€™å°å®šä½éå¸¸é‡è¦
                    const pageStr = textContent.items.map(item => item.str).join("\n"); 
                    fullText += pageStr + "\n";
                }

                showDebug("âœ“ PDF å…§å®¹è®€å–å®Œæˆï¼Œé–‹å§‹åˆ†æ...");
                
                // ç”¢ç”Ÿä¸€å€‹ç„¡ç©ºç™½çš„å­—ä¸²ç”¨æ–¼åŸºæœ¬æ¬„ä½ (å§“åã€èº«åˆ†è­‰) æŠ“å–
                const cleanText = fullText.replace(/[\s\n\r]/g, "");

                // 1. æŠ“å–åŸºæœ¬è³‡æ–™ (ä½¿ç”¨ç„¡ç©ºç™½å­—ä¸²)
                let userName = "", userId = "", userPhone = "", paymentVal = "240";
                
                const headerMatch = cleanText.match(/å€‹æ¡ˆå§“å\/èº«åˆ†è­‰å­—è™Ÿ[:ï¼š]?([^\/]+)\/([A-Z][0-9]{9})/);
                if (headerMatch) {
                    userName = headerMatch[1].replace(/[:ï¼š]/g, "").trim();
                    userId = headerMatch[2].trim();
                }

                const phoneMatch = cleanText.match(/å€‹æ¡ˆé›»è©±.*?((09\d{8})|(0\d{1,2}-?\d{6,8}))/);
                if (phoneMatch) userPhone = phoneMatch[1];

                const welfareMatch = cleanText.match(/é•·ç…§ç¦åˆ©.*?(ç¬¬[ä¸€äºŒä¸‰]é¡)/);
                if (welfareMatch) {
                    if (welfareMatch[1].includes("ç¬¬ä¸€é¡")) paymentVal = "0";
                    else if (welfareMatch[1].includes("ç¬¬äºŒé¡")) paymentVal = "75";
                    else paymentVal = "240";
                }

                // ä»£ç†äººé‚è¼¯
                let contractorName = "", contractorPhone = "";
                let agentMatch = cleanText.match(/ä»£ç†äººå§“å(.*?)ä»£ç†äººèº«åˆ†è­‰/);
                if (!agentMatch) agentMatch = cleanText.match(/ä¸»è¦è¯çµ¡äººå§“å(.*?)ä¸»è¦è¯çµ¡äºº/);
                if (agentMatch) contractorName = agentMatch[1].replace(/[:ï¼š]/g, "").trim();

                const agentMobileMatch = cleanText.match(/(?:ä»£ç†äºº|è¯çµ¡äºº)æ‰‹æ©Ÿ[::]?.*?((09\d{8}))/);
                if (agentMobileMatch) contractorPhone = agentMobileMatch[1];

                if (!contractorName || contractorName.length < 2) contractorName = userName;
                if (!contractorPhone) contractorPhone = userPhone;

                // ==========================================
                // â˜…â˜…â˜… åœ°å€è§£æä¿®æ­£ (ä½¿ç”¨é€è¡Œæƒæç­–ç•¥) â˜…â˜…â˜…
                // ==========================================
                
                let householdAddress = "";
                let contactAddress = "";
                
                // å°‡å…¨æ–‡å­—ä¸²ä¾ã€Œæ›è¡Œã€åˆ‡é–‹ï¼Œè®Šæˆä¸€è¡Œä¸€è¡Œçš„é™£åˆ—
                const lines = fullText.split(/\r?\n/);
                
                let foundHouseLabel = false;
                let foundContactLabel = false;

                // é€è¡Œæª¢æŸ¥
                for (let i = 0; i < lines.length; i++) {
                    // å»é™¤å‰å¾Œç©ºç™½ä»¥ä¾¿åˆ¤æ–·
                    const line = lines[i].trim();
                    
                    // --- æŠ“æˆ¶ç±åœ°å€ ---
                    // æ‰¾åˆ°å«æœ‰ã€Œæˆ¶ç±åœ°å€ã€çš„é‚£ä¸€è¡Œ
                    if (!foundHouseLabel && line.includes("æˆ¶ç±åœ°å€")) {
                        // å¾é€™ä¸€è¡Œé–‹å§‹å¾€å¾Œçœ‹ 5 è¡Œï¼Œæ‰¾çœ‹çœ‹æœ‰æ²’æœ‰åƒåœ°å€çš„æ–‡å­—
                        for (let j = 0; j <= 5; j++) {
                            if (i + j >= lines.length) break;
                            const nextLine = lines[i + j].trim();
                            // åˆ¤æ–·æ¨™æº–ï¼šé–‹é ­æ˜¯ç¸£å¸‚ï¼Œçµå°¾æ˜¯è™Ÿ (ç°¡å–®ç‰ˆ)
                            if (/^[å°è‡º]?[åŒ—ä¸­å—é«˜å±æ–°å®œèŠ±æ±æ¾é‡‘é€£è‹—å½°é›²å˜‰å—æŠ•][ç¸£å¸‚].*?è™Ÿ/.test(nextLine)) {
                                householdAddress = cleanAddressText(nextLine);
                                foundHouseLabel = true;
                                showDebug(`âœ“ æ‰¾åˆ°æˆ¶ç±åœ°å€ (ç¬¬${i+j}è¡Œ): ${householdAddress}`);
                                break;
                            }
                        }
                    }

                    // --- æŠ“é€šè¨Šåœ°å€ ---
                    // æ‰¾åˆ°å«æœ‰ã€Œå±…ä½ã€ä¸”å«æœ‰ã€Œé€šè¨Šã€çš„é‚£ä¸€è¡Œ
                    if (!foundContactLabel && (line.includes("å±…ä½") && line.includes("é€šè¨Š"))) {
                        // å¾é€™ä¸€è¡Œé–‹å§‹å¾€å¾Œçœ‹ 5 è¡Œ
                        for (let j = 0; j <= 5; j++) {
                            if (i + j >= lines.length) break;
                            const nextLine = lines[i + j].trim();
                            // é€™è£¡çš„ nextLine å¯èƒ½åŒ…å« (éƒµéå€è™Ÿ: 826)
                            if (/^[å°è‡º]?[åŒ—ä¸­å—é«˜å±æ–°å®œèŠ±æ±æ¾é‡‘é€£è‹—å½°é›²å˜‰å—æŠ•][ç¸£å¸‚].*?è™Ÿ/.test(nextLine)) {
                                contactAddress = cleanAddressText(nextLine); // ä½¿ç”¨æ¸…ç†å‡½æ•¸ç§»é™¤éƒµéå€è™Ÿ
                                foundContactLabel = true;
                                showDebug(`âœ“ æ‰¾åˆ°é€šè¨Šåœ°å€ (ç¬¬${i+j}è¡Œ): ${contactAddress}`);
                                break;
                            }
                        }
                    }
                }

                // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœé€è¡Œæƒæå¤±æ•— (ä¾‹å¦‚PDFæ–‡å­—å…¨éƒ¨æ“ åœ¨ä¸€èµ·æ²’æ›è¡Œ)ï¼Œæ‰ä½¿ç”¨æ­£å‰‡æœå°‹
                if (!householdAddress && !contactAddress) {
                    showDebug("âš ï¸ é€è¡Œæƒæå¤±æ•—ï¼Œå•Ÿç”¨å‚™ç”¨æ­£å‰‡æœå°‹...");
                    if (!householdAddress) {
                        const m = cleanText.match(/æˆ¶ç±åœ°å€.*?([å°è‡º]?[^0-9\s]+?[ç¸£å¸‚].*?è™Ÿ)/);
                        if (m) householdAddress = cleanAddressText(m[1]);
                    }
                    if (!contactAddress) {
                        // å°‹æ‰¾ã€Œå±…ä½...é€šè¨Š...åœ°å€ã€å¾Œé¢çš„åœ°å€
                        const m = cleanText.match(/å±…ä½.*?é€šè¨Š.*?åœ°å€.*?([å°è‡º]?[^0-9\s]+?[ç¸£å¸‚].*?è™Ÿ)/);
                        if (m) contactAddress = cleanAddressText(m[1]);
                    }
                }

                // ================= å¡«å…¥è¡¨å–® =================
                document.getElementById('user_name').value = userName || "";
                document.getElementById('user_id').value = userId || "";
                document.getElementById('user_phone').value = userPhone || "";
                document.getElementById('payment').value = paymentVal;
                document.getElementById('contractor_name').value = contractorName || "";
                document.getElementById('contractor_phone').value = contractorPhone || "";
                
                document.getElementById('household_address').value = householdAddress || "";
                document.getElementById('contact_address').value = contactAddress || "";

                if (contactAddress) {
                    alert(`è§£ææˆåŠŸï¼\né€šè¨Šåœ°å€ï¼š${contactAddress}`);
                } else {
                    alert("åŸºæœ¬è³‡æ–™å·²è§£æï¼Œä½†åœ°å€æ¬„ä½å¯èƒ½éœ€æ‰‹å‹•ç¢ºèªã€‚");
                }

            } catch (err) {
                console.error(err);
                showDebug("âŒ éŒ¯èª¤: " + err.message);
                alert("è®€å– PDF å¤±æ•—:" + err.message);
            } finally {
                btn.innerText = "ğŸ“‚ è®€å– PDF è³‡æ–™";
                btn.disabled = false;
            }
        }

        function calculateEndDate(visitDateStr) {
            if (!visitDateStr) return "";
            const match = visitDateStr.match(/^(\d{2,3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥$/);
            if (!match) return "";
            let year = parseInt(match[1]) + 1911;
            let month = parseInt(match[2]);
            let day = parseInt(match[3]);
            let newMonth = month + 3;
            let newYear = year;
            if (newMonth > 12) { newYear += 1; newMonth -= 12; }
            const lastDayOfNewMonth = new Date(newYear, newMonth, 0).getDate();
            const newDay = Math.min(day, lastDayOfNewMonth);
            return `${newYear - 1911}å¹´${newMonth}æœˆ${newDay}æ—¥`;
        }

        async function generateWord() {
            const btn = document.querySelector('.btn-success');
            const originalText = btn.innerText;
            btn.innerText = "â³ è™•ç†ä¸­...";
            btn.disabled = true;

            try {
                const { data: fileData, error } = await supabase.storage.from(BUCKET_NAME).download(TEMPLATE_NAME);
                if (error) throw new Error("ä¸‹è¼‰ç¯„æœ¬å¤±æ•—: " + error.message);

                const visitDate = document.getElementById('visit_date').value;
                const templateData = {
                    user_name: document.getElementById('user_name').value,
                    user_id: document.getElementById('user_id').value,
                    user_phone: document.getElementById('user_phone').value,
                    payment: document.getElementById('payment').value,
                    contractor_name: document.getElementById('contractor_name').value,
                    contractor_phone: document.getElementById('contractor_phone').value,
                    household_address: document.getElementById('household_address').value,
                    contact_address: document.getElementById('contact_address').value,
                    visit_date: visitDate,
                    end_date: calculateEndDate(visitDate)
                };

                const arrayBuffer = await fileData.arrayBuffer();
                const zip = new PizZip(arrayBuffer);
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
                doc.render(templateData);

                const blob = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                saveAs(blob, `ç¾©å¤§é†«é™¢å¥‘ç´„æ›¸_${templateData.user_name}.docx`);
                
            } catch (err) {
                alert("éŒ¯èª¤: " + err.message);
                console.error(err);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
