// â˜…â˜…â˜… æ ¸å¿ƒè§£æé‚è¼¯ (åœ°å€ä¿®å¾©ç‰ˆ) â˜…â˜…â˜…
        async function parsePDF() {
            const fileInput = document.getElementById('pdf_upload');
            const btn = document.querySelector('button[onclick="parsePDF()"]');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ PDF æª”æ¡ˆ!");
                return;
            }

            btn.innerText = "è§£æä¸­...";
            btn.disabled = true;

            try {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = ""; 
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageStr = textContent.items.map(item => item.str).join("\n"); 
                    fullText += pageStr + "\n";
                }

                console.log("PDFæ–‡å­—é•·åº¦:", fullText.length);
                
                // å»ºç«‹å»ç©ºç™½ç‰ˆæœ¬ç”¨æ–¼ç²¾ç¢ºå®šä½
                const cleanText = fullText.replace(/[\s\n\r]/g, "");

                // --- 1. å€‹æ¡ˆå§“åèˆ‡èº«åˆ†è­‰ ---
                let userName = "";
                let userId = "";
                const headerMatch = cleanText.match(/å€‹æ¡ˆå§“å\/èº«åˆ†è­‰å­—è™Ÿ[:ï¼š]?([^\/]+)\/([A-Z][0-9]{9})/);
                if (headerMatch) {
                    let tempName = headerMatch[1].trim();
                    if (tempName && tempName.length > 1 && !tempName.includes("/")) userName = tempName;
                    userId = headerMatch[2].trim();
                }

                // å‚™ç”¨å§“åæŠ“å–
                if (!userName || userName === "/") {
                     const backupNameMatch = fullText.match(/å€‹æ¡ˆå§“å[:ï¼š]?\s*([^\s\/]+)/);
                     if (backupNameMatch) {
                         let temp = backupNameMatch[1].trim();
                         if (!temp.includes("å‚³çµ±") && !temp.includes("å€‹æ¡ˆ") && temp.length > 1) userName = temp;
                     }
                }

                // --- 2. é›»è©± ---
                let userPhone = "";
                const phoneMatch = cleanText.match(/å€‹æ¡ˆé›»è©±.*?((09\d{8})|(0\d{1,2}-?\d{6,8}))/);
                if (phoneMatch) userPhone = phoneMatch[1];

                // --- 3. è²»ç”¨ç­‰ç´š ---
                let paymentVal = "240";
                const welfareMatch = cleanText.match(/é•·ç…§ç¦åˆ©.*?(ç¬¬[ä¸€äºŒä¸‰]é¡)/);
                if (welfareMatch) {
                    const level = welfareMatch[1];
                    if (level.includes("ç¬¬ä¸€é¡")) paymentVal = "0";
                    else if (level.includes("ç¬¬äºŒé¡")) paymentVal = "75";
                    else if (level.includes("ç¬¬ä¸‰é¡")) paymentVal = "240";
                }

                // --- 4. ä»£ç†äºº ---
                let contractorName = "";
                let contractorPhone = "";
                let agentMatch = cleanText.match(/ä»£ç†äººå§“å(.*?)ä»£ç†äººèº«åˆ†è­‰/);
                if (!agentMatch || agentMatch[1].length < 2) {
                    agentMatch = cleanText.match(/ä¸»è¦è¯çµ¡äººå§“å(.*?)ä¸»è¦è¯çµ¡äºº/);
                }
                if (agentMatch) contractorName = agentMatch[1].replace(/[:ï¼š]/g, "").trim();

                const agentMobileMatch = cleanText.match(/ä»£ç†äººæ‰‹æ©Ÿ[:ï¼š]?.*?((09\d{8}))/);
                if (agentMobileMatch) contractorPhone = agentMobileMatch[1];
                else {
                    const contactMobileMatch = cleanText.match(/è¯çµ¡äººæ‰‹æ©Ÿ[:ï¼š]?.*?((09\d{8}))/);
                    if (contactMobileMatch) contractorPhone = contactMobileMatch[1];
                }

                if (!contractorName || contractorName.length < 2) contractorName = userName;
                if (!contractorPhone) contractorPhone = userPhone;

                // --- 5. åœ°å€ (æ”¹ç”¨æ­£å‰‡ï¼Œåƒè€ƒPythonç‰ˆ) ---
                let householdAddress = "";
                let contactAddress = "";

                // æˆ¶ç±åœ°å€ï¼šç›´æ¥ç”¨æ­£å‰‡æŠ“å–
                const hRegex = /æˆ¶ç±åœ°å€[^\n]*?\n\s*â€».*?\n\s*(.+?)(?=\n|$)/;
                const hMatch = fullText.match(hRegex);
                if (hMatch) {
                    householdAddress = hMatch[1].trim();
                } else {
                    // ç°¡åŒ–ç‰ˆï¼šæŠ“ã€Œæˆ¶ç±åœ°å€ã€å¾Œç¬¬ä¸€å€‹å®Œæ•´åœ°å€
                    const hSimple = fullText.match(/æˆ¶ç±åœ°å€[^\n]+\n[^\n]*\n\s*([^\n]+)/);
                    if (hSimple) householdAddress = hSimple[1].trim();
                }

                // é€šè¨Šåœ°å€ï¼šæŠ“ã€Œå±…ä½(é€šè¨Š)åœ°å€ã€æ®µè½
                const cRegex = /å±…ä½\(é€šè¨Š\)åœ°\s*å€[^\n]*?\n\s*â€».*?\n\s*(.+?)(?=\nå¸¸ç”¨èªè¨€|$)/;
                const cMatch = fullText.match(cRegex);
                if (cMatch) {
                    let rawC = cMatch[1].trim();
                    // ç§»é™¤éƒµéå€è™Ÿ
                    rawC = rawC.replace(/\(éƒµéå€è™Ÿ[:ï¼š]?\s*\d*\)/g, "");
                    contactAddress = rawC.trim();
                } else {
                    // ç°¡åŒ–ç‰ˆ
                    const cSimple = fullText.match(/å±…ä½\(é€šè¨Š\)åœ°[^\n]+\n[^\n]*\n\s*([^\n]+)/);
                    if (cSimple) {
                        let rawC = cSimple[1].trim();
                        rawC = rawC.replace(/\(éƒµéå€è™Ÿ[:ï¼š]?\s*\d*\)/g, "");
                        contactAddress = rawC.trim();
                    }
                }

                // --- å¡«å…¥è¡¨å–® ---
                document.getElementById('user_name').value = userName || "";
                document.getElementById('user_id').value = userId || "";
                document.getElementById('user_phone').value = userPhone || "";
                document.getElementById('payment').value = paymentVal;
                document.getElementById('contractor_name').value = contractorName || "";
                document.getElementById('contractor_phone').value = contractorPhone || "";
                document.getElementById('household_address').value = householdAddress || "";
                document.getElementById('contact_address').value = contactAddress || "";

                console.log("æˆ¶ç±:", householdAddress);
                console.log("é€šè¨Š:", contactAddress);

                if (householdAddress || contactAddress) {
                    alert(`âœ… è§£ææˆåŠŸï¼\n\næˆ¶ç±ï¼š${householdAddress}\n\né€šè¨Šï¼š${contactAddress}`);
                } else {
                    alert("âš ï¸ å§“åé›»è©±å·²è§£æï¼Œä½†åœ°å€æœªæ‰¾åˆ°ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚");
                }

            } catch (err) {
                console.error(err);
                alert("è®€å– PDF å¤±æ•—ï¼š" + err.message);
            } finally {
                btn.innerText = "ğŸ“‚ è®€å– PDF è³‡æ–™";
                btn.disabled = false;
            }
        }
