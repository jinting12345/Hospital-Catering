<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥‘ç´„æ›¸è‡ªå‹•ç”¢ç”Ÿå™¨</title>
    <!-- å¼•å…¥å¿…è¦çš„å‡½å¼åº«ï¼šPDFè®€å–ã€Wordè™•ç† -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f8f9fa; max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #666; display: flex; align-items: center; }
        
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; }
        .step { font-weight: bold; color: #1a73e8; margin-bottom: 10px; display: block; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        button.action-btn { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        button.action-btn:hover { background: #1557b0; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        #status { margin-top: 10px; color: #666; font-size: 14px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
    </div>

    <!-- æ­¥é©Ÿ 1: ä¸Šå‚³ PDF -->
    <div class="card">
        <span class="step">æ­¥é©Ÿ 1ï¼šåŒ¯å…¥å€‹æ¡ˆ PDF</span>
        <p style="font-size:14px; color:#666;">ç³»çµ±å°‡è‡ªå‹•å¾ PDF è®€å–è³‡æ–™ï¼Œæ‰€æœ‰é‹ç®—çš†åœ¨æ‚¨çš„é›»è…¦ä¸Šå®Œæˆã€‚</p>
        <input type="file" id="pdfInput" accept=".pdf" onchange="processPDF()">
        <div id="status"></div>
    </div>

    <!-- æ­¥é©Ÿ 2: ç¢ºèªè³‡æ–™ -->
    <div class="card" id="formCard" style="opacity: 0.5; pointer-events: none;">
        <span class="step">æ­¥é©Ÿ 2ï¼šç¢ºèªä¸¦ä¿®æ”¹è³‡æ–™</span>
        
        <div class="grid-2">
            <div class="input-group">
                <label>å€‹æ¡ˆå§“å</label>
                <input type="text" id="user_name">
            </div>
            <div class="input-group">
                <label>èº«åˆ†è­‰å­—è™Ÿ</label>
                <input type="text" id="user_id">
            </div>
            <div class="input-group">
                <label>å€‹æ¡ˆé›»è©±</label>
                <input type="text" id="user_phone">
            </div>
            <div class="input-group">
                <label>éƒ¨åˆ†è² æ“” (å…ƒ)</label>
                <select id="payment">
                    <option value="0">0 (ç¬¬ä¸€é¡/ä½æ”¶)</option>
                    <option value="160">160 (ç¬¬äºŒé¡/ä¸­ä½)</option>
                    <option value="240" selected>240 (ç¬¬ä¸‰é¡/ä¸€èˆ¬)</option>
                </select>
            </div>
        </div>

        <div class="grid-2">
            <div class="input-group">
                <label>ç°½ç´„äººå§“å</label>
                <input type="text" id="contractor_name">
            </div>
            <div class="input-group">
                <label>ç°½ç´„äººé›»è©±</label>
                <input type="text" id="contractor_phone">
            </div>
        </div>

        <div class="input-group">
            <label>æˆ¶ç±åœ°å€</label>
            <input type="text" id="household_address">
        </div>
        <div class="input-group">
            <label>é€šè¨Šåœ°å€</label>
            <input type="text" id="contact_address">
        </div>
        
        <div class="input-group">
            <label>è¨ªè¦–æ—¥æœŸ (é è¨­ä»Šæ—¥)</label>
            <input type="text" id="visit_date" placeholder="æ ¼å¼ç¯„ä¾‹ï¼š113å¹´12æœˆ13æ—¥">
        </div>

        <button class="action-btn" onclick="generateWord()">ğŸ“ ä¸‹è¼‰ Word å¥‘ç´„æ›¸</button>
    </div>

    <script>
        // è¨­å®š PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // æ°‘åœ‹å¹´è½‰æ›
        function getRocDate() {
            const today = new Date();
            return `${today.getFullYear() - 1911}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
        }

        // è¨ˆç®—çµæŸæ—¥æœŸ (å¾€å¾Œæ¨3å€‹æœˆ)
        function calculateEndDate(dateStr) {
            try {
                const match = dateStr.match(/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/);
                if (!match) return dateStr;
                let [_, y, m, d] = match.map(Number);
                let newM = m + 3;
                let newY = y;
                if (newM > 12) { newY++; newM -= 12; }
                return `${newY}å¹´${newM}æœˆ${d}æ—¥`; // ç°¡åŒ–ç‰ˆï¼Œä¸è™•ç†å¤§å°æœˆæº¢ä½
            } catch (e) { return ""; }
        }

        // --- æ ¸å¿ƒï¼šè®€å– PDF ä¸¦åˆ†æ ---
        async function processPDF() {
            const file = document.getElementById('pdfInput').files[0];
            if (!file) return;

            const status = document.getElementById('status');
            status.innerText = "â³ æ­£åœ¨åˆ†æ PDF...";

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = "";
                let page1Text = "";
                let page13Text = "";

                // è®€å–æ¯ä¸€é 
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageStr = textContent.items.map(item => item.str).join(" "); // ç°¡å–®ä¸²æ¥
                    fullText += pageStr + "\n";
                    if (i === 1) page1Text = pageStr;
                    if (i === 13) page13Text = pageStr;
                }
                
                status.innerText = "âœ… åˆ†æå®Œæˆï¼Œè«‹ç¢ºèªä¸‹æ–¹è³‡æ–™";
                analyzeText(fullText, page1Text, page13Text);
                
                // é–‹å•Ÿç·¨è¼¯å€
                document.getElementById('formCard').style.opacity = "1";
                document.getElementById('formCard').style.pointerEvents = "auto";

            } catch (e) {
                console.error(e);
                status.innerText = "âŒ PDF è®€å–å¤±æ•—ï¼š" + e.message;
            }
        }

        // --- æ ¸å¿ƒï¼šæ­£å‰‡è¡¨é”å¼åˆ†æ (å°æ‡‰åŸæœ¬çš„ Python é‚è¼¯) ---
        function analyzeText(fullText, page1Text, page13Text) {
            // å§“å
            let nameMatch = fullText.match(/å€‹æ¡ˆå§“å[:ï¼š]?\s*([^\s/]+)/) || fullText.match(/å€‹æ¡ˆå§“å\s+([\u4e00-\u9fa5]{2,4})/);
            let userName = nameMatch ? nameMatch[1].trim() : "";
            
            // èº«åˆ†è­‰
            let idMatch = fullText.match(/([A-Z][0-9]{9})/);
            let userId = idMatch ? idMatch[0] : "";

            // é›»è©±
            let phoneMatch = fullText.match(/[A-Z][0-9]{9}\s+(09\d{8}|0\d{1,2}-?\d{6,8})/) || fullText.match(/é›»è©±\s*[:ï¼š]?\s*(09\d{8}|0\d{1,2}-?\d{6,8})/);
            let userPhone = phoneMatch ? phoneMatch[1] : "";

            // åœ°å€
            let hMatch = fullText.match(/æˆ¶ç±åœ°å€\s+([^\nâ€»]+)/);
            let householdAddr = hMatch ? hMatch[1].trim() : "";
            
            let cMatch = fullText.match(/å±…ä½\(é€šè¨Š\)åœ°\s+([^\n]+)/);
            let contactAddr = "";
            if (cMatch) {
                contactAddr = cMatch[1].replace("å€", "").replace(/\(éƒµéå€è™Ÿ[:ï¼š].*?\)/, "").trim();
            }

            // ç¦åˆ©èº«åˆ† (Python: (?<![\d]\.)(ç¬¬\s*[ä¸€äºŒä¸‰]\s*é¡))
            // JS ä¸æ”¯æ´ Lookbehind (åœ¨èˆŠç€è¦½å™¨)ï¼Œæ‰€ä»¥ç”¨ç°¡å–®ç‰ˆåˆ¤æ–·
            let welfareText = "";
            const welfareRegex = /(ç¬¬\s*[ä¸€äºŒä¸‰]\s*é¡)/;
            
            if (page1Text.match(welfareRegex)) welfareText = page1Text.match(welfareRegex)[1];
            else if (page13Text.match(welfareRegex)) welfareText = page13Text.match(welfareRegex)[1];

            let payment = "240";
            if (welfareText) {
                if (welfareText.includes("ç¬¬ä¸€é¡")) payment = "0";
                else if (welfareText.includes("ç¬¬äºŒé¡")) payment = "160";
            } else {
                if (fullText.includes("ä½æ”¶") && !fullText.includes("ä¸­ä½")) payment = "0";
                else if (fullText.includes("ä¸­ä½")) payment = "160";
            }

            // ä»£ç†äºº
            let agentMatch = fullText.match(/ä»£ç†äººå§“å\s+([^\s]+)/);
            let conName = userName;
            let conPhone = userPhone;
            
            if (agentMatch) {
                let possibleName = agentMatch[1].trim();
                if (possibleName.length > 1 && !possibleName.includes("å§“å")) {
                    conName = possibleName;
                    let agentPhoneMatch = fullText.match(/ä»£ç†äººæ‰‹æ©Ÿ\s*(09\d{8}|0\d{1,2}-?\d{6,8})/);
                    if (agentPhoneMatch) conPhone = agentPhoneMatch[1];
                }
            }

            // å¡«å…¥è¡¨å–®
            document.getElementById('user_name').value = userName;
            document.getElementById('user_id').value = userId;
            document.getElementById('user_phone').value = userPhone;
            document.getElementById('household_address').value = householdAddr;
            document.getElementById('contact_address').value = contactAddr || householdAddr;
            document.getElementById('payment').value = payment;
            document.getElementById('contractor_name').value = conName;
            document.getElementById('contractor_phone').value = conPhone;
            document.getElementById('visit_date').value = getRocDate();
        }

        // --- æ ¸å¿ƒï¼šç”¢ç”Ÿ Word ---
        async function generateWord() {
            const btn = document.querySelector('button.action-btn');
            btn.innerText = "è™•ç†ä¸­...";
            btn.disabled = true;

            try {
                // 1. è¼‰å…¥ Template (å¿…é ˆæ”¾åœ¨åŒä¸€ç›®éŒ„ä¸‹)
                const response = await fetch('template.docx');
                if (!response.ok) throw new Error("æ‰¾ä¸åˆ° template.docxï¼Œè«‹ç¢ºèªæª”æ¡ˆå·²ä¸Šå‚³åˆ° GitHubã€‚");
                const content = await response.arrayBuffer();

                // 2. æº–å‚™è³‡æ–™
                const visitDate = document.getElementById('visit_date').value;
                const data = {
                    user_name: document.getElementById('user_name').value,
                    user_id: document.getElementById('user_id').value,
                    user_phone: document.getElementById('user_phone').value,
                    payment: document.getElementById('payment').value,
                    contractor_name: document.getElementById('contractor_name').value,
                    contractor_phone: document.getElementById('contractor_phone').value,
                    household_address: document.getElementById('household_address').value,
                    contact_address: document.getElementById('contact_address').value,
                    visit_date: visitDate,
                    end_date: calculateEndDate(visitDate)
                };

                // 3. æ¸²æŸ“
                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });

                doc.render(data);

                // 4. ä¸‹è¼‰
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
                
                const fileName = `ç¾©å¤§é†«é™¢å¥‘ç´„æ›¸_${data.user_name}.docx`;
                saveAs(blob, fileName);
                
            } catch (error) {
                alert("ç”¢ç”Ÿå¤±æ•—ï¼š" + error.message);
                console.error(error);
            } finally {
                btn.innerText = "ğŸ“ ä¸‹è¼‰ Word å¥‘ç´„æ›¸";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
