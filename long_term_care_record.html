<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±è¨ºæ–·æ¨¡å¼ (V13 é‡å°æ€§åµéŒ¯)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { font-family: monospace; padding: 20px; background: #2c3e50; color: #fff; }
        .container { max-width: 900px; margin: 0 auto; }
        textarea { width: 100%; height: 500px; background: #000; color: #0f0; padding: 15px; border: 2px solid #f1c40f; font-size: 14px; line-height: 1.6; }
        button { padding: 15px 30px; font-size: 18px; background: #3498db; color: white; border: none; cursor: pointer; width: 100%; margin-bottom: 20px; }
        .box { margin-bottom: 20px; border: 1px solid #7f8c8d; padding: 10px; }
        h3 { color: #f39c12; margin-top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ï¸ V13 é‡å°æ€§è¨ºæ–· (ä»£ç†äºº/CMS/ç–¾ç—…)</h1>
        <p>è«‹ä¸Šå‚³ PDFï¼Œæˆ‘å€‘ä¾†æŠ“å‡ºé‚£å€‹ã€Œè­‰ã€å­—å’Œã€Œæ‹¬è™Ÿã€æ˜¯æ€éº¼ä¾†çš„ã€‚</p>
        <input type="file" id="pdf_upload" accept="application/pdf" style="margin-bottom: 20px;">
        <button onclick="runDebug()">â–¶ï¸ é–‹å§‹è¨ºæ–·</button>
        
        <textarea id="debug_log" readonly>ç­‰å¾…åŸ·è¡Œ...</textarea>
    </div>

<script>
    function log(msg) { 
        const el = document.getElementById('debug_log');
        el.value += msg + "\n";
        el.scrollTop = el.scrollHeight;
    }

    // ä½¿ç”¨è·Ÿæ­£å¼ç‰ˆä¸€æ¨£çš„æ¸…ç†é‚è¼¯
    function cleanTextDeep(text) {
        return text.normalize('NFKC') // è½‰å…¨å½¢ç‚ºåŠå½¢ï¼Œè§£æ±ºåº·ç†™éƒ¨é¦–
                   .replace(/[\n\r]/g, "") // ç§»é™¤æ›è¡Œ
                   .replace(/â€»/g, "")
                   .replace(/\(é‡Œ[ã€ï¼Œ]é„°[ã€ï¼Œ]éƒµéå€è™Ÿ.*?\)/g, "")
                   .replace(/[()]/g, "ï¼ˆï¼‰") // é€™è£¡æˆ‘å€‘å…ˆæ•…æ„è½‰æˆå…¨å½¢æ‹¬è™Ÿè§€å¯Ÿ
                   .replace(/ï¼ˆ/g, "(").replace(/ï¼‰/g, ")"); // å†è½‰å›åŠå½¢
    }

    async function runDebug() {
        const fileInput = document.getElementById('pdf_upload');
        if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡ PDF!"); return; }
        
        document.getElementById('debug_log').value = "=== è¨ºæ–·é–‹å§‹ ===\n";
        
        try {
            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join("");
            }

            // 1. é¡¯ç¤ºåŸå§‹æœªæ¸…ç†çš„ç‰‡æ®µ (ä»£ç†äºº)
            log("--- [1. ä»£ç†äººå€åŸŸ - åŸå§‹ç¢¼] ---");
            const agentIndex = fullText.indexOf("ä»£ç†äºº");
            if (agentIndex !== -1) {
                log(fullText.substring(agentIndex, agentIndex + 400));
            } else {
                log("âŒ æ‰¾ä¸åˆ° 'ä»£ç†äºº'");
            }

            // 2. é¡¯ç¤ºåŸå§‹æœªæ¸…ç†çš„ç‰‡æ®µ (CMS)
            log("\n--- [2. CMS ç­‰ç´š - å€’æ•¸æœå°‹] ---");
            const lastCmsIndex = fullText.lastIndexOf("CMSç­‰ç´š");
            if (lastCmsIndex !== -1) {
                log(fullText.substring(lastCmsIndex, lastCmsIndex + 300));
            } else {
                log("âŒ æ‰¾ä¸åˆ° 'CMSç­‰ç´š'");
            }

            // 3. é¡¯ç¤ºåŸå§‹æœªæ¸…ç†çš„ç‰‡æ®µ (ç–¾ç—… 03)
            log("\n--- [3. ç–¾ç—…å€åŸŸ (éª¨éª¼ç³»çµ±) - æ‹¬è™Ÿæª¢æŸ¥] ---");
            const boneIndex = fullText.indexOf("éª¨éª¼ç³»çµ±");
            if (boneIndex !== -1) {
                const rawChunk = fullText.substring(boneIndex - 20, boneIndex + 100);
                log("åŸå§‹æ–‡å­—: " + rawChunk);
                log("æ¸…ç†å¾Œæ–‡å­—: " + cleanTextDeep(rawChunk));
            } else {
                log("âŒ æ‰¾ä¸åˆ° 'éª¨éª¼ç³»çµ±'");
            }

            log("\n=== è¨ºæ–·çµæŸ ===");

        } catch (err) {
            log("éŒ¯èª¤: " + err.message);
        }
    }
</script>
</body>
</html>
