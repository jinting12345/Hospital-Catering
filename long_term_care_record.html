<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·ç…§åˆç´„ - ç³»çµ±è¨ºæ–·æ¨¡å¼ (Debug Mode)</title>
    
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        window.createClient = createClient;
    </script>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.37.11/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; background-color: #2c3e50; color: #ecf0f1; }
        .container { background: #34495e; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .header h1 { color: #e74c3c; margin: 0; text-align: center; }
        .header p { text-align: center; color: #bdc3c7; }
        
        .upload-box { border: 2px dashed #95a5a6; border-radius: 8px; padding: 30px; text-align: center; background: #2c3e50; margin: 20px 0; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-parse { background-color: #3498db; }
        
        /* Debug å€åŸŸ */
        .debug-section { margin-top: 20px; background: #000; padding: 15px; border-radius: 8px; border: 1px solid #f1c40f; }
        .debug-title { color: #f1c40f; font-weight: bold; margin-bottom: 10px; font-size: 1.2em; }
        textarea { width: 100%; height: 300px; background: #111; color: #0f0; border: none; padding: 10px; font-family: monospace; font-size: 13px; line-height: 1.5; resize: vertical; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 10000; color: white; font-size: 20px; }
    </style>
</head>
<body>

<div id="loading-overlay">æ­£åœ¨å¼·åŠ›è§£æ PDF åŸå§‹ç¢¼...</div>

<div class="container">
    <div class="header">
        <h1>ğŸ› ï¸ ç³»çµ±è¨ºæ–·æ¨¡å¼</h1>
        <p>è«‹ä¸Šå‚³ PDFï¼Œç³»çµ±å°‡æœƒã€ŒåŸå½¢ç•¢éœ²ã€é¡¯ç¤ºå®ƒçœ‹åˆ°çš„å…§å®¹</p>
    </div>

    <div class="upload-box">
        <input type="file" id="pdf_upload" accept="application/pdf" />
        <button class="btn btn-parse" onclick="runDebug()">ğŸ” åŸ·è¡Œè¨ºæ–· (Run Debug)</button>
    </div>

    <div class="debug-section">
        <div class="debug-title">ğŸ è¨ºæ–·å ±å‘Š (è«‹è¤‡è£½ä¸‹æ–¹æ‰€æœ‰æ–‡å­—çµ¦æˆ‘)</div>
        <textarea id="debug_log" readonly>ç­‰å¾…åŸ·è¡Œ...</textarea>
    </div>
</div>

<script>
    if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
    } else {
        window.onload = function() {
            if (window.pdfjsLib) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
            }
        };
    }

    function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
    function log(msg) { 
        const el = document.getElementById('debug_log');
        el.value += msg + "\n";
        el.scrollTop = el.scrollHeight;
    }

    // ä¸åšä»»ä½•æ¸…ç†ï¼Œä¿ç•™æœ€åŸå§‹çš„æ¨£å­ï¼Œä»¥ä¾¿ç™¼ç¾éš±è—ç¬¦è™Ÿ
    function cleanTextDeep(text) {
        // åªç§»é™¤æ›è¡Œï¼Œå…¶ä»–ä¿ç•™ï¼Œè®“æˆ‘å€‘çœ‹çœ‹æ˜¯ä¸æ˜¯æœ‰å¥‡æ€ªçš„ç©ºæ ¼æˆ–ç¬¦è™Ÿ
        return text.replace(/[\n\r]/g, ""); 
    }

    async function runDebug() {
        const fileInput = document.getElementById('pdf_upload');
        if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡ PDF!"); return; }
        
        document.getElementById('debug_log').value = "=== é–‹å§‹è¨ºæ–· ===\n";
        showLoading(true);

        try {
            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join("");
            }

            // 1. å–å¾—åŸå§‹å­—ä¸² (ç§»é™¤æ›è¡Œæ–¹ä¾¿æœå°‹)
            const cleanText = cleanTextDeep(fullText);
            
            log("PDF ç¸½å­—æ•¸: " + cleanText.length);
            log("--------------------------------------------------");

            // === è¨ºæ–· A: CMS ç­‰ç´š ===
            // æœå°‹ "CMS" é—œéµå­—ï¼Œä¸¦æŠ“å–å‰å¾Œ 200 å­—
            const cmsIndex = cleanText.indexOf("CMS");
            if (cmsIndex !== -1) {
                log("ã€CMS å€åŸŸåŸå§‹ç¢¼ã€‘");
                // æŠ“å– CMS å‰å¾Œç¯„åœ
                const cmsContext = cleanText.substring(cmsIndex, cmsIndex + 300);
                log(cmsContext);
                
                // å˜—è©¦åˆ†æ
                const match = cmsContext.match(/CMSç­‰ç´š.*?(\d+)/);
                if (match) {
                    log(`>> ç¨‹å¼åˆæ­¥å˜—è©¦æŠ“åˆ°: ${match[1]}`);
                } else {
                    log(">> ç¨‹å¼ç›®å‰æŠ“ä¸åˆ° CMS æ•¸å€¼ï¼Œå› ç‚ºæ ¼å¼ä¸ç¬¦åˆé æœŸ");
                }
            } else {
                log("ã€åš´é‡è­¦å‘Šã€‘æ‰¾ä¸åˆ° 'CMS' é—œéµå­—ï¼Œå¯èƒ½æ˜¯åœ–ç‰‡æˆ–é—œéµå­—ä¸åŒ");
            }
            
            log("--------------------------------------------------");

            // === è¨ºæ–· B: ååš¥å›°é›£ (G6a) ===
            // æœå°‹ "G6a" æˆ– "ååš¥"
            let swallowIndex = cleanText.indexOf("G6a");
            if (swallowIndex === -1) swallowIndex = cleanText.indexOf("ååš¥èƒ½åŠ›");
            
            if (swallowIndex !== -1) {
                log("ã€ååš¥ (G6a) å€åŸŸåŸå§‹ç¢¼ã€‘");
                // æŠ“å– G6a å¾€å¾Œ 800 å­—
                const swallowContext = cleanText.substring(swallowIndex, swallowIndex + 800);
                log(swallowContext);
                
                // å˜—è©¦åˆ†æç¬¬3é …
                if (swallowContext.includes("3.åƒæ±è¥¿")) {
                    log(">> æœ‰ç™¼ç¾ '3.åƒæ±è¥¿' çš„æ–‡å­—");
                    // æª¢æŸ¥å‰é¢æœ‰æ²’æœ‰å‹¾
                    const index3 = swallowContext.indexOf("3.åƒæ±è¥¿");
                    const prefix = swallowContext.substring(index3 - 10, index3);
                    log(`>> '3.åƒæ±è¥¿' å‰é¢çš„ 10 å€‹å­—å…ƒæ˜¯: [${prefix}]`);
                    log("   (è«‹æª¢æŸ¥æ‹¬è™Ÿå…§æ˜¯å¦æœ‰ â˜‘ æˆ– â–  æˆ–å…¶ä»–ç¬¦è™Ÿ)");
                } else {
                    log(">> è­¦å‘Šï¼šæ‰¾ä¸åˆ° '3.åƒæ±è¥¿' é¸é …æ–‡å­—");
                }
            } else {
                log("ã€åš´é‡è­¦å‘Šã€‘æ‰¾ä¸åˆ° 'G6a' æˆ– 'ååš¥èƒ½åŠ›' é—œéµå­—");
            }

            log("\n=== è¨ºæ–·çµæŸï¼Œè«‹è¤‡è£½ä»¥ä¸Šå…§å®¹ ===\n");
            showLoading(false);

        } catch (err) {
            showLoading(false);
            log("éŒ¯èª¤: " + err.message);
        }
    }
</script>

</body>
</html>
