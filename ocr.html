<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…æ­·è™Ÿèˆ‡å§“åè¾¨è­˜å·¥å…·</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #1a73e8; display: flex; align-items: center; gap: 10px; }
        
        /* ä¸Šå‚³å€å¡Š */
        .upload-area { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; background: #f8fafc; }
        .upload-area:hover { border-color: #1a73e8; background: #e8f0fe; }
        .upload-icon { font-size: 40px; color: #1a73e8; margin-bottom: 10px; }
        
        /* åœ–ç‰‡é è¦½ */
        #preview-container { display: none; margin-top: 20px; text-align: center; }
        #preview-img { max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* é€²åº¦æ¢ */
        .progress-container { margin-top: 20px; display: none; }
        .progress-bar { width: 100%; height: 10px; background-color: #e2e8f0; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background-color: #1a73e8; transition: width 0.3s ease; }
        .status-text { margin-top: 5px; font-size: 14px; color: #64748b; text-align: center; }

        /* çµæœè¡¨æ ¼ */
        .result-section { display: none; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background-color: #f8fafc; color: #475569; font-weight: bold; }
        input[type="text"] { width: 90%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 16px; }
        input[type="text"]:focus { border-color: #1a73e8; outline: none; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: #1a73e8; }
        .btn-primary:hover { background-color: #1557b0; }
        .btn-success { background-color: #10b981; }
        .btn-success:hover { background-color: #059669; }
        .btn:disabled { background-color: #cbd5e0; cursor: not-allowed; }

        .note { font-size: 13px; color: #e11d48; margin-top: 10px; background: #fff1f2; padding: 10px; border-radius: 6px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“· ç—…æ­·å–®è¾¨è­˜ç³»çµ± (OCR)</h2>
    <p style="color:#666; font-size:14px;">è«‹ä¸Šå‚³åŒ…å«ã€Œç—…æ­·è™Ÿã€èˆ‡ã€Œå§“åã€çš„ç…§ç‰‡ï¼Œç³»çµ±å°‡è‡ªå‹•æ“·å–è³‡æ–™ã€‚</p>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">ğŸ“¤</div>
        <div>é»æ“Šä¸Šå‚³åœ–ç‰‡ æˆ– æ‹ç…§</div>
        <div style="font-size:12px; color:#999; margin-top:5px;">æ”¯æ´ JPG, PNG</div>
    </div>
    <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFileSelect(this)">

    <div id="preview-container">
        <img id="preview-img">
    </div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="status-text" id="statusText">æº–å‚™ä¸­...</div>
    </div>
    
    <div class="note" id="warningNote">âš ï¸ æç¤ºï¼šè¢å…‰ç­†åŠƒè¨˜çš„éƒ¨åˆ†å¯èƒ½æœƒå½±éŸ¿è¾¨è­˜ï¼Œè«‹æª¢æŸ¥çµæœä¸¦æ‰‹å‹•ä¿®æ­£ã€‚</div>

    <div class="result-section" id="resultSection">
        <h3>âœ… è¾¨è­˜çµæœ (å¯ç›´æ¥ä¿®æ”¹)</h3>
        <table id="resultTable">
            <thead>
                <tr>
                    <th width="40%">ç—…æ­·è™Ÿ</th>
                    <th width="60%">å§“å</th>
                    <th width="40">ğŸ—‘ï¸</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="btn-group">
            <button class="btn btn-primary" onclick="copyToClipboard()">ğŸ“‹ è¤‡è£½è³‡æ–™</button>
            <button class="btn btn-success" onclick="location.reload()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
    </div>
</div>

<script>
    let worker;

    async function handleFileSelect(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];

        // é¡¯ç¤ºé è¦½
        const img = document.getElementById('preview-img');
        img.src = URL.createObjectURL(file);
        document.getElementById('preview-container').style.display = 'block';
        
        // é–‹å§‹è¾¨è­˜æµç¨‹
        await runOCR(file);
    }

    async function runOCR(file) {
        const pContainer = document.getElementById('progressContainer');
        const pFill = document.getElementById('progressFill');
        const status = document.getElementById('statusText');
        const resultSection = document.getElementById('resultSection');
        const warning = document.getElementById('warningNote');

        pContainer.style.display = 'block';
        resultSection.style.display = 'none';
        warning.style.display = 'none';

        try {
            worker = await Tesseract.createWorker({
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const pct = Math.round(m.progress * 100);
                        pFill.style.width = pct + '%';
                        status.innerText = `ğŸ” æ­£åœ¨åˆ†ææ–‡å­—... ${pct}%`;
                    } else if (m.status === 'loading tesseract core') {
                        status.innerText = `âš™ï¸ åˆå§‹åŒ–æ ¸å¿ƒ...`;
                    } else {
                        status.innerText = `ğŸ“¥ ä¸‹è¼‰èªè¨€åŒ…... (åˆæ¬¡åŸ·è¡Œéœ€ç´„ 10ç§’)`;
                    }
                }
            });

            // è¼‰å…¥ç¹é«”ä¸­æ–‡èˆ‡è‹±æ–‡
            await worker.loadLanguage('chi_tra+eng');
            await worker.initialize('chi_tra+eng');

            // åŸ·è¡Œè¾¨è­˜
            const { data: { text } } = await worker.recognize(file);
            
            // è§£æè³‡æ–™
            const parsedData = parseTextToData(text);
            
            // æ¸²æŸ“è¡¨æ ¼
            renderTable(parsedData);

            await worker.terminate(); // é‡‹æ”¾è³‡æº
            
            pContainer.style.display = 'none';
            resultSection.style.display = 'block';
            warning.style.display = 'block';

        } catch (err) {
            console.error(err);
            status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤: " + err.message;
            status.style.color = "red";
        }
    }

    // ğŸ”¥ æ ¸å¿ƒé‚è¼¯ï¼šå¾é›œäº‚çš„æ–‡å­—ä¸­æŠ“å‡ºç—…æ­·è™Ÿå’Œåå­—
    function parseTextToData(rawText) {
        const lines = rawText.split('\n');
        const results = [];

        lines.forEach(line => {
            // 1. æ¸…ç†å­—ä¸² (ç§»é™¤å¤šé¤˜ç©ºç™½)
            const cleanLine = line.replace(/\s+/g, ' ').trim();

            // 2. å¿½ç•¥é¡¯ç„¶æ˜¯æ¨™é¡Œçš„è¡Œ
            if (cleanLine.includes('ç—…æ­·è™Ÿ') || cleanLine.includes('å§“å') || cleanLine.length < 5) return;

            // 3. æ­£è¦è¡¨é”å¼åŒ¹é…
            // è¦å‰‡ï¼šå°‹æ‰¾ 5~8 ä½æ•¸å­— (ç—…æ­·è™Ÿ)
            const mrnMatch = cleanLine.match(/(\d{5,8})/);
            
            // è¦å‰‡ï¼šå°‹æ‰¾ 2~4 å€‹é€£çºŒä¸­æ–‡å­— (å§“å)
            // æ’é™¤å¸¸è¦‹éå§“åè©å½™ï¼šè¤‡è¨ºã€è³‡æ–™ã€é½Šå…¨ã€æ–°æ”¶æ¡ˆ
            const nameMatch = cleanLine.match(/[\u4e00-\u9fa5]{2,4}/g);

            if (mrnMatch) {
                const mrn = mrnMatch[0];
                let name = '';

                if (nameMatch) {
                    // éæ¿¾æ‰çœ‹èµ·ä¾†ä¸åƒåå­—çš„è©
                    const blacklist = ['è¤‡è¨º', 'è³‡æ–™', 'é½Šå…¨', 'æ”¶æ¡ˆ', 'é†«å¸«', 'ç¢ºèª', 'å–®å…§', 'åˆä½µ', 'è¨»è¨˜'];
                    const potentialNames = nameMatch.filter(n => !blacklist.some(bad => n.includes(bad)));
                    
                    if (potentialNames.length > 0) {
                        // é€šå¸¸åå­—æœƒé›¢ç—…æ­·è™Ÿæœ€è¿‘ï¼Œé€™è£¡ç°¡å–®å–ç¬¬ä¸€å€‹ç¯©é¸å¾Œçš„çµæœ
                        name = potentialNames[0];
                    }
                }

                // åªæœ‰ç•¶è‡³å°‘æœ‰ç—…æ­·è™Ÿæ™‚æ‰åˆ—å‡º (æœ‰äº›åªæœ‰åå­—æ²’æœ‰è™Ÿç¢¼çš„å¯èƒ½æ˜¯é›œè¨Š)
                if (mrn) {
                    results.push({ mrn, name });
                }
            }
        });

        return results;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:red;">âš ï¸ æœªåµæ¸¬åˆ°ç¬¦åˆæ ¼å¼çš„è³‡æ–™ï¼Œè«‹ç¢ºèªç…§ç‰‡æ¸…æ™°åº¦ã€‚</td></tr>';
            return;
        }

        data.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" value="${row.mrn}"></td>
                <td><input type="text" value="${row.name}" placeholder="æœªè¾¨è­˜å‡ºå§“å"></td>
                <td style="cursor:pointer; text-align:center;" onclick="this.parentElement.remove()">âŒ</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function copyToClipboard() {
        // æŠ“å–ç›®å‰è¡¨æ ¼å…§ä¿®æ­£å¾Œçš„è³‡æ–™
        const rows = document.querySelectorAll('#tableBody tr');
        let text = "ç—…æ­·è™Ÿ\tå§“å\n"; // Excel æ ¼å¼æ¨™é ­
        
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            if (inputs.length > 0) {
                const mrn = inputs[0].value;
                const name = inputs[1].value;
                text += `${mrn}\t${name}\n`;
            }
        });

        navigator.clipboard.writeText(text).then(() => {
            alert('âœ… è³‡æ–™å·²è¤‡è£½ï¼\n\næ‚¨å¯ä»¥ç›´æ¥è²¼ä¸Šåˆ° Excel æˆ–å…¶ä»–è¡¨æ ¼ä¸­ã€‚');
        }).catch(err => {
            alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–');
        });
    }
</script>

</body>
</html>
