<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…æ­·å–®è¾¨è­˜ (æ¥µé€Ÿç‰ˆ)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        h2 { margin: 0 0 15px 0; color: #1a73e8; font-size: 1.3rem; }
        
        /* ç‹€æ…‹å€ */
        .status-box { background: #e8f0fe; color: #1557b0; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; border: 1px solid #d2e3fc; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .error-box { background: #fee2e2; color: #b91c1c; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; text-align: left; font-size: 14px; border: 1px solid #fecaca; }

        /* é€²åº¦æ¢ */
        .progress-wrapper { margin: 15px 0; display: none; }
        .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #28a745; transition: width 0.3s; }
        .progress-text { font-size: 12px; color: #666; margin-top: 5px; }

        /* é›™æŒ‰éˆ•è¨­è¨ˆ */
        .action-group { display: flex; gap: 12px; margin-top: 20px; }
        .btn-action { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.98); }
        
        /* ç¶ è‰²æ‹ç…§æŒ‰éˆ• */
        .btn-camera { background: linear-gradient(135deg, #28a745, #218838); }
        /* é»ƒè‰²é¸åœ–æŒ‰éˆ• */
        .btn-gallery { background: linear-gradient(135deg, #ffc107, #e0a800); color: #333; }
        /* ç°è‰²ç¦ç”¨ç‹€æ…‹ */
        .btn-disabled { background: #ccc; cursor: not-allowed; box-shadow: none; color: #666; }

        .btn-back { display:inline-block; margin-bottom:15px; text-decoration:none; color:#666; font-size:14px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 20px; background: white;}

        #preview-img { max-width: 100%; border-radius: 8px; margin-top: 15px; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #eee; }
        
        /* çµæœè¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 15px; }
        th { background-color: #f8fafc; color: #64748b; font-size: 14px; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; color: #333; }
    </style>
</head>
<body>

<a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>

<div class="card">
    <h2>ğŸ“· ç—…æ­·è¾¨è­˜ (è¼•é‡ç‰ˆ)</h2>
    
    <div id="statusBox" class="status-box">
        <span>ğŸ’¤</span> ç³»çµ±å¾…å‘½ (é¦–æ¬¡éœ€ä¸‹è¼‰ 3MB)
    </div>
    
    <div id="errorBox" class="error-box"></div>

    <div class="progress-wrapper" id="pWrapper">
        <div class="progress-bar"><div class="progress-fill" id="pFill"></div></div>
        <div class="progress-text" id="pText">æº–å‚™ä¸­...</div>
    </div>

    <div class="action-group">
        <button id="btnCam" class="btn-action btn-camera" onclick="startOCR('camera')">
            <span style="font-size:24px">ğŸ“¸</span>
            æ‹ ç…§
        </button>
        <button id="btnGal" class="btn-action btn-gallery" onclick="startOCR('gallery')">
            <span style="font-size:24px">ğŸ–¼ï¸</span>
            é¸ç…§ç‰‡
        </button>
    </div>
    
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="processFile(this)">
    <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="processFile(this)">

    <img id="preview-img">

    <div id="resultArea" style="display:none; margin-top:20px;">
        <h3 style="margin:0 0 10px 0; color:#333; font-size:16px; text-align:left;">âœ… è¾¨è­˜çµæœ</h3>
        <table id="resultTable">
            <thead>
                <tr><th width="35%">ç—…æ­·è™Ÿ</th><th width="50%">å§“å</th><th width="15%"></th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="copyResult()" style="flex:1; padding:12px; background:#1a73e8; color:white; border:none; border-radius:8px; font-weight:bold;">ğŸ“‹ è¤‡è£½çµæœ</button>
            <button onclick="location.reload()" style="flex:1; padding:12px; background:#f1f3f4; color:#333; border:none; border-radius:8px; font-weight:bold;">ğŸ”„ æ¸…é™¤é‡ä¾†</button>
        </div>
    </div>
</div>

<script>
    let worker = null;
    let isWorkerReady = false;

    async function startOCR(type) {
        // 1. å¦‚æœå¼•æ“é‚„æ²’æº–å‚™å¥½ï¼Œå…ˆåˆå§‹åŒ–
        if (!isWorkerReady) {
            await initWorker();
            if (!isWorkerReady) return; // å¦‚æœåˆå§‹åŒ–å¤±æ•—å‰‡åœæ­¢
        }

        // 2. è§¸ç™¼å°æ‡‰çš„ input
        if (type === 'camera') {
            document.getElementById('cameraInput').click();
        } else {
            document.getElementById('galleryInput').click();
        }
    }

    async function initWorker() {
        const status = document.getElementById('statusBox');
        const pWrapper = document.getElementById('pWrapper');
        const pFill = document.getElementById('pFill');
        const pText = document.getElementById('pText');
        const btns = document.querySelectorAll('.btn-action');

        // é–å®šæŒ‰éˆ•
        btns.forEach(b => { b.classList.add('btn-disabled'); b.disabled = true; });
        pWrapper.style.display = 'block';
        
        try {
            status.innerHTML = "ğŸš€ æ­£åœ¨ä¸‹è¼‰è¼•é‡ç‰ˆæ ¸å¿ƒ (3MB)...";
            pFill.style.width = '10%';

            // ğŸŒŸ é—œéµä¿®æ”¹ï¼šå¼·åˆ¶ä½¿ç”¨ fast (è¼•é‡) èªè¨€åŒ…è·¯å¾‘
            worker = await Tesseract.createWorker({
                langPath: 'https://raw.githubusercontent.com/naptha/tessdata/gh-pages/4.0.0_fast', 
                logger: m => {
                    if (m.status.includes('loading')) {
                        // æ¨¡æ“¬é€²åº¦
                        if(m.progress < 1) pFill.style.width = (m.progress * 50) + '%';
                        pText.innerText = "æ­£åœ¨ä¸‹è¼‰ AI æ¨¡å‹ (è«‹ä¿æŒç¶²è·¯æš¢é€š)...";
                    } else if (m.status.includes('initializing')) {
                        pFill.style.width = '70%';
                        pText.innerText = "æ­£åœ¨å•Ÿå‹•å¼•æ“...";
                    }
                }
            });

            pText.innerText = "è¼‰å…¥ç¹é«”ä¸­æ–‡...";
            await worker.loadLanguage('chi_tra');
            await worker.initialize('chi_tra');
            
            // è¨­å®šåƒæ•¸ (åªæŠ“æ•¸å­—å’Œç¹é«”ä¸­æ–‡ï¼Œéæ¿¾é›œè¨Š)
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789æ—é™³æé»ƒå¼µç‹å³åŠ‰è”¡æ¥Šè¨±é„­è¬éƒ­æ´ªæ›¾é‚±å»–è³´å‘¨å¾è˜‡è‘‰èŠå‘‚æ±Ÿä½•è•­ç¾…é«˜æ½˜ç°¡æœ±é¾å½­æ¸¸è©¹èƒ¡æ–½æ²ˆä½™ç›§æ¢è¶™é¡æŸ¯å­«é­ç¿æˆ´èŒƒå®‹é„§æœä¾¯æ›¹è–›å‚…ä¸æ¸©ç´€è”£æ­è—é€£é¦¬è‘£å¤æ¹¯é–»ç°¡ä¸çŸ¥å±±æ°´æœ¨åœŸé‡‘ç«æ—¥æœˆ' 
                // ä¸Šé¢æ˜¯å¸¸ç”¨å§“æ°ç™½åå–®ï¼ŒåŠ ä¸Šæ•¸å­—ï¼Œå¹«åŠ©æ¿¾é™¤äº‚ç¢¼
            });

            isWorkerReady = true;
            status.innerHTML = "âœ… ç³»çµ±å°±ç·’";
            status.style.background = "#d1e7dd";
            status.style.color = "#0f5132";
            
            pWrapper.style.display = 'none';

        } catch (err) {
            console.error(err);
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorBox').innerHTML = `<strong>å•Ÿå‹•å¤±æ•—</strong><br>${err.message}<br><br>è«‹ç¢ºèªæ‰‹æ©Ÿç¶²è·¯æ˜¯å¦æ­£å¸¸ã€‚`;
            status.innerHTML = "âŒ ç™¼ç”ŸéŒ¯èª¤";
        } finally {
            // è§£é–æŒ‰éˆ•
            btns.forEach(b => { b.classList.remove('btn-disabled'); b.disabled = false; });
        }
    }

    async function processFile(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const status = document.getElementById('statusBox');
        const img = document.getElementById('preview-img');
        const pWrapper = document.getElementById('pWrapper');
        const pFill = document.getElementById('pFill');
        const pText = document.getElementById('pText');

        // é¡¯ç¤ºåœ–ç‰‡
        img.src = URL.createObjectURL(file);
        img.style.display = 'block';
        document.getElementById('resultArea').style.display = 'none';
        pWrapper.style.display = 'block';
        
        try {
            status.innerHTML = "âš¡ æ­£åœ¨å£“ç¸®åœ–ç‰‡...";
            pFill.style.width = '10%';
            
            // æ¥µé™å£“ç¸®ï¼šå¯¬åº¦é™åˆ¶ 800pxï¼Œå“è³ª 0.6
            const compressedFile = await imageCompression(file, { 
                maxSizeMB: 0.5, 
                maxWidthOrHeight: 800,
                useWebWorker: true 
            });
            
            status.innerHTML = "ğŸ” æ­£åœ¨è¾¨è­˜æ–‡å­—...";
            pFill.style.width = '40%';
            pText.innerText = "AI æ­£åœ¨é–±è®€æ‚¨çš„ç…§ç‰‡...";

            const { data: { text } } = await worker.recognize(compressedFile);
            
            pFill.style.width = '100%';
            status.innerHTML = "âœ… è¾¨è­˜å®Œæˆ";
            
            const results = parseData(text);
            renderTable(results);
            document.getElementById('resultArea').style.display = 'block';
            pWrapper.style.display = 'none';

        } catch (err) {
            alert("è¾¨è­˜éç¨‹å‡ºéŒ¯ï¼š" + err.message);
        }
        input.value = ''; // é‡ç½®
    }

    function parseData(text) {
        const lines = text.split('\n');
        const data = [];
        // å¸¸è¦‹å§“åæ’é™¤è©
        const noise = ['ç—…æ­·', 'å§“å', 'è¤‡è¨º', 'è³‡æ–™', 'æ”¶æ¡ˆ', 'é†«å¸«', 'ç¢ºèª', 'æ—¥æœŸ', 'ä¸Šåˆ', 'ä¸‹åˆ', 'å–®å…§', 'åˆä½µ', 'è¨»è¨˜'];

        lines.forEach(line => {
            const clean = line.replace(/\s+/g, '').trim(); 
            if (clean.length < 5) return;

            const mrnMatch = clean.match(/(\d{5,8})/); // æŠ“ç—…æ­·è™Ÿ
            // æŠ“ 2-4 å€‹ä¸­æ–‡å­—
            const nameMatch = clean.match(/[\u4e00-\u9fa5]{2,4}/);

            if (mrnMatch) {
                let name = '';
                if (nameMatch) {
                    const candidate = nameMatch[0];
                    if (!noise.some(bad => candidate.includes(bad))) {
                        name = candidate;
                    }
                }
                data.push({ mrn: mrnMatch[0], name: name });
            }
        });
        return data;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="color:red;text-align:center;">âš ï¸ æ²’æŠ“åˆ°è³‡æ–™ï¼Œè«‹ç›¡é‡æ‹æ­£ä¸€é»</td></tr>';
            return;
        }
        data.forEach(r => {
            tbody.innerHTML += `<tr>
                <td><input type="text" value="${r.mrn}"></td>
                <td><input type="text" value="${r.name}"></td>
                <td onclick="this.parentElement.remove()" style="text-align:center;font-size:1.2em;color:red;">Ã—</td>
            </tr>`;
        });
    }

    function copyResult() {
        const rows = document.querySelectorAll('#tableBody tr');
        let txt = "";
        rows.forEach(r => {
            const i = r.querySelectorAll('input');
            if(i.length) txt += `${i[0].value}\t${i[1].value}\n`;
        });
        if(txt) navigator.clipboard.writeText(txt).then(()=>alert("âœ… å·²è¤‡è£½")).catch(()=>alert("âŒ è¤‡è£½å¤±æ•—"));
        else alert("æ²’æœ‰å…§å®¹å¯è¤‡è£½");
    }
</script>

</body>
</html>
