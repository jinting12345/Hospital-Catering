<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…æ­·è¾¨è­˜ (æ¨™æº–ç‰ˆ+è‡ªå‹•é€£ç·š)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h2 { margin: 0 0 15px 0; color: #2c3e50; font-size: 1.3rem; text-align: center; font-weight: 800;}
        
        .status-box { background: #e3f2fd; color: #0d47a1; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; text-align: center; border: 1px solid #bbdefb; font-weight: bold;}
        .error-box { background: #fee2e2; color: #b91c1c; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; text-align: left; font-size: 14px; border: 1px solid #fecaca; }

        .action-group { display: flex; gap: 12px; margin-top: 20px; }
        .btn-action { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-camera { background: linear-gradient(135deg, #28a745, #218838); }
        .btn-gallery { background: linear-gradient(135deg, #f39c12, #d35400); }
        
        .btn-ocr { width: 100%; margin-top: 15px; background: linear-gradient(135deg, #2980b9, #2c3e50); padding: 15px; font-size: 18px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-ocr:disabled { background: #ccc; cursor: not-allowed; }

        .btn-back { display:inline-block; margin-bottom:15px; text-decoration:none; color:#666; font-size:14px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 20px; background: white;}

        /* å½±åƒç·¨è¼¯å€ */
        .editor-area { display: none; margin-top: 20px; background: #fafafa; padding: 15px; border-radius: 10px; border: 1px solid #eee; }
        canvas { max-width: 100%; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 15px; }
        
        .slider-group { margin-bottom: 15px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 14px; color: #555; font-weight: bold; margin-bottom: 5px; }
        input[type=range] { width: 100%; height: 6px; background: #ddd; border-radius: 5px; outline: none; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #1a73e8; border-radius: 50%; cursor: pointer; }

        /* çµæœè¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 16px; }
        th { background-color: #f8fafc; color: #64748b; font-size: 14px; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; color: #333; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-right:5px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>

<div class="card">
    <h2>ğŸ“· ç—…æ­·è¾¨è­˜ (æ¨™æº–ç‰ˆ)</h2>
    
    <div id="statusBox" class="status-box">
        æº–å‚™å°±ç·’ (å°‡è‡ªå‹•é€£æ¥é›²ç«¯å­—åº«)
    </div>
    <div id="errorBox" class="error-box"></div>

    <div class="action-group">
        <button class="btn-action btn-camera" onclick="document.getElementById('cameraInput').click()">
            ğŸ“¸ æ‹ç…§
        </button>
        <button class="btn-action btn-gallery" onclick="document.getElementById('galleryInput').click()">
            ğŸ–¼ï¸ é¸ç…§ç‰‡
        </button>
    </div>
    
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="loadFile(this)">
    <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="loadFile(this)">

    <div class="editor-area" id="editorArea">
        <canvas id="processCanvas"></canvas>
        
        <div class="slider-group">
            <div class="slider-label"><span>ğŸŒ‘ æ–‡å­—åŠ æ·± (é–¾å€¼)</span> <span id="threshVal">128</span></div>
            <input type="range" id="threshRange" min="0" max="255" value="128" oninput="applyFilter()">
            <div style="font-size:12px; color:#888; margin-top:5px;">ğŸ’¡ èª¿æ•´è‡³æ–‡å­—æ¸…æ™°ã€èƒŒæ™¯å…¨ç™½</div>
        </div>

        <button class="btn-ocr" onclick="runOCR()">ğŸš€ é–‹å§‹è¾¨è­˜</button>
    </div>

    <div id="resultArea" style="display:none; margin-top:20px;">
        <h3 style="margin:0 0 10px 0; color:#333; font-size:16px;">âœ… è¾¨è­˜çµæœ</h3>
        <table id="resultTable">
            <thead>
                <tr><th width="35%">ç—…æ­·è™Ÿ</th><th width="50%">å§“å</th><th width="15%"></th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="copyResult()" style="flex:1; padding:12px; background:#1a73e8; color:white; border:none; border-radius:8px; font-weight:bold;">ğŸ“‹ è¤‡è£½</button>
            <button onclick="location.reload()" style="flex:1; padding:12px; background:#6c757d; color:white; border:none; border-radius:8px; font-weight:bold;">ğŸ”„ é‡ä¾†</button>
        </div>
    </div>
</div>

<script>
    let originalImage = null;

    function loadFile(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                originalImage = img;
                document.getElementById('editorArea').style.display = 'block';
                document.getElementById('resultArea').style.display = 'none';
                document.getElementById('statusBox').innerText = "ğŸ’¡ ç³»çµ±å·²è‡ªå‹•å„ªåŒ–é‚Šç·£ï¼Œè«‹ç¢ºèªæ–‡å­—æ¸…æ™°åº¦";
                applyFilter(); // åˆæ¬¡æ¸²æŸ“
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
        input.value = '';
    }

    // å½±åƒè™•ç†ï¼šç¸®æ”¾ + è£œç™½é‚Š + äºŒå€¼åŒ–
    function applyFilter() {
        if (!originalImage) return;
        const canvas = document.getElementById('processCanvas');
        const ctx = canvas.getContext('2d');
        const threshVal = parseInt(document.getElementById('threshRange').value);
        document.getElementById('threshVal').innerText = threshVal;

        // 1. è¨­å®šå°ºå¯¸ (è§£æåº¦è¨­ç‚º 1000px ä»¥ä¿è­‰æ¨™æº–ç‰ˆè¾¨è­˜ç‡)
        const targetWidth = 1000;
        const scale = targetWidth / originalImage.width;
        const targetHeight = originalImage.height * scale;
        
        // 2. å¢åŠ ç™½é‚Š (Padding) - é—œéµï¼é˜²æ­¢é‚Šç·£æ–‡å­—è¢«åˆ‡æ‰
        const padding = 20; 
        canvas.width = targetWidth + (padding * 2);
        canvas.height = targetHeight + (padding * 2);

        // 3. å¡«æ»¿ç™½è‰²èƒŒæ™¯
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 4. ç¹ªè£½åœ–ç‰‡ (ç½®ä¸­)
        ctx.drawImage(originalImage, padding, padding, targetWidth, targetHeight);

        // 5. åƒç´ è™•ç† (äºŒå€¼åŒ–)
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
            // è½‰ç°éš
            const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
            // äºŒå€¼åŒ–
            const val = gray < threshVal ? 0 : 255;
            data[i] = data[i+1] = data[i+2] = val;
        }
        ctx.putImageData(imageData, 0, 0);
    }

    async function runOCR() {
        const status = document.getElementById('statusBox');
        const canvas = document.getElementById('processCanvas');
        const btn = document.querySelector('.btn-ocr');
        
        btn.disabled = true;
        // ç¬¬ä¸€æ¬¡éœ€è¦ä¸‹è¼‰ 25MBï¼Œè«‹è€å¿ƒç­‰å¾…
        status.innerHTML = '<div class="loader"></div> æ­£åœ¨é€£ç·šä¸‹è¼‰æ¨™æº–ç‰ˆæ ¸å¿ƒ (25MB)...';

        try {
            const worker = Tesseract.createWorker({
                // ğŸ”¥ é—œéµï¼šæŒ‡å‘ jsDelivr é«˜é€Ÿ CDN çš„æ¨™æº–ç‰ˆè·¯å¾‘
                langPath: 'https://cdn.jsdelivr.net/gh/naptha/tessdata@gh-pages/4.0.0/', 
                logger: m => {
                    if (m.status === 'recognizing text') {
                        status.innerHTML = `<div class="loader"></div> è¾¨è­˜ä¸­... ${Math.floor(m.progress * 100)}%`;
                    } else if (m.status.includes('loading')) {
                        // é¡¯ç¤ºä¸‹è¼‰é€²åº¦æç¤º
                        status.innerHTML = `<div class="loader"></div> é¦–æ¬¡éœ€ä¸‹è¼‰å¤§è…¦ (è«‹ä¿æŒç¶²è·¯æš¢é€š)...`;
                    }
                }
            });

            await worker.load();
            await worker.loadLanguage('chi_tra');
            await worker.initialize('chi_tra');
            
            // è¨­å®šåƒæ•¸ (æ¨™æº–ç‰ˆæ¨¡å‹ + å¯¬é¬†ç™½åå–®)
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789æ—é™³æé»ƒå¼µç‹å³åŠ‰è”¡æ¥Šè¨±é„­è¬éƒ­æ´ªæ›¾é‚±å»–è³´å‘¨å¾è˜‡è‘‰èŠå‘‚æ±Ÿä½•è•­ç¾…é«˜æ½˜ç°¡æœ±é¾å½­æ¸¸è©¹èƒ¡æ–½æ²ˆä½™ç›§æ¢è¶™é¡æŸ¯å­«é­ç¿æˆ´èŒƒå®‹é„§æœä¾¯æ›¹è–›å‚…ä¸æ¸©ç´€è”£æ­è—é€£é¦¬è‘£å¤æ¹¯é–»ç°¡ä¸çŸ¥å±±æ°´æœ¨åœŸé‡‘ç«æ—¥æœˆé½Šå…¨è³‡æ–™æ–°æ”¶æ¡ˆå¯è¤‡è¨º',
                tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT, 
            });

            const { data: { text } } = await worker.recognize(canvas);
            await worker.terminate();

            status.innerText = "âœ… å®Œæˆï¼";
            const data = parseData(text);
            renderTable(data);
            document.getElementById('resultArea').style.display = 'block';

        } catch (err) {
            console.error(err);
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorBox').innerHTML = `<strong>é€£ç·šéŒ¯èª¤ï¼š</strong>${err.message}<br>è«‹ç¢ºèªæ‰‹æ©Ÿç¶²è·¯æ˜¯å¦é€šæš¢ (éœ€ä¸‹è¼‰ 25MB)`;
            status.innerText = "âŒ å¤±æ•—";
        } finally {
            btn.disabled = false;
        }
    }

    function parseData(text) {
        const lines = text.split(/\r?\n/);
        const data = [];
        const noise = ['ç—…æ­·', 'å§“å', 'è¤‡è¨º', 'æ”¶æ¡ˆ', 'é†«å¸«', 'ç¢ºèª', 'æ—¥æœŸ', 'ä¸Šåˆ', 'ä¸‹åˆ', 'å–®å…§', 'åˆä½µ', 'è¨»è¨˜', '11412'];

        lines.forEach(line => {
            const clean = line.replace(/\s+/g, '').trim(); 
            if (clean.length < 5) return;
            const mrnMatch = clean.match(/(\d{5,8})/);
            const nameMatch = clean.match(/[\u4e00-\u9fa5]{2,4}/);

            if (mrnMatch) {
                let name = '';
                if (nameMatch) {
                    const candidate = nameMatch[0];
                    if (!noise.some(bad => candidate.includes(bad))) { name = candidate; }
                }
                data.push({ mrn: mrnMatch[0], name: name });
            }
        });
        return data;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="3" style="color:red;text-align:center;">âš ï¸ æœªåµæ¸¬åˆ°è³‡æ–™</td></tr>'; return; }
        data.forEach(r => {
            tbody.innerHTML += `<tr>
                <td><input type="text" value="${r.mrn}"></td>
                <td><input type="text" value="${r.name}"></td>
                <td onclick="this.parentElement.remove()" style="text-align:center;font-size:1.2em;color:red;">Ã—</td>
            </tr>`;
        });
    }

    function copyResult() {
        const rows = document.querySelectorAll('#tableBody tr');
        let txt = "";
        rows.forEach(r => {
            const i = r.querySelectorAll('input');
            if(i.length) txt += `${i[0].value}\t${i[1].value}\n`;
        });
        if(txt) navigator.clipboard.writeText(txt).then(()=>alert("âœ… å·²è¤‡è£½")).catch(()=>alert("âŒ è¤‡è£½å¤±æ•—"));
    }
</script>

</body>
</html>
