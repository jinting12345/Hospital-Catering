<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…æ­·å–®è¾¨è­˜ (åˆ†æ®µå•Ÿå‹•ç‰ˆ)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
        h2 { margin: 0 0 15px 0; color: #1a73e8; font-size: 1.3rem; }
        
        /* ç‹€æ…‹é¡¯ç¤ºå€ */
        .status-box { background: #e8f0fe; color: #1557b0; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; font-size: 14px; border: 1px solid #d2e3fc; }
        .error-box { background: #fee2e2; color: #b91c1c; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; text-align: left; font-size: 14px; border: 1px solid #fecaca; }

        /* é€²åº¦æ¢ */
        .progress-container { margin: 15px 0; display: none; }
        .progress-bar { width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #1a73e8; transition: width 0.3s; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-init { width: 100%; padding: 15px; background: #1a73e8; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(26,115,232,0.3); }
        .btn-init:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
        
        /* é›™æŒ‰éˆ•å€åŸŸ (é è¨­éš±è—ï¼Œç­‰åˆå§‹åŒ–å®Œæ‰é¡¯ç¤º) */
        .camera-section { display: none; margin-top: 20px; animation: fadeIn 0.5s; }
        .action-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-action { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-camera { background-color: #28a745; }
        .btn-gallery { background-color: #ff9800; }

        .btn-back { display:inline-block; margin-bottom:15px; text-decoration:none; color:#666; font-size:14px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; background: white;}

        #preview-img { max-width: 100%; border-radius: 8px; margin-top: 10px; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* çµæœè¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
        th, td { padding: 10px 5px; text-align: left; border-bottom: 1px solid #eee; font-size: 15px; }
        th { background-color: #f8fafc; color: #64748b; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>

<div class="card">
    <h2>ğŸ“· ç—…æ­·å–®è¾¨è­˜ç³»çµ±</h2>
    
    <div id="statusBox" class="status-box">âš ï¸ è«‹å…ˆé»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•ç³»çµ±</div>
    <div id="errorBox" class="error-box"></div>

    <div class="progress-container" id="pContainer">
        <div class="progress-bar"><div class="progress-fill" id="pFill"></div></div>
        <div style="font-size:12px; color:#666; margin-top:5px;" id="pText">0%</div>
    </div>

    <button id="initBtn" class="btn-init" onclick="initEngine()">ğŸš€ å•Ÿå‹•è¾¨è­˜ç³»çµ± (éœ€ä¸‹è¼‰ 20MB)</button>

    <div id="cameraSection" class="camera-section">
        <div class="action-buttons">
            <button class="btn-action btn-camera" onclick="document.getElementById('cameraInput').click()">ğŸ“¸ æ‹ç…§</button>
            <button class="btn-action btn-gallery" onclick="document.getElementById('galleryInput').click()">ğŸ–¼ï¸ é¸ç…§ç‰‡</button>
        </div>
        <p style="font-size:12px; color:#888;">ç³»çµ±å·²å°±ç·’ï¼Œè«‹é¸æ“‡æ¸…æ™°çš„ç…§ç‰‡</p>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleFile(this)">
    <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="handleFile(this)">

    <img id="preview-img">

    <div id="resultArea" style="display:none;">
        <h3 style="margin:20px 0 10px 0; color:#333;">âœ… è¾¨è­˜çµæœ</h3>
        <table id="resultTable">
            <thead>
                <tr><th width="35%">ç—…æ­·è™Ÿ</th><th width="50%">å§“å</th><th width="15%"></th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="copyResult()" style="flex:1; padding:10px; background:#1a73e8; color:white; border:none; border-radius:6px;">ğŸ“‹ è¤‡è£½</button>
            <button onclick="location.reload()" style="flex:1; padding:10px; background:#666; color:white; border:none; border-radius:6px;">ğŸ”„ é‡æ•´</button>
        </div>
    </div>
</div>

<script>
    let worker = null;
    let isEngineReady = false;

    // 1. åˆå§‹åŒ–å¼•æ“ (åˆ†é–‹åŸ·è¡Œï¼Œé¿å…å¡æ­»)
    async function initEngine() {
        const btn = document.getElementById('initBtn');
        const status = document.getElementById('statusBox');
        const pContainer = document.getElementById('pContainer');
        const pFill = document.getElementById('pFill');
        const pText = document.getElementById('pText');
        const errorBox = document.getElementById('errorBox');

        btn.disabled = true;
        btn.innerText = "â³ ç³»çµ±å•Ÿå‹•ä¸­...";
        pContainer.style.display = 'block';
        errorBox.style.display = 'none';

        try {
            status.innerText = "âš™ï¸ æ­£åœ¨å»ºç«‹æ ¸å¿ƒ (WebAssembly)...";
            
            // å»ºç«‹ Worker
            worker = await Tesseract.createWorker({
                logger: m => {
                    if (m.status.includes('loading')) {
                        status.innerText = "ğŸ“¥ æ­£åœ¨ä¸‹è¼‰ä¸­æ–‡å­—åº« (é¦–æ¬¡éœ€è¼ƒä¹…)...";
                        pText.innerText = "ä¸‹è¼‰é€²åº¦ (è‹¥å¡ä½è«‹æª¢æŸ¥ç¶²è·¯)";
                    } else if (m.status.includes('initializing')) {
                        status.innerText = "ğŸš€ æ­£åœ¨åˆå§‹åŒ–å¼•æ“...";
                        pFill.style.width = '80%';
                    }
                }
            });

            // è¼‰å…¥èªè¨€åŒ…
            status.innerText = "ğŸ“¥ ä¸‹è¼‰ç¹é«”ä¸­æ–‡åŒ… (chi_tra)...";
            await worker.loadLanguage('chi_tra+eng');
            
            status.innerText = "ğŸ”§ åˆå§‹åŒ–åƒæ•¸...";
            await worker.initialize('chi_tra+eng');
            
            // å®Œæˆ
            pFill.style.width = '100%';
            status.innerText = "âœ… ç³»çµ±å°±ç·’ï¼è«‹é¸æ“‡ç…§ç‰‡";
            status.style.background = "#d1e7dd";
            status.style.color = "#0f5132";
            status.style.borderColor = "#badbcc";
            
            btn.style.display = 'none'; // éš±è—å•Ÿå‹•æŒ‰éˆ•
            document.getElementById('cameraSection').style.display = 'block'; // é¡¯ç¤ºæ‹ç…§æŒ‰éˆ•
            isEngineReady = true;

        } catch (err) {
            console.error(err);
            btn.disabled = false;
            btn.innerText = "âŒ å¤±æ•—ï¼Œé»æ­¤é‡è©¦";
            status.innerText = "âŒ å•Ÿå‹•å¤±æ•—";
            errorBox.style.display = 'block';
            errorBox.innerHTML = `<strong>éŒ¯èª¤è©³æƒ…ï¼š</strong><br>${err.message}<br><br>ğŸ‘‰ <strong>è§£æ±ºæ–¹æ³•ï¼š</strong><br>1. è«‹ä½¿ç”¨ Chrome æˆ– Safari é–‹å•Ÿ (ä¸è¦ç”¨ LINE/FB)<br>2. è«‹ç¢ºèªå·²é€£ä¸Š Wi-Fi (æª”æ¡ˆç´„ 20MB)`;
        }
    }

    // 2. è™•ç†ç…§ç‰‡
    async function handleFile(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        
        if (!isEngineReady) { alert("è«‹å…ˆé»æ“Šä¸Šæ–¹æŒ‰éˆ•å•Ÿå‹•ç³»çµ±ï¼"); return; }

        const status = document.getElementById('statusBox');
        const img = document.getElementById('preview-img');
        const pFill = document.getElementById('pFill');
        
        // é¡¯ç¤ºé è¦½
        img.src = URL.createObjectURL(file);
        img.style.display = 'block';
        document.getElementById('resultArea').style.display = 'none';
        status.innerText = "ğŸ“¸ æ­£åœ¨å£“ç¸®åœ–ç‰‡...";
        
        try {
            // å£“ç¸®
            const options = { maxSizeMB: 0.6, maxWidthOrHeight: 800, useWebWorker: true };
            const compressedFile = await imageCompression(file, options);
            img.src = URL.createObjectURL(compressedFile); // æ›´æ–°ç‚ºå£“ç¸®åœ–é è¦½

            status.innerText = "ğŸ” æ­£åœ¨è®€å–æ–‡å­—...";
            pFill.style.width = "20%";

            // è¾¨è­˜
            const { data: { text } } = await worker.recognize(compressedFile);
            pFill.style.width = "100%";
            status.innerText = "âœ… è¾¨è­˜å®Œæˆ";

            // è§£æèˆ‡é¡¯ç¤º
            const results = parseData(text);
            renderTable(results);
            document.getElementById('resultArea').style.display = 'block';

        } catch (err) {
            alert("è¾¨è­˜éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
            status.innerText = "âŒ è¾¨è­˜å¤±æ•—";
        }
        
        input.value = ''; // é‡ç½® input
    }

    // 3. è§£æé‚è¼¯
    function parseData(text) {
        const lines = text.split('\n');
        const data = [];
        lines.forEach(line => {
            const clean = line.replace(/\s+/g, '').trim(); // å»é™¤æ‰€æœ‰ç©ºç™½
            if (clean.length < 5) return;

            // æŠ“å– 5-8 ä½æ•¸å­—
            const mrnMatch = clean.match(/(\d{5,8})/);
            // æŠ“å–ä¸­æ–‡å§“å (æ’é™¤å¸¸è¦‹æ¨™é¡Œå­—)
            const nameMatch = clean.match(/[\u4e00-\u9fa5]{2,4}/);

            if (mrnMatch) {
                let name = '';
                if (nameMatch) {
                    const badWords = ['ç—…æ­·', 'å§“å', 'è¤‡è¨º', 'è³‡æ–™', 'æ”¶æ¡ˆ', 'é†«å¸«', 'ç¢ºèª', 'æ—¥æœŸ'];
                    if (!badWords.some(w => nameMatch[0].includes(w))) {
                        name = nameMatch[0];
                    }
                }
                data.push({ mrn: mrnMatch[0], name: name });
            }
        });
        return data;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="color:red;text-align:center;">âš ï¸ ç„¡æ³•è­˜åˆ¥ï¼Œè«‹é‡æ‹</td></tr>';
            return;
        }
        data.forEach(r => {
            const row = `<tr>
                <td><input type="text" value="${r.mrn}"></td>
                <td><input type="text" value="${r.name}"></td>
                <td onclick="this.parentElement.remove()" style="text-align:center;font-size:1.2em;color:red;">Ã—</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function copyResult() {
        const rows = document.querySelectorAll('#tableBody tr');
        let txt = "";
        rows.forEach(r => {
            const i = r.querySelectorAll('input');
            if(i.length) txt += `${i[0].value}\t${i[1].value}\n`;
        });
        if(txt) navigator.clipboard.writeText(txt).then(()=>alert("å·²è¤‡è£½")).catch(()=>alert("è¤‡è£½å¤±æ•—"));
        else alert("ç„¡è³‡æ–™");
    }
</script>

</body>
</html>
