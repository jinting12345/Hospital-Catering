<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…æ­·å–®è¾¨è­˜ (é›™æŒ‰éˆ•ç‰ˆ)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #1a73e8; font-size: 1.3rem; text-align: center;}
        
        /* é›™æŒ‰éˆ•å€åŸŸ */
        .action-buttons { display: flex; gap: 15px; margin: 25px 0 10px 0; }
        .btn-action { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-camera { background-color: #28a745; box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2); }
        .btn-camera:active { background-color: #1e7e34; transform: translateY(2px); }
        .btn-gallery { background-color: #ffc107; color: #333; box-shadow: 0 4px 6px rgba(255, 193, 7, 0.2); }
        .btn-gallery:active { background-color: #d39e00; transform: translateY(2px); }

        #preview-container { display: none; margin-top: 15px; text-align: center; }
        #preview-img { max-width: 100%; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* é€²åº¦æ¢ */
        .progress-container { margin-top: 25px; display: none; }
        .progress-bar { width: 100%; height: 14px; background-color: #e2e8f0; border-radius: 7px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background-color: #1a73e8; transition: width 0.3s ease; }
        .status-text { margin-top: 8px; font-size: 15px; color: #1a73e8; text-align: center; font-weight: bold;}

        /* çµæœè¡¨æ ¼ */
        .result-section { display: none; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; table-layout: fixed; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; word-break: break-all; }
        th { background-color: #f8fafc; color: #64748b; font-size: 14px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 18px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; }
        .btn-primary { background-color: #1a73e8; }
        .btn-success { background-color: #10b981; }
        .btn-back { display:inline-block; margin-bottom:15px; text-decoration:none; color:#666; font-size:14px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px;}
        
        .tip { text-align: center; color: #888; font-size: 13px; margin-bottom: 20px; }
        .error-box { background: #fee2e2; color: #b91c1c; padding: 15px; border-radius: 8px; margin-top: 20px; display: none; word-break: break-all;}
    </style>
</head>
<body>

<a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>

<div class="card">
    <h2>ç—…æ­·å–®è¾¨è­˜ç³»çµ± (OCR)</h2>
    
    <div class="action-buttons">
        <button class="btn-action btn-camera" onclick="document.getElementById('cameraInput').click()">ğŸ“¸ æ‹ç…§</button>
        <button class="btn-action btn-gallery" onclick="document.getElementById('galleryInput').click()">ğŸ–¼ï¸ é¸ç…§ç‰‡</button>
    </div>
    <p class="tip">ğŸ’¡ é¦–æ¬¡ä½¿ç”¨éœ€ä¸‹è¼‰å­—åº«ï¼Œè«‹ä¿æŒç¶²è·¯é †æš¢ã€‚</p>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect(this)">
    <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="handleFileSelect(this)">

    <div id="preview-container">
        <img id="preview-img">
    </div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="status-text" id="statusText">æº–å‚™ä¸­...</div>
    </div>

    <div class="error-box" id="errorBox"></div>
    
    <div class="result-section" id="resultSection">
        <h3>âœ… è¾¨è­˜çµæœ</h3>
        <table id="resultTable">
            <thead>
                <tr><th width="40%">ç—…æ­·è™Ÿ</th><th width="45%">å§“å</th><th width="15%"></th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="btn-group">
            <button class="btn btn-primary" onclick="copyToClipboard()">ğŸ“‹ è¤‡è£½çµæœ</button>
            <button class="btn btn-success" onclick="location.reload()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
    </div>
</div>

<script>
    let worker = null;

    async function handleFileSelect(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        
        // é‡ç½®ä»‹é¢
        document.getElementById('errorBox').style.display = 'none';
        document.getElementById('resultSection').style.display = 'none';
        const img = document.getElementById('preview-img');
        img.src = URL.createObjectURL(file);
        document.getElementById('preview-container').style.display = 'block';
        
        // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
        document.querySelectorAll('.btn-action').forEach(btn => btn.disabled = true);

        await runOCR(file);
        
        // æ¢å¾©æŒ‰éˆ•
        document.querySelectorAll('.btn-action').forEach(btn => btn.disabled = false);
        input.value = ''; // æ¸…ç©º input ä»¥ä¾¿ä¸‹æ¬¡èƒ½é¸åŒä¸€å¼µåœ–
    }

    async function runOCR(originalFile) {
        const pContainer = document.getElementById('progressContainer');
        const pFill = document.getElementById('progressFill');
        const status = document.getElementById('statusText');
        const errorBox = document.getElementById('errorBox');
        
        pContainer.style.display = 'block';
        status.innerText = "ğŸš€ æ­£åœ¨å£“ç¸®åœ–ç‰‡ (åŠ é€Ÿè™•ç†)...";
        pFill.style.width = "5%";

        try {
            // 1. åœ–ç‰‡å£“ç¸® (åŠ å¼·ç‰ˆ)
            const options = {
                maxSizeMB: 0.8,          // é™åˆ¶æ›´å°
                maxWidthOrHeight: 800,   // é™åˆ¶æ›´å°ï¼Œæ‰‹æ©Ÿè·‘èµ·ä¾†æ›´é †
                useWebWorker: true
            };
            const compressedFile = await imageCompression(originalFile, options);
            document.getElementById('preview-img').src = URL.createObjectURL(compressedFile);
            
            status.innerText = "â˜ï¸ åˆå§‹åŒ–å¼•æ“ (è«‹ç¨å€™)...";
            pFill.style.width = "15%";

            // 2. å»ºç«‹ Worker
            worker = await Tesseract.createWorker({
                logger: m => {
                    // è©³ç´°ç‹€æ…‹å›å ±
                    if (m.status === 'recognizing text') {
                        const pct = 40 + Math.round(m.progress * 60);
                        pFill.style.width = pct + '%';
                        status.innerText = `ğŸ” æ­£åœ¨è¾¨è­˜æ–‡å­—... ${Math.round(m.progress * 100)}%`;
                    } else if (m.status.includes('loading tesseract core')) {
                         status.innerText = "âš™ï¸ è¼‰å…¥æ ¸å¿ƒç¨‹å¼...";
                         pFill.style.width = "20%";
                    } else if (m.status.includes('loading language')) {
                         status.innerText = "ğŸ“¥ æ­£åœ¨ä¸‹è¼‰ä¸­æ–‡å­—åº« (ç´„20MBï¼Œè«‹ä¿æŒç¶²è·¯æš¢é€š)...";
                         pFill.style.width = "30%";
                    } else if (m.status.includes('initializing')) {
                         status.innerText = "ğŸš€ å¼•æ“å•Ÿå‹•ä¸­...";
                         pFill.style.width = "40%";
                    }
                },
                errorHandler: err => {
                    throw new Error("å¼•æ“éŒ¯èª¤: " + err);
                }
            });

            // 3. è¼‰å…¥èªè¨€ä¸¦è¾¨è­˜
            await worker.loadLanguage('chi_tra+eng');
            await worker.initialize('chi_tra+eng');
            
            status.innerText = "âœ… è¾¨è­˜å®Œæˆï¼Œæ•´ç†è³‡æ–™ä¸­...";
            const { data: { text } } = await worker.recognize(compressedFile);
            
            pFill.style.width = "100%";

            const parsedData = parseTextToData(text);
            renderTable(parsedData);
            
            await worker.terminate();
            pContainer.style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';

        } catch (err) {
            console.error(err);
            pContainer.style.display = 'none';
            errorBox.style.display = 'block';
            errorBox.innerHTML = `âŒ <strong>ç™¼ç”ŸéŒ¯èª¤</strong><br>${err.message}<br><br>ğŸ‘‰ <strong>å¯èƒ½åŸå› ï¼š</strong><br>1. ç¶²è·¯ä¸ç©©å°è‡´å­—åº«ä¸‹è¼‰å¤±æ•— (è«‹å˜—è©¦é€£æ¥ Wi-Fi)<br>2. æ‰‹æ©Ÿè¨˜æ†¶é«”ä¸è¶³ (è«‹é—œé–‰å…¶ä»– App é‡è©¦)`;
            if(worker) await worker.terminate();
        }
    }

    function parseTextToData(rawText) {
        const lines = rawText.split('\n');
        const results = [];
        lines.forEach(line => {
            const cleanLine = line.replace(/\s+/g, ' ').trim();
            if (cleanLine.includes('ç—…æ­·è™Ÿ') || cleanLine.length < 5) return;
            // èª¿æ•´æ­£è¦è¡¨é”å¼ä»¥é©æ‡‰å¯èƒ½çš„é›œè¨Š
            const mrnMatch = cleanLine.match(/(\d{5,8})/);
            const nameMatch = cleanLine.match(/[\u4e00-\u9fa5]{2,4}/g);
            
            if (mrnMatch) {
                const mrn = mrnMatch[0];
                let name = '';
                if (nameMatch) {
                    // é»‘åå–®éæ¿¾
                    const blacklist = ['è¤‡è¨º', 'è³‡æ–™', 'é½Šå…¨', 'æ”¶æ¡ˆ', 'é†«å¸«', 'ç¢ºèª', 'å–®å…§', 'åˆä½µ', 'è¨»è¨˜', 'ä¸Šåˆ', 'ä¸‹åˆ', 'æ—¥æœŸ'];
                    const potentialNames = nameMatch.filter(n => !blacklist.some(bad => n.includes(bad)));
                    if (potentialNames.length > 0) name = potentialNames[0];
                }
                // åªè¦æœ‰ç—…æ­·è™Ÿå°±åˆ—å‡ºï¼Œåå­—å¯èƒ½æ˜¯ç©ºçš„æ²’é—œä¿‚
                if (mrn) results.push({ mrn, name });
            }
        });
        return results;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#d9534f;padding:20px;font-weight:bold;">âš ï¸ æœªåµæ¸¬åˆ°æœ‰æ•ˆè³‡æ–™<br>è«‹ç¢ºä¿ç…§ç‰‡æ¸…æ™°ç„¡åå…‰</td></tr>'; return; }
        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" value="${row.mrn}" inputmode="numeric"></td>
                <td><input type="text" value="${row.name}" placeholder="æœªè¾¨è­˜"></td>
                <td onclick="this.parentElement.remove()" style="text-align:center;font-size:1.5em;color:#d9534f;cursor:pointer;">Ã—</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function copyToClipboard() {
        const rows = document.querySelectorAll('#tableBody tr');
        let text = ""; 
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            if (inputs.length > 0) text += `${inputs[0].value}\t${inputs[1].value}\n`;
        });
        if(!text) { alert("æ²’æœ‰è³‡æ–™å¯è¤‡è£½"); return; }
        navigator.clipboard.writeText(text).then(() => alert('âœ… å·²è¤‡è£½ï¼\nå¯ç›´æ¥è²¼ä¸Šè‡³ Excel')).catch(() => alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½'));
    }
</script>

</body>
</html>
