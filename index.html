<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±ç™»å…¥ (å¼·æ•ˆä¿®å¾©ç‰ˆ)</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 360px; text-align: center; }
        h2 { color: #1a73e8; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        button:hover { background: #1557b0; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .error { color: red; font-size: 14px; margin-top: 10px; min-height: 20px; word-wrap: break-word;}
        .status { font-size: 12px; color: #666; margin-bottom: 10px;}
    </style>
</head>
<body>
    <div class="login-box">
        <h2>ğŸ¥ ç‡Ÿé¤Šç§‘ç³»çµ±</h2>
        <div id="status" class="status">æ­£åœ¨è¼‰å…¥ç³»çµ±æ ¸å¿ƒ...</div>
        
        <input type="email" id="email" placeholder="å¸³è™Ÿ">
        <input type="password" id="password" placeholder="å¯†ç¢¼">
        
        <button id="loginBtn" disabled>è¼‰å…¥ä¸­...</button>
        <div id="msg" class="error"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        // è¨­å®šåƒæ•¸
        const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
        const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
        
        let supabase = null;
        const statusEl = document.getElementById('status');
        const btn = document.getElementById('loginBtn');
        const msg = document.getElementById('msg');

        // 1. åˆå§‹åŒ–
        try {
            supabase = createClient(RAW_URL, RAW_KEY);
            console.log("Supabase (ESM) è¼‰å…¥æˆåŠŸ");
            
            // å•Ÿç”¨æŒ‰éˆ•
            statusEl.innerText = "âœ… ç³»çµ±å°±ç·’ (ESM)";
            statusEl.style.color = "green";
            btn.disabled = false;
            btn.innerText = "ç™»å…¥ç³»çµ±";
            
            // è‡ªå‹•ç™»å‡ºæª¢æŸ¥
            (async () => {
                const { data } = await supabase.auth.getSession();
                if(data.session) await supabase.auth.signOut();
            })();

        } catch (e) {
            statusEl.innerText = "âŒ è¼‰å…¥å¤±æ•—";
            msg.innerText = "ç³»çµ±è¢«ç€è¦½å™¨é˜»æ“‹: " + e.message;
            alert("åš´é‡éŒ¯èª¤ï¼šç€è¦½å™¨å®Œå…¨é˜»æ“‹äº†ç¨‹å¼åŸ·è¡Œã€‚\nè«‹å˜—è©¦é—œé–‰ Kiwi çš„å»£å‘Šé˜»æ“‹åŠŸèƒ½ã€‚");
        }

        // 2. ç¶å®šç™»å…¥äº‹ä»¶
        btn.addEventListener('click', async () => {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!email || !password) {
                msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼";
                return;
            }

            btn.disabled = true;
            btn.innerText = "é©—è­‰ä¸­...";
            msg.innerText = "";

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    throw error;
                }

                // ç™»å…¥æˆåŠŸ
                msg.style.color = "green";
                msg.innerText = "âœ… æˆåŠŸï¼é€²å…¥ä¸­...";
                setTimeout(() => { window.location.href = 'menu.html'; }, 300);

            } catch (err) {
                console.error(err);
                let text = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
                if(err.message.includes("fetch")) text = "âŒ ç¶²è·¯é€£ç·šå¤±æ•—";
                
                msg.innerText = text;
                msg.style.color = "red";
                btn.disabled = false;
                btn.innerText = "ç™»å…¥ç³»çµ±";
                alert("ç™»å…¥å¤±æ•—ï¼š" + text);
            }
        });
    </script>
</body>
</html>
