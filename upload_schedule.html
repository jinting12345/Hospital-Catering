<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­è¡¨ä¸Šå‚³</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f8f9fa; max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #666; display: flex; align-items: center; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h3 { margin-top: 0; color: #333; }
        .instruction { background: #e8f0fe; padding: 15px; border-radius: 4px; font-size: 14px; color: #1967d2; margin-bottom: 20px; line-height: 1.6; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="file"], input[type="month"] { display: block; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        button { padding: 12px 24px; background: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.2s; width: 100%; margin-top: 10px; }
        button:hover { background: #0b5ed7; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        #status { margin-top: 15px; font-weight: bold; white-space: pre-wrap; line-height: 1.5; }
        .log-box { margin-top: 15px; padding: 12px; background: #212529; color: #0f0; border-radius: 6px; max-height: 250px; overflow-y: auto; font-size: 12px; font-family: Consolas, monospace; display: none; }
    </style>
</head>
<body>
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
    </div>

    <div class="card">
        <h3>ğŸ“… ä¸Šå‚³ Excel ç­è¡¨ (æŒ‡å®šæœˆä»½ç‰ˆ)</h3>
        
        <div class="instruction">
            <strong>ğŸ’¡ åŠŸèƒ½æ›´æ–°ï¼š</strong><br>
            1. é è¨­è‡ªå‹•æŠ“å– Excel ä¸­ <strong>æœ€æ–°çš„ä¸€å€‹æœˆä»½</strong>ã€‚<br>
            2. è‹¥è¦ä¸Šå‚³ç‰¹å®šæœˆä»½ï¼ˆå¦‚ä¿®æ­£èˆŠè³‡æ–™ï¼‰ï¼Œè«‹åœ¨ä¸‹æ–¹æ‰‹å‹•é¸æ“‡ã€‚<br>
            3. è‡ªå‹•ä¿®æ­£å› å¤šå€‹å·¥ä½œè¡¨å°è‡´çš„è³‡æ–™è·‘ç‰ˆå•é¡Œã€‚
        </div>

        <div class="form-group">
            <label for="targetMonth">æŒ‡å®šä¸Šå‚³æœˆä»½ (é¸å¡«ï¼Œä¸é¸å‰‡è‡ªå‹•æŠ“æœ€æ–°)</label>
            <input type="month" id="targetMonth">
        </div>

        <div class="form-group">
            <label for="fileInput">é¸æ“‡ Excel æª”æ¡ˆ (.xlsx)</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
        </div>

        <button id="uploadBtn" onclick="processExcel()">ğŸš€ é–‹å§‹åˆ†æä¸¦ä¸Šå‚³</button>
        <div id="status"></div>
        <div id="log" class="log-box"></div>
    </div>

    <script>
        // ç°¡å–®çš„å­—ä¸²æ¸…ç†å‡½æ•¸
        function cleanString(str) { return str ? str.replace(/[^\x20-\x7E]/g, '').trim() : ''; }
        
        // Supabase è¨­å®š
        const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
        const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
        const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

        function log(message) {
            const logBox = document.getElementById('log');
            logBox.style.display = 'block';
            logBox.innerHTML += `<div>${message}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function processExcel() {
            const fileInput = document.getElementById('fileInput');
            const targetMonthInput = document.getElementById('targetMonth'); // å–å¾—æœˆä»½é¸æ“‡å™¨
            const status = document.getElementById('status');
            const btn = document.getElementById('uploadBtn');
            const logBox = document.getElementById('log');
            
            if(!fileInput.files.length) { status.innerText = 'âŒ è«‹å…ˆé¸æ“‡ Excel æª”æ¡ˆ (.xlsx)'; return; }
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            status.innerText = 'â³ æ­£åœ¨è®€å–ä¸¦åˆ†ææª”æ¡ˆ...';
            logBox.innerHTML = ''; 
            btn.disabled = true;

            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    let validSheets = []; // å„²å­˜æ‰€æœ‰åˆ†æå‡ºçš„æœ‰æ•ˆæœˆä»½ Sheet

                    // 1. å…ˆæƒææ‰€æœ‰ Sheetï¼Œæœé›†è³‡è¨Š
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
                        if (rows.length < 5) return;

                        // è®€å– A1 æ¨™é¡Œ
                        const titleCell = rows[0][0];
                        if (!titleCell || typeof titleCell !== 'string') return;

                        const dateMatch = titleCell.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
                        if (dateMatch) {
                            const year = dateMatch[1];
                            const month = dateMatch[2].padStart(2, '0');
                            validSheets.push({
                                sheetName: sheetName,
                                year: year,
                                month: month,
                                sortKey: parseInt(year + month), // ç”¨æ–¼æ’åº (e.g. 202512)
                                rows: rows
                            });
                        }
                    });

                    if (validSheets.length === 0) {
                        throw new Error("ç„¡æ³•åœ¨æª”æ¡ˆä¸­è­˜åˆ¥å‡ºä»»ä½•æœ‰æ•ˆçš„æœˆä»½æ¨™é¡Œ (éœ€åŒ…å« YYYYå¹´MMæœˆ)ã€‚");
                    }

                    // 2. æ±ºå®šè¦è™•ç†å“ªä¸€å€‹ Sheet
                    let targetSheet = null;
                    const userSelectedMonth = targetMonthInput.value; // æ ¼å¼: "2025-12"

                    if (userSelectedMonth) {
                        // æƒ…æ³ A: ä½¿ç”¨è€…æœ‰æŒ‡å®šæœˆä»½
                        const [uYear, uMonth] = userSelectedMonth.split('-');
                        targetSheet = validSheets.find(s => s.year === uYear && s.month === uMonth);
                        
                        if (!targetSheet) {
                            throw new Error(`æª”æ¡ˆä¸­æ‰¾ä¸åˆ°å°æ‡‰ ${uYear}å¹´${uMonth}æœˆ çš„å·¥ä½œè¡¨ã€‚æ‰¾åˆ°çš„æœˆä»½æœ‰ï¼š${validSheets.map(s => `${s.year}-${s.month}`).join(', ')}`);
                        }
                        log(`ğŸ¯ ä½¿ç”¨è€…æŒ‡å®šè™•ç†ï¼š${targetSheet.year}å¹´${targetSheet.month}æœˆ (Sheet: ${targetSheet.sheetName})`);
                    } else {
                        // æƒ…æ³ B: è‡ªå‹•æŠ“æœ€æ–°çš„ (SortKey æœ€å¤§)
                        validSheets.sort((a, b) => b.sortKey - a.sortKey);
                        targetSheet = validSheets[0];
                        log(`ğŸ¤– è‡ªå‹•é¸æ“‡æœ€æ–°æœˆä»½ï¼š${targetSheet.year}å¹´${targetSheet.month}æœˆ (Sheet: ${targetSheet.sheetName})`);
                    }

                    // 3. é–‹å§‹è§£æé¸å®šçš„ Sheet
                    let allInsertData = [];
                    const rows = targetSheet.rows;
                    const year = targetSheet.year;
                    const month = targetSheet.month;

                    // å®šä½æ—¥æœŸåˆ— (Row Index 2 => Excel ç¬¬3åˆ—)
                    const dayRowIndex = 2;
                    const dayRow = rows[dayRowIndex];
                    if (!dayRow) throw new Error("æ‰¾ä¸åˆ°æ—¥æœŸåˆ— (Excel ç¬¬3åˆ—)");

                    // å»ºç«‹ Column Index -> æ—¥æœŸå­—ä¸² çš„å°ç…§è¡¨
                    let colToDateMap = {}; 
                    for (let c = 1; c < dayRow.length; c++) {
                        const dayVal = dayRow[c];
                        if (dayVal && !isNaN(dayVal) && dayVal >= 1 && dayVal <= 31) {
                            const dayStr = String(dayVal).padStart(2, '0');
                            colToDateMap[c] = `${year}-${month}-${dayStr}`;
                        }
                    }

                    // éæ­·äººå“¡åˆ— (å¾ Row Index 4 => Excel ç¬¬5åˆ— é–‹å§‹)
                    for (let r = 4; r < rows.length; r++) {
                        const row = rows[r];
                        const staffName = row[0]; // Aæ¬„å§“å

                        // éæ¿¾ç„¡æ•ˆåˆ—
                        if (!staffName || typeof staffName !== 'string') continue;
                        if (staffName.trim().startsWith('*') || staffName.includes('ä¸»ç®¡') || staffName.length > 8) continue;

                        // æª¢æŸ¥æ¯ä¸€å¤©çš„æ’ç­
                        for (let c in colToDateMap) {
                            const cellValue = row[c];
                            const dateStr = colToDateMap[c];

                            if (cellValue && typeof cellValue === 'string') {
                                if (cellValue.toUpperCase().includes('BN')) {
                                    allInsertData.push({
                                        date: dateStr,
                                        shift: cellValue.trim(), 
                                        staff_name: staffName.trim(),
                                        staff_email: '' 
                                    });
                                }
                            }
                        }
                    }

                    if (allInsertData.length === 0) {
                        status.innerText = `âš ï¸ åœ¨ ${year}å¹´${month}æœˆ ä¸­æ²’æœ‰ç™¼ç¾ä»»ä½•å«æœ‰ "BN" çš„æ’ç­ã€‚`;
                        btn.disabled = false;
                        return;
                    }

                    status.innerText = `ğŸ“Š åˆ†æå®Œæˆï¼\nğŸ“… æœˆä»½ï¼š${year}-${month}\nğŸ“ ç­†æ•¸ï¼š${allInsertData.length} ç­†\nğŸš€ æ­£åœ¨å¯«å…¥è³‡æ–™åº«...`;
                    
                    // æ‰¹æ¬¡å¯«å…¥ Supabase
                    const { error } = await supabase.from('duty_roster').insert(allInsertData);
                    
                    if(error) throw error;
                    
                    status.innerHTML = `<span style="color:#198754; font-size:1.1em;">âœ… ä¸Šå‚³æˆåŠŸï¼å·²åŒ¯å…¥ ${year}å¹´${month}æœˆ å…± ${allInsertData.length} ç­†è³‡æ–™ã€‚</span>`;
                    log('âœ… è³‡æ–™åº«å¯«å…¥å®Œç•¢ã€‚');

                } catch(err) {
                    console.error(err);
                    status.innerHTML = `<span style="color:#dc3545">âŒ ä¸Šå‚³å¤±æ•—: ${err.message || err}</span>`;
                    log(`âŒ éŒ¯èª¤è©³æƒ…: ${err.message}`);
                } finally {
                    btn.disabled = false;
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
