<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­è¡¨ä¸Šå‚³ (BNå°ˆç”¨ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f8f9fa; max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #666; display: flex; align-items: center; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h3 { margin-top: 0; }
        .instruction { background: #e8f0fe; padding: 15px; border-radius: 4px; font-size: 14px; color: #1967d2; margin-bottom: 20px; line-height: 1.6; }
        
        input[type="file"] { margin: 20px 0; }
        button { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        #status { margin-top: 15px; font-weight: bold; white-space: pre-wrap; }
        .log-box { margin-top: 10px; padding: 10px; background: #f1f1f1; border-radius: 4px; max-height: 200px; overflow-y: auto; font-size: 12px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
    </div>

    <div class="card">
        <h3>ğŸ“… ä¸Šå‚³ Excel ç‡Ÿé¤Šæ²»ç™‚ç§‘ç­è¡¨</h3>
        
        <div class="instruction">
            <strong>ğŸ’¡ è§£æé‚è¼¯èªªæ˜ï¼š</strong><br>
            1. ç¨‹å¼æœƒè®€å– Excel ä¸­<strong>æ¯ä¸€å€‹ Sheet</strong>ï¼ˆå‡è¨­ç‚ºä¸åŒæœˆä»½ï¼‰ã€‚<br>
            2. å¾ Sheet æœ€å·¦ä¸Šè§’ (A1) åˆ¤æ–·å¹´ä»½èˆ‡æœˆä»½ (ä¾‹å¦‚ï¼š...2025å¹´12æœˆ...)ã€‚<br>
            3. å°‹æ‰¾ç¬¬ 3 åˆ— (Row 3) ä½œç‚ºæ—¥æœŸåˆ— (1, 2, 3...)ã€‚<br>
            4. å°‹æ‰¾æœ€å·¦é‚Š (Column A) ä½œç‚ºäººå“¡å§“åã€‚<br>
            5. <strong>é—œéµå­—åˆ¤æ–·ï¼š</strong> åªè¦æ ¼å­å…§åŒ…å« <code>BN</code> (å¦‚ BN, BN+3, BN+1) å³è¦–ç‚ºå€¼ç­ã€‚
        </div>

        <input type="file" id="fileInput" accept=".xlsx, .xls">
        <button id="uploadBtn" onclick="processExcel()">é–‹å§‹åˆ†æä¸¦åŒ¯å…¥</button>
        <div id="status"></div>
        <div id="log" class="log-box" style="display:none;"></div>
    </div>

    <script>
        function cleanString(str) { return str ? str.replace(/[^\x20-\x7E]/g, '').trim() : ''; }
        const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
        const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
        const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

        function log(message) {
            const logBox = document.getElementById('log');
            logBox.style.display = 'block';
            logBox.innerHTML += message + '<br>';
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function processExcel() {
            const fileInput = document.getElementById('fileInput');
            const status = document.getElementById('status');
            const btn = document.getElementById('uploadBtn');
            
            if(!fileInput.files.length) { status.innerText = 'âŒ è«‹é¸æ“‡æª”æ¡ˆ'; return; }
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            status.innerText = 'â³ è®€å–ä¸­...';
            document.getElementById('log').innerHTML = ''; // æ¸…ç©º Log
            btn.disabled = true;

            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    let allInsertData = [];
                    
                    // è¿´åœˆéæ­·æ¯ä¸€å€‹ Sheet (æœˆä»½)
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});

                        if (rows.length < 5) return; // è·³éè³‡æ–™å¤ªå°‘çš„ Sheet

                        // 1. å˜—è©¦å¾ A1 (Row 0, Col 0) æŠ“å– å¹´ä»½èˆ‡æœˆä»½
                        // é æœŸæ ¼å¼ç¯„ä¾‹: "ç‡Ÿé¤Šæ²»ç™‚ç§‘ç­è¡¨-2025å¹´12æœˆ"
                        const titleCell = rows[0][0];
                        if (!titleCell || typeof titleCell !== 'string') return;

                        const dateMatch = titleCell.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
                        if (!dateMatch) {
                            log(`âš ï¸ è·³é Sheet [${sheetName}]ï¼šç„¡æ³•åœ¨ A1 è­˜åˆ¥å‡º 'YYYYå¹´MMæœˆ'`);
                            return;
                        }

                        const year = dateMatch[1];
                        const month = dateMatch[2].padStart(2, '0');
                        log(`ğŸ“‚ åˆ†æ Sheet [${sheetName}] - è­˜åˆ¥ç‚º ${year}å¹´${month}æœˆ`);

                        // 2. å®šä½æ—¥æœŸåˆ— (Row Index 2, å³ Excel ç¬¬ 3 åˆ—)
                        // è©²åˆ—æ ¼å¼é æœŸï¼š[å§“å, 1, 2, 3, 4, ... , 31, ...]
                        const dayRowIndex = 2;
                        const dayRow = rows[dayRowIndex];
                        
                        // å»ºç«‹ æ¬„ä½ç´¢å¼• -> æ—¥æœŸå­—ä¸² çš„å°æ‡‰è¡¨
                        let colToDateMap = {}; 
                        for (let c = 1; c < dayRow.length; c++) {
                            const dayVal = dayRow[c];
                            // æª¢æŸ¥æ˜¯å¦ç‚º 1~31 çš„æ•¸å­—
                            if (dayVal && !isNaN(dayVal) && dayVal >= 1 && dayVal <= 31) {
                                const dayStr = String(dayVal).padStart(2, '0');
                                colToDateMap[c] = `${year}-${month}-${dayStr}`;
                            }
                        }

                        // 3. éæ­·äººå“¡è³‡æ–™ (å¾ Row Index 4 é–‹å§‹ï¼Œå³ Excel ç¬¬ 5 åˆ—)
                        for (let r = 4; r < rows.length; r++) {
                            const row = rows[r];
                            const staffName = row[0]; // Aæ¬„æ˜¯å§“å

                            if (!staffName) continue; // è·³éæ²’æœ‰åå­—çš„åˆ—

                            // æª¢æŸ¥è©²äººå“¡æ¯ä¸€å¤©çš„ç­è¡¨
                            for (let c in colToDateMap) {
                                const cellValue = row[c];
                                const dateStr = colToDateMap[c];

                                // åˆ¤æ–·æ˜¯å¦åŒ…å« BN (è½‰å¤§å¯«æ¯”å°ï¼ŒåŒ…å« BN, BN+1, BN+3...)
                                if (cellValue && typeof cellValue === 'string') {
                                    if (cellValue.toUpperCase().includes('BN')) {
                                        
                                        allInsertData.push({
                                            date: dateStr,
                                            shift: cellValue, // ä¿ç•™åŸå§‹å…§å®¹ (å¦‚ BN+3)
                                            staff_name: staffName,
                                            staff_email: '' // Excel ç„¡ emailï¼Œç•™ç©º
                                        });
                                    }
                                }
                            }
                        }
                    });

                    if (allInsertData.length === 0) {
                        status.innerText = 'âš ï¸ åˆ†æå®Œæˆï¼Œä½†åœ¨æª”æ¡ˆä¸­æ‰¾ä¸åˆ°ä»»ä½•å«æœ‰ "BN" çš„æ’ç­è³‡æ–™ã€‚';
                        btn.disabled = false;
                        return;
                    }

                    status.innerText = `ğŸ“Š è®€å–åˆ° ${allInsertData.length} ç­† BN å€¼ç­è³‡æ–™ï¼Œæ­£åœ¨å¯«å…¥è³‡æ–™åº«...`;
                    console.log('æº–å‚™å¯«å…¥:', allInsertData);

                    // å¯«å…¥ Supabase
                    const { error } = await supabase.from('duty_roster').insert(allInsertData);
                    
                    if(error) throw error;
                    
                    status.innerHTML = `<span style="color:green">âœ… æˆåŠŸåŒ¯å…¥ ${allInsertData.length} ç­†è³‡æ–™ï¼</span>`;
                    log('âœ… è³‡æ–™åº«å¯«å…¥å®Œæˆã€‚');

                } catch(err) {
                    console.error(err);
                    status.innerText = 'âŒ å¤±æ•—: ' + err.message;
                } finally {
                    btn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
