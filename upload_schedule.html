<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­è¡¨ä¸Šå‚³</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f8f9fa; max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #666; display: flex; align-items: center; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h3 { margin-top: 0; color: #333; }
        .instruction { background: #e8f0fe; padding: 15px; border-radius: 4px; font-size: 14px; color: #1967d2; margin-bottom: 20px; line-height: 1.6; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="file"], input[type="month"] { display: block; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        button { padding: 12px 24px; background: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.2s; width: 100%; margin-top: 10px; }
        button:hover { background: #0b5ed7; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        #status { margin-top: 15px; font-weight: bold; white-space: pre-wrap; line-height: 1.5; }
        .log-box { margin-top: 15px; padding: 12px; background: #212529; color: #0f0; border-radius: 6px; max-height: 250px; overflow-y: auto; font-size: 12px; font-family: Consolas, monospace; display: none; }

        /* æ–°å¢ï¼šçµæœé è¦½è¡¨æ ¼æ¨£å¼ */
        #resultArea { display: none; margin-top: 20px; }
        .table-container { overflow-x: auto; border: 1px solid #dee2e6; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 14px; }
        th { background-color: #f1f3f5; color: #495057; white-space: nowrap; }
        tr:hover { background-color: #f8f9fa; }
        .tag-shift { background: #e3f2fd; color: #0d47a1; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
    </div>

    <div class="card">
        <h3>ğŸ“… ä¸Šå‚³ Excel ç­è¡¨ (æŒ‡å®šæœˆä»½ç‰ˆ)</h3>
        
        <div class="instruction">
            <strong>ğŸ’¡ åŠŸèƒ½æ›´æ–°ï¼š</strong><br>
            1. é è¨­è‡ªå‹•æŠ“å– Excel ä¸­ <strong>æœ€æ–°çš„ä¸€å€‹æœˆä»½</strong>ã€‚<br>
            2. è‹¥è¦ä¸Šå‚³ç‰¹å®šæœˆä»½ï¼ˆå¦‚ä¿®æ­£èˆŠè³‡æ–™ï¼‰ï¼Œè«‹åœ¨ä¸‹æ–¹æ‰‹å‹•é¸æ“‡ã€‚<br>
            3. <strong>ä¸Šå‚³å¾Œä¸‹æ–¹æœƒé¡¯ç¤ºè©³ç´°æ¸…å–®ä¾›æ‚¨æ ¸å°ã€‚</strong>
        </div>

        <div class="form-group">
            <label for="targetMonth">æŒ‡å®šä¸Šå‚³æœˆä»½ (é¸å¡«ï¼Œä¸é¸å‰‡è‡ªå‹•æŠ“æœ€æ–°)</label>
            <input type="month" id="targetMonth">
        </div>

        <div class="form-group">
            <label for="fileInput">é¸æ“‡ Excel æª”æ¡ˆ (.xlsx)</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
        </div>

        <button id="uploadBtn" onclick="processExcel()">ğŸš€ é–‹å§‹åˆ†æä¸¦ä¸Šå‚³</button>
        <div id="status"></div>
        <div id="log" class="log-box"></div>
    </div>

    <div id="resultArea" class="card">
        <h3>ğŸ“‹ å€¼ç­äººå“¡æ¸…å–®é è¦½</h3>
        <p style="color: #666; font-size: 0.9em;">è«‹ç¢ºèªä»¥ä¸‹æ—¥æœŸèˆ‡äººå“¡æ˜¯å¦æ­£ç¢ºï¼š</p>
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>å§“å</th>
                        <th>ç­åˆ¥ä»£ç¢¼</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // ç°¡å–®çš„å­—ä¸²æ¸…ç†å‡½æ•¸
        function cleanString(str) { return str ? str.replace(/[^\x20-\x7E]/g, '').trim() : ''; }
        
        // Supabase è¨­å®š
        const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
        const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
        const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

        function log(message) {
            const logBox = document.getElementById('log');
            logBox.style.display = 'block';
            logBox.innerHTML += `<div>${message}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function processExcel() {
            const fileInput = document.getElementById('fileInput');
            const targetMonthInput = document.getElementById('targetMonth');
            const status = document.getElementById('status');
            const btn = document.getElementById('uploadBtn');
            const logBox = document.getElementById('log');
            const resultArea = document.getElementById('resultArea'); // å–å¾—çµæœå€å¡Š
            
            // é‡ç½®ç•«é¢
            resultArea.style.display = 'none'; 
            status.innerText = '';
            
            if(!fileInput.files.length) { status.innerText = 'âŒ è«‹å…ˆé¸æ“‡ Excel æª”æ¡ˆ (.xlsx)'; return; }
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            status.innerText = 'â³ æ­£åœ¨è®€å–ä¸¦åˆ†ææª”æ¡ˆ...';
            logBox.innerHTML = ''; 
            btn.disabled = true;

            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    let validSheets = [];

                    // 1. å…ˆæƒææ‰€æœ‰ Sheet
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
                        if (rows.length < 5) return;

                        const titleCell = rows[0][0];
                        if (!titleCell || typeof titleCell !== 'string') return;

                        const dateMatch = titleCell.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
                        if (dateMatch) {
                            const year = dateMatch[1];
                            const month = dateMatch[2].padStart(2, '0');
                            validSheets.push({
                                sheetName: sheetName,
                                year: year,
                                month: month,
                                sortKey: parseInt(year + month),
                                rows: rows
                            });
                        }
                    });

                    if (validSheets.length === 0) {
                        throw new Error("ç„¡æ³•åœ¨æª”æ¡ˆä¸­è­˜åˆ¥å‡ºä»»ä½•æœ‰æ•ˆçš„æœˆä»½æ¨™é¡Œ (éœ€åŒ…å« YYYYå¹´MMæœˆ)ã€‚");
                    }

                    // 2. æ±ºå®šè¦è™•ç†å“ªä¸€å€‹ Sheet
                    let targetSheet = null;
                    const userSelectedMonth = targetMonthInput.value;

                    if (userSelectedMonth) {
                        const [uYear, uMonth] = userSelectedMonth.split('-');
                        targetSheet = validSheets.find(s => s.year === uYear && s.month === uMonth);
                        
                        if (!targetSheet) {
                            throw new Error(`æª”æ¡ˆä¸­æ‰¾ä¸åˆ°å°æ‡‰ ${uYear}å¹´${uMonth}æœˆ çš„å·¥ä½œè¡¨ã€‚`);
                        }
                        log(`ğŸ¯ ä½¿ç”¨è€…æŒ‡å®šè™•ç†ï¼š${targetSheet.year}å¹´${targetSheet.month}æœˆ`);
                    } else {
                        validSheets.sort((a, b) => b.sortKey - a.sortKey);
                        targetSheet = validSheets[0];
                        log(`ğŸ¤– è‡ªå‹•é¸æ“‡æœ€æ–°æœˆä»½ï¼š${targetSheet.year}å¹´${targetSheet.month}æœˆ`);
                    }

                    // 3. é–‹å§‹è§£æ
                    let allInsertData = [];
                    const rows = targetSheet.rows;
                    const year = targetSheet.year;
                    const month = targetSheet.month;
                    const dayRowIndex = 2;
                    const dayRow = rows[dayRowIndex];
                    if (!dayRow) throw new Error("æ‰¾ä¸åˆ°æ—¥æœŸåˆ— (Excel ç¬¬3åˆ—)");

                    let colToDateMap = {}; 
                    for (let c = 1; c < dayRow.length; c++) {
                        const dayVal = dayRow[c];
                        if (dayVal && !isNaN(dayVal) && dayVal >= 1 && dayVal <= 31) {
                            const dayStr = String(dayVal).padStart(2, '0');
                            colToDateMap[c] = `${year}-${month}-${dayStr}`;
                        }
                    }

                    for (let r = 4; r < rows.length; r++) {
                        const row = rows[r];
                        const staffName = row[0];

                        if (!staffName || typeof staffName !== 'string') continue;
                        if (staffName.trim().startsWith('*') || staffName.includes('ä¸»ç®¡') || staffName.length > 8) continue;

                        for (let c in colToDateMap) {
                            const cellValue = row[c];
                            const dateStr = colToDateMap[c];

                            if (cellValue && typeof cellValue === 'string') {
                                if (cellValue.toUpperCase().includes('BN')) {
                                    allInsertData.push({
                                        date: dateStr,
                                        shift: cellValue.trim(), 
                                        staff_name: staffName.trim(),
                                        staff_email: '' 
                                    });
                                }
                            }
                        }
                    }

                    if (allInsertData.length === 0) {
                        status.innerText = `âš ï¸ åœ¨ ${year}å¹´${month}æœˆ ä¸­æ²’æœ‰ç™¼ç¾ä»»ä½•å«æœ‰ "BN" çš„æ’ç­ã€‚`;
                        btn.disabled = false;
                        return;
                    }

                    // --- æ¸²æŸ“è¡¨æ ¼ (æ–°å¢çš„åŠŸèƒ½) ---
                    renderTable(allInsertData);
                    // ---------------------------

                    status.innerText = `ğŸ“Š åˆ†æå®Œæˆï¼\nğŸ“… æœˆä»½ï¼š${year}-${month}\nğŸ“ ç­†æ•¸ï¼š${allInsertData.length} ç­†\nğŸš€ æ­£åœ¨å¯«å…¥è³‡æ–™åº«...`;
                    
                    const { error } = await supabase.from('duty_roster').insert(allInsertData);
                    
                    if(error) throw error;
                    
                    status.innerHTML = `<span style="color:#198754; font-size:1.1em;">âœ… ä¸Šå‚³æˆåŠŸï¼å·²åŒ¯å…¥ ${year}å¹´${month}æœˆ å…± ${allInsertData.length} ç­†è³‡æ–™ã€‚</span><br>è«‹æŸ¥çœ‹ä¸‹æ–¹è¡¨æ ¼ç¢ºèªå…§å®¹ã€‚`;
                    log('âœ… è³‡æ–™åº«å¯«å…¥å®Œç•¢ã€‚');

                } catch(err) {
                    console.error(err);
                    status.innerHTML = `<span style="color:#dc3545">âŒ ä¸Šå‚³å¤±æ•—: ${err.message || err}</span>`;
                    log(`âŒ éŒ¯èª¤è©³æƒ…: ${err.message}`);
                } finally {
                    btn.disabled = false;
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // æ–°å¢ï¼šç¹ªè£½è¡¨æ ¼çš„å‡½æ•¸
        function renderTable(data) {
            const resultArea = document.getElementById('resultArea');
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = ''; // æ¸…ç©ºèˆŠè³‡æ–™

            // æ ¹æ“šæ—¥æœŸæ’åºï¼Œè®“è¡¨æ ¼çœ‹èµ·ä¾†æ¯”è¼ƒé †
            data.sort((a, b) => new Date(a.date) - new Date(b.date));

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.date}</td>
                    <td style="font-weight:bold;">${item.staff_name}</td>
                    <td><span class="tag-shift">${item.shift}</span></td>
                `;
                tbody.appendChild(tr);
            });

            // é¡¯ç¤ºå€åŸŸ
            resultArea.style.display = 'block';
            
            // è‡ªå‹•æ²å‹•åˆ°è¡¨æ ¼å€åŸŸï¼Œæ–¹ä¾¿ä½¿ç”¨è€…æŸ¥çœ‹
            resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
