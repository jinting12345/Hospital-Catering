<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¾¿ç•¶ä¸Šå‚³</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>
    
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        window.createClient = createClient; // æ›è¼‰åˆ°å…¨åŸŸ
    </script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f8f9fa; max-width: 600px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #666; font-size: 14px; display: flex; align-items: center; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        
        .section { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h3 { margin: 0 0 10px 0; font-size: 16px; color: #333; }
        
        input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; text-align: center; font-size: 16px; }
        
        .btn-group { display: flex; gap: 10px; }
        .toggle-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background: white; transition: 0.2s; }
        .toggle-btn.active { background: #1a73e8; color: white; border-color: #1a73e8; font-weight: bold; }
        
        .upload-area { display: none; margin-top: 15px; text-align: center; }
        
        .action-buttons { display: flex; gap: 10px; margin: 15px 0; }
        .camera-btn { flex: 1; background: #28a745; color: white; padding: 12px; border-radius: 30px; border: none; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .gallery-btn { flex: 1; background: #ffc107; color: #333; padding: 12px; border-radius: 30px; border: none; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: bold; }

        #preview { width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; }
        #status { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
        <button id="logoutBtn" class="logout-btn">ç™»å‡º</button>
    </div>

    <div class="section">
        <h3>ğŸ“… ä¸Šå‚³æ—¥æœŸ</h3>
        <input type="date" id="dateInput">
    </div>

    <div class="section">
        <h3>ğŸ‘¥ ä¾›é¤å°è±¡</h3>
        <div class="btn-group" id="targetGroup">
            <button class="toggle-btn" onclick="selectTarget('nursing')">ğŸ  è­·å®¶é¤</button>
            <button class="toggle-btn" onclick="selectTarget('patient')">ğŸ¥ ç—…æ‚£é¤</button>
        </div>
    </div>

    <div class="section" id="mealSection" style="display:none;">
        <h3>ğŸ½ï¸ é¤åˆ¥</h3>
        <div class="btn-group" id="mealGroup">
            <button class="toggle-btn" onclick="selectMeal('breakfast')">æ—©é¤</button>
            <button class="toggle-btn" onclick="selectMeal('lunch')">åˆé¤</button>
            <button class="toggle-btn" onclick="selectMeal('dinner')">æ™šé¤</button>
        </div>

        <div class="upload-area" id="uploadArea">
            <hr style="border-top:1px solid #eee; margin: 20px 0;">
            <p>å³å°‡ä¸Šå‚³ï¼š<span id="summary" style="color:#1a73e8; font-weight:bold;"></span></p>
            
            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="processImage(this)">
            <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="processImage(this)">
            
            <div class="action-buttons">
                <button class="camera-btn" onclick="document.getElementById('cameraInput').click()">ğŸ“¸ æ‹ç…§</button>
                <button class="gallery-btn" onclick="document.getElementById('galleryInput').click()">ğŸ–¼ï¸ é¸ç…§ç‰‡</button>
            </div>
            
            <img id="preview">
            <div id="status"></div>
            <button id="submitBtn" onclick="uploadData()" style="width:100%; padding:12px; background:#1a73e8; color:white; border:none; border-radius:6px; font-size:16px; margin-top:15px; display:none;">ç¢ºèªä¸Šå‚³</button>
        </div>
    </div>

    <script>
        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.onerror = function(msg, src, line) {
            alert("âš ï¸ éŒ¯èª¤: " + msg);
            return false;
        };

        const BUCKET_NAME = 'private_photos'; 
        const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
        const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
        
        let supabase = null;
        let curTarget = '', curMeal = '', processedFile = null;

        // ğŸ”¥ ä¿®æ”¹ 3: åˆå§‹åŒ–é‚è¼¯ (ç­‰å¾… ESM)
        window.onload = async () => {
            setTimeout(async () => {
                try {
                    if (window.createClient) {
                        supabase = window.createClient(RAW_URL, RAW_KEY);
                        await initApp();
                    } else {
                        throw new Error("Supabase å…ƒä»¶è¼‰å…¥å¤±æ•—");
                    }
                } catch(e) {
                    alert("âš ï¸ ç³»çµ±å…ƒä»¶è¢«é˜»æ“‹ï¼Œç„¡æ³•ä½¿ç”¨ä¸Šå‚³åŠŸèƒ½ã€‚\nè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚");
                    // å¼·åˆ¶ç¶å®šç™»å‡ºå›é¦–é 
                    document.getElementById('logoutBtn').onclick = () => window.location.href = 'index.html';
                }
            }, 100);
        };

        async function initApp() {
            // ç¶å®šç™»å‡º
            document.getElementById('logoutBtn').onclick = async () => {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            };

            const { data } = await supabase.auth.getSession();
            if(!data.session) window.location.href = 'index.html';
            
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('dateInput').value = `${yyyy}-${mm}-${dd}`;
        }

        function selectTarget(type) {
            curTarget = type;
            updateUI('targetGroup', type);
            document.getElementById('mealSection').style.display = 'block';
            updateSummary();
        }

        function selectMeal(type) {
            curMeal = type;
            updateUI('mealGroup', type);
            document.getElementById('uploadArea').style.display = 'block';
            updateSummary();
        }

        function updateUI(groupId, activeType) {
            const btns = document.getElementById(groupId).querySelectorAll('button');
            btns.forEach(b => {
                if(b.getAttribute('onclick').includes(activeType)) b.classList.add('active');
                else b.classList.remove('active');
            });
        }

        function updateSummary() {
            const date = document.getElementById('dateInput').value;
            const tName = curTarget==='nursing'?'è­·å®¶':'ç—…æ‚£';
            const mName = curMeal==='breakfast'?'æ—©é¤':curMeal==='lunch'?'åˆé¤':'æ™šé¤';
            document.getElementById('summary').innerText = `${date} / ${tName} / ${mName}`;
        }

        // --- æµ®æ°´å°è™•ç†å‡½æ•¸ ---
        async function addWatermark(imageFile, text) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(imageFile);
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    ctx.drawImage(img, 0, 0);
                    
                    const fontSize = Math.max(20, canvas.width * 0.04); 
                    ctx.font = `bold ${fontSize}px "Microsoft JhengHei", sans-serif`;
                    ctx.textBaseline = 'bottom';
                    ctx.textAlign = 'right';
                    
                    const padding = fontSize * 0.4;
                    const textMetrics = ctx.measureText(text);
                    const boxWidth = textMetrics.width + padding * 2;
                    const boxHeight = fontSize + padding * 2;
                    
                    const x = canvas.width - padding; 
                    const y = canvas.height - padding; 

                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.fillRect(canvas.width - boxWidth, canvas.height - boxHeight, boxWidth, boxHeight);
                    
                    ctx.fillStyle = 'white';
                    ctx.fillText(text, x - padding/2, y - padding/2);
                    
                    canvas.toBlob(blob => {
                        resolve(blob);
                    }, 'image/jpeg', 0.95);
                };
                
                img.onerror = reject;
            });
        }

        async function processImage(inputElement) {
            const file = inputElement.files[0]; 
            if(!file) return;
            document.getElementById('status').innerText = 'è™•ç†ä¸­ (å£“ç¸®+å£“å­—)...';
            
            try {
                // æª¢æŸ¥ browser-image-compression æ˜¯å¦è¼‰å…¥
                if (typeof imageCompression === 'undefined') {
                    throw new Error("åœ–ç‰‡å£“ç¸®å…ƒä»¶æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†");
                }

                const options = { maxSizeMB: 0.5, maxWidthOrHeight: 1280, useWebWorker: true };
                const compressed = await imageCompression(file, options);
                
                const date = document.getElementById('dateInput').value;
                const mName = curMeal==='breakfast'?'æ—©é¤':curMeal==='lunch'?'åˆé¤':'æ™šé¤';
                const tName = curTarget==='nursing'?'è­·å®¶é¤':'ç—…æ‚£é¤';
                
                const watermarkText = `${date} ${tName} ${mName}`;
                const watermarkedBlob = await addWatermark(compressed, watermarkText);
                
                processedFile = new File([watermarkedBlob], "watermarked.jpg", { type: "image/jpeg" });

                document.getElementById('preview').src = URL.createObjectURL(processedFile);
                document.getElementById('preview').style.display = 'block';
                document.getElementById('submitBtn').style.display = 'block';
                document.getElementById('status').innerText = '';
                
                inputElement.value = ''; 

            } catch(e) { 
                console.error(e);
                alert('åœ–ç‰‡è™•ç†å¤±æ•—: ' + e.message); 
                document.getElementById('status').innerText = 'âŒ åœ–ç‰‡è™•ç†å¤±æ•—';
            }
        }

        async function uploadData() {
            if(!processedFile) return;
            if(!supabase) { alert("ç³»çµ±æœªé€£ç·š"); return; }

            const btn = document.getElementById('submitBtn');
            const date = document.getElementById('dateInput').value;
            
            const tName = curTarget === 'nursing' ? 'è­·å®¶é¤' : 'ç—…æ‚£é¤';
            const mName = curMeal === 'breakfast' ? 'æ—©é¤' : curMeal === 'lunch' ? 'åˆé¤' : 'æ™šé¤';

            btn.disabled = true; 
            btn.innerText = 'æª¢æŸ¥ä¸­...';
            document.getElementById('status').innerText = 'ğŸ” æ­£åœ¨æª¢æŸ¥é‡è¤‡è³‡æ–™...';

            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š");

                // 1. æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const { data: existingRecord, error: checkError } = await supabase
                    .from('meal_records')
                    .select('id, photo_path')
                    .eq('record_date', date)
                    .eq('target_type', curTarget)
                    .eq('meal_type', curMeal)
                    .maybeSingle();

                if (checkError) throw new Error('æª¢æŸ¥é‡è¤‡å¤±æ•—: ' + checkError.message);

                // 2. è©¢å•è¦†è“‹
                if (existingRecord) {
                    const userInput = prompt(`âš ï¸ è­¦å‘Šï¼šé‡è¤‡ä¸Šå‚³ï¼\n\nã€${date} ${tName} ${mName}ã€‘å·²ç¶“æœ‰ç…§ç‰‡äº†ã€‚\n\nè‹¥ç¢ºå®šè¦ç”¨é€™å¼µæ–°ç…§ç‰‡ã€Œè¦†è“‹ã€èˆŠçš„ï¼Œè«‹åœ¨ä¸‹æ–¹è¼¸å…¥ "è¦†è“‹" äºŒå­—ï¼š`);

                    if (userInput !== "è¦†è“‹") {
                        btn.disabled = false;
                        btn.innerText = 'ç¢ºèªä¸Šå‚³';
                        document.getElementById('status').innerText = 'ğŸš« å·²å–æ¶ˆä¸Šå‚³ (æœªè¦†è“‹)';
                        return; 
                    }

                    document.getElementById('status').innerText = 'ğŸ—‘ï¸ æ­£åœ¨åˆªé™¤èˆŠè³‡æ–™...';

                    if (existingRecord.photo_path) {
                        await supabase.storage.from(BUCKET_NAME).remove([existingRecord.photo_path]);
                    }

                    const { error: delErr } = await supabase
                        .from('meal_records')
                        .delete()
                        .eq('id', existingRecord.id);
                    
                    if (delErr) throw new Error('èˆŠè³‡æ–™åˆªé™¤å¤±æ•—: ' + delErr.message);
                }

                // 3. ä¸Šå‚³æ–°è³‡æ–™
                btn.innerText = 'ä¸Šå‚³ä¸­...';
                document.getElementById('status').innerText = 'â³ æ­£åœ¨ä¸Šå‚³æ–°ç…§ç‰‡...';

                const fileName = `${date}_${curTarget}_${curMeal}_${Date.now()}.jpg`;
                
                const { error: upErr } = await supabase.storage.from(BUCKET_NAME).upload(fileName, processedFile);
                if(upErr) throw new Error('åœ–ç‰‡ä¸Šå‚³å¤±æ•—: ' + upErr.message);

                const userName = user.email ? user.email.split('@')[0] : 'Unknown';

                const { error: dbErr } = await supabase.from('meal_records').insert([{
                    user_id: user.id,           
                    record_date: date,          
                    meal_type: curMeal,
                    target_type: curTarget,
                    photo_path: fileName,       
                    uploader_name: userName     
                }]);
                
                if(dbErr) throw new Error('è³‡æ–™åº«å¯«å…¥å¤±æ•—: ' + dbErr.message);

                document.getElementById('status').innerHTML = '<span style="color:green; font-size:1.2em;">âœ… ä¸Šå‚³æˆåŠŸï¼</span>';
                
                setTimeout(() => location.reload(), 1500);

            } catch(e) {
                console.error(e);
                alert('ä¸Šå‚³å¤±æ•—ï¼š' + e.message);
                document.getElementById('status').innerHTML = `<span style="color:red">âŒ ${e.message}</span>`;
                btn.disabled = false; 
                btn.innerText = 'ç¢ºèªä¸Šå‚³';
            }
        }
    </script>
</body>
</html>
