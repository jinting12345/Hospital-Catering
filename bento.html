<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¾¿ç•¶ä¸Šå‚³</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f8f9fa; max-width: 600px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #666; font-size: 14px; display: flex; align-items: center; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        
        .section { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h3 { margin: 0 0 10px 0; font-size: 16px; color: #333; }
        
        input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; text-align: center; font-size: 16px; }
        
        .btn-group { display: flex; gap: 10px; }
        .toggle-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background: white; transition: 0.2s; }
        .toggle-btn.active { background: #1a73e8; color: white; border-color: #1a73e8; font-weight: bold; }
        
        .upload-area { display: none; margin-top: 15px; text-align: center; }
        .camera-btn { background: #28a745; color: white; padding: 12px 24px; border-radius: 30px; border: none; font-size: 18px; cursor: pointer; margin: 15px 0; }
        #preview { width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; }
        #status { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
        <button onclick="handleLogout()" class="logout-btn">ç™»å‡º</button>
    </div>

    <!-- 1. æ—¥æœŸ -->
    <div class="section">
        <h3>ğŸ“… ä¸Šå‚³æ—¥æœŸ</h3>
        <input type="date" id="dateInput">
    </div>

    <!-- 2. å°è±¡ -->
    <div class="section">
        <h3>ğŸ‘¥ ä¾›é¤å°è±¡</h3>
        <div class="btn-group" id="targetGroup">
            <button class="toggle-btn" onclick="selectTarget('nursing')">ğŸ  è­·å®¶é¤</button>
            <button class="toggle-btn" onclick="selectTarget('patient')">ğŸ¥ ç—…æ‚£é¤</button>
        </div>
    </div>

    <!-- 3. é¤åˆ¥ (é¸å®Œå°è±¡é¡¯ç¤º) -->
    <div class="section" id="mealSection" style="display:none;">
        <h3>ğŸ½ï¸ é¤åˆ¥</h3>
        <div class="btn-group" id="mealGroup">
            <button class="toggle-btn" onclick="selectMeal('breakfast')">æ—©é¤</button>
            <button class="toggle-btn" onclick="selectMeal('lunch')">åˆé¤</button>
            <button class="toggle-btn" onclick="selectMeal('dinner')">æ™šé¤</button>
        </div>

        <!-- 4. æ‹ç…§ -->
        <div class="upload-area" id="uploadArea">
            <hr style="border-top:1px solid #eee; margin: 20px 0;">
            <p>å³å°‡ä¸Šå‚³ï¼š<span id="summary" style="color:#1a73e8; font-weight:bold;"></span></p>
            
            <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none" onchange="processImage()">
            <button class="camera-btn" onclick="document.getElementById('fileInput').click()">ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ / é¸ç…§ç‰‡</button>
            
            <img id="preview">
            <div id="status"></div>
            <button id="submitBtn" onclick="uploadData()" style="width:100%; padding:12px; background:#1a73e8; color:white; border:none; border-radius:6px; font-size:16px; margin-top:15px; display:none;">ç¢ºèªä¸Šå‚³</button>
        </div>
    </div>

    <script>
        function cleanString(str) { return str.replace(/[^\x20-\x7E]/g, '').trim(); }
        const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
        const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
        const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

        let curTarget = '', curMeal = '', compressedFile = null;

        // åˆå§‹åŒ–
        (async () => {
            const { data } = await supabase.auth.getSession();
            if(!data.session) window.location.href = 'index.html';
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
        })();

        async function handleLogout() { await supabase.auth.signOut(); window.location.href = 'index.html'; }

        function selectTarget(type) {
            curTarget = type;
            updateUI('targetGroup', type);
            document.getElementById('mealSection').style.display = 'block';
            updateSummary();
        }

        function selectMeal(type) {
            curMeal = type;
            updateUI('mealGroup', type);
            document.getElementById('uploadArea').style.display = 'block';
            updateSummary();
        }

        function updateUI(groupId, activeType) {
            const btns = document.getElementById(groupId).querySelectorAll('button');
            btns.forEach(b => {
                // ç°¡å–®åˆ¤æ–·ï¼šçœ‹ onclick å…§å®¹æ˜¯å¦åŒ…å« activeType
                if(b.getAttribute('onclick').includes(activeType)) b.classList.add('active');
                else b.classList.remove('active');
            });
        }

        function updateSummary() {
            const date = document.getElementById('dateInput').value;
            const tName = curTarget==='nursing'?'è­·å®¶':'ç—…æ‚£';
            const mName = curMeal==='breakfast'?'æ—©é¤':curMeal==='lunch'?'åˆé¤':'æ™šé¤';
            document.getElementById('summary').innerText = `${date} / ${tName} / ${mName}`;
        }

        async function processImage() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return;
            document.getElementById('status').innerText = 'è™•ç†ä¸­...';
            try {
                const options = { maxSizeMB: 0.5, maxWidthOrHeight: 1280, useWebWorker: true };
                compressedFile = await imageCompression(file, options);
                document.getElementById('preview').src = URL.createObjectURL(compressedFile);
                document.getElementById('preview').style.display = 'block';
                document.getElementById('submitBtn').style.display = 'block';
                document.getElementById('status').innerText = '';
            } catch(e) { alert('åœ–ç‰‡è™•ç†å¤±æ•—'); }
        }

        async function uploadData() {
            if(!compressedFile) return;
            const btn = document.getElementById('submitBtn');
            const date = document.getElementById('dateInput').value;
            btn.disabled = true; btn.innerText = 'ä¸Šå‚³ä¸­...';

            try {
                // æª”åï¼šæ—¥æœŸ_å°è±¡_é¤åˆ¥_äº‚æ•¸.jpg
                const fileName = `${date}_${curTarget}_${curMeal}_${Date.now()}.jpg`;
                
                const { error: upErr } = await supabase.storage.from('photos').upload(fileName, compressedFile);
                if(upErr) throw upErr;

                const { error: dbErr } = await supabase.from('meal_logs').insert([{
                    meal_date: date,
                    meal_type: curMeal,
                    target_type: curTarget,
                    image_path: fileName,
                    uploader_email: (await supabase.auth.getUser()).data.user.email
                }]);
                if(dbErr) throw dbErr;

                document.getElementById('status').innerHTML = '<span style="color:green">âœ… ä¸Šå‚³æˆåŠŸ</span>';
                setTimeout(() => location.reload(), 1500);
            } catch(e) {
                console.error(e);
                document.getElementById('status').innerText = 'âŒ å¤±æ•—: ' + e.message;
                btn.disabled = false; btn.innerText = 'ç¢ºèªä¸Šå‚³';
            }
        }
    </script>
</body>
</html>

