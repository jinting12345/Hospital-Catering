<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¾¿ç•¶æ‹ç…§ä¸Šå‚³</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; max-width: 600px; margin: 0 auto; text-align: center; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #666; text-decoration: none; font-size: 14px; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .meal-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; background-color: #e0e0e0; transition: 0.2s; }
        .meal-btn.active { background-color: #28a745; color: white; font-weight: bold; }
        
        .upload-section { display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .camera-btn { background: #007bff; color: white; padding: 12px 24px; border-radius: 30px; border: none; font-size: 18px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; margin: 15px 0; }
        #preview { width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; }
        .submit-btn { width: 100%; padding: 14px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; display: none; }
        .submit-btn:disabled { background: #ccc; }
        #status { margin-top: 15px; font-weight: bold; min-height: 24px; }
    </style>
</head>
<body>
    <a href="menu.html" class="back-link">â¬…ï¸ è¿”å›é¸å–®</a>
    <h2>ğŸ± ä»Šæ—¥ä¾¿ç•¶ä¸Šå‚³</h2>

    <div class="btn-group">
        <button class="meal-btn" onclick="selectMeal(this, 'breakfast')">æ—©é¤</button>
        <button class="meal-btn" onclick="selectMeal(this, 'lunch')">åˆé¤</button>
        <button class="meal-btn" onclick="selectMeal(this, 'dinner')">æ™šé¤</button>
    </div>

    <div id="uploadSection" class="upload-section">
        <p>å·²é¸æ“‡ï¼š<span id="mealLabel" style="color:#28a745; font-weight:bold;"></span></p>
        
        <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none" onchange="processImage()">
        <button class="camera-btn" onclick="document.getElementById('fileInput').click()">ğŸ“· å•Ÿå‹•ç›¸æ©Ÿ</button>
        
        <img id="preview">
        <div id="status"></div>
        <button id="submitBtn" class="submit-btn" onclick="uploadData()">ğŸš€ ç¢ºèªä¸Šå‚³</button>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹æ›¿æ›é€™è£¡ â˜…â˜…â˜…
        const SUPABASE_URL = 'ä½ çš„_URL';
        const SUPABASE_KEY = 'ä½ çš„_sb_publishable_KEY';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentMeal = '';
        let compressedFile = null;
        let currentUserEmail = '';

        // 1. æª¢æŸ¥æ¬Šé™
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
            } else {
                currentUserEmail = session.user.email;
            }
        }
        init();

        // 2. é¸æ“‡é¤åˆ¥
        function selectMeal(btn, type) {
            document.querySelectorAll('.meal-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMeal = type;
            document.getElementById('mealLabel').innerText = (type==='breakfast'?'æ—©é¤':type==='lunch'?'åˆé¤':'æ™šé¤');
            document.getElementById('uploadSection').style.display = 'block';
            resetForm();
        }

        function resetForm() {
            compressedFile = null;
            document.getElementById('preview').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('status').innerText = '';
            document.getElementById('fileInput').value = '';
        }

        // 3. å£“ç¸®åœ–ç‰‡
        async function processImage() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            document.getElementById('status').innerText = 'â³ è™•ç†åœ–ç‰‡ä¸­...';
            
            try {
                // å£“ç¸®åˆ° 300KB ä»¥ä¸‹
                const options = { maxSizeMB: 0.3, maxWidthOrHeight: 1280, useWebWorker: true };
                compressedFile = await imageCompression(file, options);
                
                // é¡¯ç¤ºé è¦½
                document.getElementById('preview').src = URL.createObjectURL(compressedFile);
                document.getElementById('preview').style.display = 'block';
                document.getElementById('submitBtn').style.display = 'block';
                document.getElementById('status').innerText = '';
            } catch (err) {
                alert('åœ–ç‰‡è™•ç†å¤±æ•—');
            }
        }

        // 4. ä¸Šå‚³è³‡æ–™
        async function uploadData() {
            if (!compressedFile) return;
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = 'ä¸Šå‚³ä¸­...';

            try {
                // æª”åï¼šæ—¥æœŸ_é¤åˆ¥_äº‚æ•¸.jpg
                const dateStr = new Date().toISOString().split('T')[0];
                const fileName = `${dateStr}_${currentMeal}_${Date.now()}.jpg`;

                // A. ä¸Šå‚³åœ–ç‰‡åˆ° Storage
                const { error: uploadErr } = await supabase.storage.from('photos').upload(fileName, compressedFile);
                if (uploadErr) throw uploadErr;

                // B. å¯«å…¥è³‡æ–™åº«
                const { error: dbErr } = await supabase.from('meal_logs').insert([{
                    meal_date: dateStr,
                    meal_type: currentMeal,
                    image_path: fileName,
                    uploader_email: currentUserEmail
                }]);
                if (dbErr) throw dbErr;

                document.getElementById('status').innerHTML = '<span style="color:green">âœ… ä¸Šå‚³æˆåŠŸï¼</span>';
                setTimeout(() => { location.reload(); }, 2000);

            } catch (err) {
                console.error(err);
                document.getElementById('status').innerText = 'âŒ å¤±æ•—: ' + err.message;
                btn.disabled = false;
                btn.innerText = 'ğŸš€ ç¢ºèªä¸Šå‚³';
            }
        }
    </script>
</body>
</html> 